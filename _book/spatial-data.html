<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>3 Spatial Data | Applied Spatial Statistics for Geographers</title>
  <meta name="description" content="3 Spatial Data | Applied Spatial Statistics for Geographers" />
  <meta name="generator" content="bookdown 0.18 and GitBook 2.6.7" />

  <meta property="og:title" content="3 Spatial Data | Applied Spatial Statistics for Geographers" />
  <meta property="og:type" content="book" />
  
  
  
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="3 Spatial Data | Applied Spatial Statistics for Geographers" />
  
  
  

<meta name="author" content="James B. Elsner" />


<meta name="date" content="2020-05-11" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="grammars-for-data-and-graphs.html"/>
<link rel="next" href="making-maps.html"/>
<script src="libs/header-attrs-2.1/header-attrs.js"></script>
<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />









<script src="libs/htmlwidgets-1.5.1/htmlwidgets.js"></script>
<link href="libs/leaflet-1.3.1/leaflet.css" rel="stylesheet" />
<script src="libs/leaflet-1.3.1/leaflet.js"></script>
<link href="libs/leafletfix-1.0.0/leafletfix.css" rel="stylesheet" />
<script src="libs/Proj4Leaflet-1.0.1/proj4-compressed.js"></script>
<script src="libs/Proj4Leaflet-1.0.1/proj4leaflet.js"></script>
<link href="libs/rstudio_leaflet-1.3.1/rstudio_leaflet.css" rel="stylesheet" />
<script src="libs/leaflet-binding-2.0.3/leaflet.js"></script>
<script src="libs/leaflet-providers-1.9.0/leaflet-providers_1.9.0.js"></script>
<script src="libs/leaflet-providers-plugin-2.0.3/leaflet-providers-plugin.js"></script>
<script src="libs/Leaflet.Sync-0.0.5/L.Map.Sync.js"></script>
<link href="libs/HomeButton-0.0.1/home-button.css" rel="stylesheet" />
<script src="libs/HomeButton-0.0.1/home-button.js"></script>
<script src="libs/HomeButton-0.0.1/easy-button-src.min.js"></script>
<script src="libs/clipboard-0.0.1/setClipboardText.js"></script>
<link href="libs/PopupTable-0.0.1/popup.css" rel="stylesheet" />
<script src="libs/Tor_r-1/data_stars_Tor_r9268ce.txt"></script>
<script src="libs/joda-0.0.1/joda.js"></script>
<script src="libs/joda-0.0.1/addImageQuery-bindings.js"></script>
<script src="libs/plotly-binding-4.9.2.1/plotly.js"></script>
<script src="libs/typedarray-0.1/typedarray.min.js"></script>
<link href="libs/crosstalk-1.1.0.1/css/crosstalk.css" rel="stylesheet" />
<script src="libs/crosstalk-1.1.0.1/js/crosstalk.min.js"></script>
<link href="libs/plotly-htmlwidgets-css-1.52.2/plotly-htmlwidgets.css" rel="stylesheet" />
<script src="libs/plotly-main-1.52.2/plotly-latest.min.js"></script>


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Preface</a></li>
<li class="chapter" data-level="1" data-path="getting-started.html"><a href="getting-started.html"><i class="fa fa-check"></i><b>1</b> Getting Started</a>
<ul>
<li class="chapter" data-level="1.1" data-path="getting-started.html"><a href="getting-started.html#rstudios-integrated-development-environment-ide"><i class="fa fa-check"></i><b>1.1</b> RStudio’s integrated development environment (IDE)</a></li>
<li class="chapter" data-level="1.2" data-path="getting-started.html"><a href="getting-started.html#create-an-html-file"><i class="fa fa-check"></i><b>1.2</b> Create an HTML file</a></li>
<li class="chapter" data-level="1.3" data-path="getting-started.html"><a href="getting-started.html#basic-r"><i class="fa fa-check"></i><b>1.3</b> Basic R</a>
<ul>
<li class="chapter" data-level="1.3.1" data-path="getting-started.html"><a href="getting-started.html#functions"><i class="fa fa-check"></i><b>1.3.1</b> Functions</a></li>
<li class="chapter" data-level="1.3.2" data-path="getting-started.html"><a href="getting-started.html#data-vectors"><i class="fa fa-check"></i><b>1.3.2</b> Data vectors</a></li>
<li class="chapter" data-level="1.3.3" data-path="getting-started.html"><a href="getting-started.html#vector-types"><i class="fa fa-check"></i><b>1.3.3</b> Vector types</a></li>
<li class="chapter" data-level="1.3.4" data-path="getting-started.html"><a href="getting-started.html#structured-data"><i class="fa fa-check"></i><b>1.3.4</b> Structured data</a></li>
<li class="chapter" data-level="1.3.5" data-path="getting-started.html"><a href="getting-started.html#query-data"><i class="fa fa-check"></i><b>1.3.5</b> Query data</a></li>
</ul></li>
<li class="chapter" data-level="1.4" data-path="getting-started.html"><a href="getting-started.html#need-additional-help-try-swirl"><i class="fa fa-check"></i><b>1.4</b> Need additional help? Try swirl</a></li>
<li class="chapter" data-level="1.5" data-path="getting-started.html"><a href="getting-started.html#data-frames"><i class="fa fa-check"></i><b>1.5</b> Data Frames</a>
<ul>
<li class="chapter" data-level="1.5.1" data-path="getting-started.html"><a href="getting-started.html#another-example"><i class="fa fa-check"></i><b>1.5.1</b> Another example</a></li>
<li class="chapter" data-level="1.5.2" data-path="getting-started.html"><a href="getting-started.html#tornadoes-in-the-united-states"><i class="fa fa-check"></i><b>1.5.2</b> Tornadoes in the United States</a></li>
<li class="chapter" data-level="1.5.3" data-path="getting-started.html"><a href="getting-started.html#hurricanes-in-the-united-states"><i class="fa fa-check"></i><b>1.5.3</b> Hurricanes in the United States</a></li>
<li class="chapter" data-level="1.5.4" data-path="getting-started.html"><a href="getting-started.html#your-turn-precipitation-in-florida"><i class="fa fa-check"></i><b>1.5.4</b> Your turn: Precipitation in Florida</a></li>
<li class="chapter" data-level="1.5.5" data-path="getting-started.html"><a href="getting-started.html#more-practice-more-tornadoes"><i class="fa fa-check"></i><b>1.5.5</b> More practice: More tornadoes</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="2" data-path="grammars-for-data-and-graphs.html"><a href="grammars-for-data-and-graphs.html"><i class="fa fa-check"></i><b>2</b> Grammars for Data and Graphs</a>
<ul>
<li class="chapter" data-level="2.1" data-path="grammars-for-data-and-graphs.html"><a href="grammars-for-data-and-graphs.html#a-grammar-for-data"><i class="fa fa-check"></i><b>2.1</b> A Grammar for Data</a>
<ul>
<li class="chapter" data-level="2.1.1" data-path="grammars-for-data-and-graphs.html"><a href="grammars-for-data-and-graphs.html#pipes"><i class="fa fa-check"></i><b>2.1.1</b> Pipes</a></li>
<li class="chapter" data-level="2.1.2" data-path="grammars-for-data-and-graphs.html"><a href="grammars-for-data-and-graphs.html#tibbles"><i class="fa fa-check"></i><b>2.1.2</b> Tibbles</a></li>
<li class="chapter" data-level="2.1.3" data-path="grammars-for-data-and-graphs.html"><a href="grammars-for-data-and-graphs.html#select"><i class="fa fa-check"></i><b>2.1.3</b> Select</a></li>
<li class="chapter" data-level="2.1.4" data-path="grammars-for-data-and-graphs.html"><a href="grammars-for-data-and-graphs.html#filter"><i class="fa fa-check"></i><b>2.1.4</b> Filter</a></li>
<li class="chapter" data-level="2.1.5" data-path="grammars-for-data-and-graphs.html"><a href="grammars-for-data-and-graphs.html#arrange"><i class="fa fa-check"></i><b>2.1.5</b> Arrange</a></li>
<li class="chapter" data-level="2.1.6" data-path="grammars-for-data-and-graphs.html"><a href="grammars-for-data-and-graphs.html#mutate"><i class="fa fa-check"></i><b>2.1.6</b> Mutate</a></li>
<li class="chapter" data-level="2.1.7" data-path="grammars-for-data-and-graphs.html"><a href="grammars-for-data-and-graphs.html#summarize"><i class="fa fa-check"></i><b>2.1.7</b> Summarize</a></li>
<li class="chapter" data-level="2.1.8" data-path="grammars-for-data-and-graphs.html"><a href="grammars-for-data-and-graphs.html#group"><i class="fa fa-check"></i><b>2.1.8</b> Group</a></li>
<li class="chapter" data-level="2.1.9" data-path="grammars-for-data-and-graphs.html"><a href="grammars-for-data-and-graphs.html#give-it-a-try-florida-precipitation-httpmyweb.fsu.edujelsnertempdataflprecip.txt"><i class="fa fa-check"></i><b>2.1.9</b> Give it a try: Florida precipitation (<span>http://myweb.fsu.edu/jelsner/temp/data/FLprecip.txt</span>)</a></li>
<li class="chapter" data-level="2.1.10" data-path="grammars-for-data-and-graphs.html"><a href="grammars-for-data-and-graphs.html#another-example-us-tornadoes"><i class="fa fa-check"></i><b>2.1.10</b> Another example: US tornadoes</a></li>
<li class="chapter" data-level="2.1.11" data-path="grammars-for-data-and-graphs.html"><a href="grammars-for-data-and-graphs.html#filter-rows-with-filter"><i class="fa fa-check"></i><b>2.1.11</b> Filter rows with <code>filter()</code></a></li>
<li class="chapter" data-level="2.1.12" data-path="grammars-for-data-and-graphs.html"><a href="grammars-for-data-and-graphs.html#arrange-rows-with-arrange"><i class="fa fa-check"></i><b>2.1.12</b> Arrange rows with <code>arrange()</code></a></li>
<li class="chapter" data-level="2.1.13" data-path="grammars-for-data-and-graphs.html"><a href="grammars-for-data-and-graphs.html#pull-out-a-single-variable-with-pull"><i class="fa fa-check"></i><b>2.1.13</b> Pull out a single variable with <code>pull()</code></a></li>
<li class="chapter" data-level="2.1.14" data-path="grammars-for-data-and-graphs.html"><a href="grammars-for-data-and-graphs.html#summarize-values-with-summarise"><i class="fa fa-check"></i><b>2.1.14</b> Summarize values with <code>summarise()</code></a></li>
<li class="chapter" data-level="2.1.15" data-path="grammars-for-data-and-graphs.html"><a href="grammars-for-data-and-graphs.html#grouped-operations"><i class="fa fa-check"></i><b>2.1.15</b> Grouped operations</a></li>
</ul></li>
<li class="chapter" data-level="2.2" data-path="grammars-for-data-and-graphs.html"><a href="grammars-for-data-and-graphs.html#a-grammar-for-graphs"><i class="fa fa-check"></i><b>2.2</b> A Grammar for Graphs</a>
<ul>
<li class="chapter" data-level="2.2.1" data-path="grammars-for-data-and-graphs.html"><a href="grammars-for-data-and-graphs.html#principle-1-map-data-to-aesthetics"><i class="fa fa-check"></i><b>2.2.1</b> Principle 1: Map data to aesthetics</a></li>
<li class="chapter" data-level="2.2.2" data-path="grammars-for-data-and-graphs.html"><a href="grammars-for-data-and-graphs.html#principle-2-build-plots-in-layers"><i class="fa fa-check"></i><b>2.2.2</b> Principle 2: Build plots in layers</a></li>
<li class="chapter" data-level="2.2.3" data-path="grammars-for-data-and-graphs.html"><a href="grammars-for-data-and-graphs.html#principle-3-iteration"><i class="fa fa-check"></i><b>2.2.3</b> Principle 3: Iteration</a></li>
<li class="chapter" data-level="2.2.4" data-path="grammars-for-data-and-graphs.html"><a href="grammars-for-data-and-graphs.html#returning-to-the-tornado-data"><i class="fa fa-check"></i><b>2.2.4</b> Returning to the tornado data</a></li>
<li class="chapter" data-level="2.2.5" data-path="grammars-for-data-and-graphs.html"><a href="grammars-for-data-and-graphs.html#another-example-hot-days-in-tallahassee"><i class="fa fa-check"></i><b>2.2.5</b> Another example: Hot days in Tallahassee</a></li>
</ul></li>
<li class="chapter" data-level="2.3" data-path="grammars-for-data-and-graphs.html"><a href="grammars-for-data-and-graphs.html#problem-set-1"><i class="fa fa-check"></i><b>2.3</b> Problem Set 1</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="spatial-data.html"><a href="spatial-data.html"><i class="fa fa-check"></i><b>3</b> Spatial Data</a>
<ul>
<li class="chapter" data-level="3.1" data-path="spatial-data.html"><a href="spatial-data.html#spatial-vector-data-sp-package"><i class="fa fa-check"></i><b>3.1</b> Spatial Vector Data: <strong>sp</strong> Package</a>
<ul>
<li class="chapter" data-level="3.1.1" data-path="spatial-data.html"><a href="spatial-data.html#geocomputation-on-s4-spatial-data-frames"><i class="fa fa-check"></i><b>3.1.1</b> Geocomputation on S4 spatial data frames</a></li>
<li class="chapter" data-level="3.1.2" data-path="spatial-data.html"><a href="spatial-data.html#a-few-notes-about-coordinate-reference-systems"><i class="fa fa-check"></i><b>3.1.2</b> A few notes about coordinate reference systems</a></li>
<li class="chapter" data-level="3.1.3" data-path="spatial-data.html"><a href="spatial-data.html#creating-an-s4-object"><i class="fa fa-check"></i><b>3.1.3</b> Creating an S4 object</a></li>
<li class="chapter" data-level="3.1.4" data-path="spatial-data.html"><a href="spatial-data.html#the-spplot-method"><i class="fa fa-check"></i><b>3.1.4</b> The <code>spplot()</code> method</a></li>
</ul></li>
<li class="chapter" data-level="3.2" data-path="spatial-data.html"><a href="spatial-data.html#simple-features"><i class="fa fa-check"></i><b>3.2</b> Simple Features</a>
<ul>
<li class="chapter" data-level="3.2.1" data-path="spatial-data.html"><a href="spatial-data.html#simple-feature-geometry-sfg"><i class="fa fa-check"></i><b>3.2.1</b> Simple feature geometry (<code>sfg</code>)</a></li>
<li class="chapter" data-level="3.2.2" data-path="spatial-data.html"><a href="spatial-data.html#simple-feature-geometry-column"><i class="fa fa-check"></i><b>3.2.2</b> Simple feature geometry column</a></li>
<li class="chapter" data-level="3.2.3" data-path="spatial-data.html"><a href="spatial-data.html#simple-feature-objects"><i class="fa fa-check"></i><b>3.2.3</b> Simple feature objects</a></li>
<li class="chapter" data-level="3.2.4" data-path="spatial-data.html"><a href="spatial-data.html#your-turn"><i class="fa fa-check"></i><b>3.2.4</b> Your turn</a></li>
<li class="chapter" data-level="3.2.5" data-path="spatial-data.html"><a href="spatial-data.html#why-simple-features"><i class="fa fa-check"></i><b>3.2.5</b> Why simple features?</a></li>
</ul></li>
<li class="chapter" data-level="3.3" data-path="spatial-data.html"><a href="spatial-data.html#geocomputation-on-simple-features"><i class="fa fa-check"></i><b>3.3</b> Geocomputation on simple features</a>
<ul>
<li class="chapter" data-level="3.3.1" data-path="spatial-data.html"><a href="spatial-data.html#attribute-manipulation"><i class="fa fa-check"></i><b>3.3.1</b> Attribute manipulation</a></li>
<li class="chapter" data-level="3.3.2" data-path="spatial-data.html"><a href="spatial-data.html#areal-weighted-interpolation"><i class="fa fa-check"></i><b>3.3.2</b> Areal weighted interpolation</a></li>
</ul></li>
<li class="chapter" data-level="3.4" data-path="spatial-data.html"><a href="spatial-data.html#spatial-aggregation"><i class="fa fa-check"></i><b>3.4</b> Spatial aggregation</a></li>
<li class="chapter" data-level="3.5" data-path="spatial-data.html"><a href="spatial-data.html#expectations-for-your-final-project."><i class="fa fa-check"></i><b>3.5</b> Expectations for your final project.</a>
<ul>
<li class="chapter" data-level="3.5.1" data-path="spatial-data.html"><a href="spatial-data.html#review-state-u.s.-boundaries-as-simple-feature-data-frames"><i class="fa fa-check"></i><b>3.5.1</b> Review: State (U.S.) boundaries as simple feature data frames</a></li>
</ul></li>
<li class="chapter" data-level="3.6" data-path="spatial-data.html"><a href="spatial-data.html#working-with-rasters"><i class="fa fa-check"></i><b>3.6</b> Working with Rasters</a>
<ul>
<li class="chapter" data-level="3.6.1" data-path="spatial-data.html"><a href="spatial-data.html#creating-raster-objects"><i class="fa fa-check"></i><b>3.6.1</b> Creating raster objects</a></li>
<li class="chapter" data-level="3.6.2" data-path="spatial-data.html"><a href="spatial-data.html#from-a-data-frame"><i class="fa fa-check"></i><b>3.6.2</b> From a data frame</a></li>
<li class="chapter" data-level="3.6.3" data-path="spatial-data.html"><a href="spatial-data.html#raster-manipulations"><i class="fa fa-check"></i><b>3.6.3</b> Raster manipulations</a></li>
<li class="chapter" data-level="3.6.4" data-path="spatial-data.html"><a href="spatial-data.html#raster-algebra"><i class="fa fa-check"></i><b>3.6.4</b> Raster algebra</a></li>
<li class="chapter" data-level="3.6.5" data-path="spatial-data.html"><a href="spatial-data.html#example-aggregate-tornado-genesis-locations-to-a-raster-layer-and-then-compute-local-clustering"><i class="fa fa-check"></i><b>3.6.5</b> Example: Aggregate tornado genesis locations to a raster layer and then compute local clustering</a></li>
<li class="chapter" data-level="3.6.6" data-path="spatial-data.html"><a href="spatial-data.html#problem-set-2"><i class="fa fa-check"></i><b>3.6.6</b> Problem Set #2</a></li>
<li class="chapter" data-level="3.6.7" data-path="spatial-data.html"><a href="spatial-data.html#geocomputation-functions-on-rasters"><i class="fa fa-check"></i><b>3.6.7</b> Geocomputation functions on rasters</a></li>
<li class="chapter" data-level="3.6.8" data-path="spatial-data.html"><a href="spatial-data.html#vector-to-raster-conversion"><i class="fa fa-check"></i><b>3.6.8</b> Vector to raster conversion</a></li>
<li class="chapter" data-level="3.6.9" data-path="spatial-data.html"><a href="spatial-data.html#focal-neighborhood-functions"><i class="fa fa-check"></i><b>3.6.9</b> Focal (neighborhood) functions</a></li>
<li class="chapter" data-level="3.6.10" data-path="spatial-data.html"><a href="spatial-data.html#summary-functions"><i class="fa fa-check"></i><b>3.6.10</b> Summary functions</a></li>
<li class="chapter" data-level="3.6.11" data-path="spatial-data.html"><a href="spatial-data.html#convert-a-raster-to-a-spatial-vector-object"><i class="fa fa-check"></i><b>3.6.11</b> Convert a raster to a spatial vector object</a></li>
<li class="chapter" data-level="3.6.12" data-path="spatial-data.html"><a href="spatial-data.html#example-environmental-data-related-to-tornadoes"><i class="fa fa-check"></i><b>3.6.12</b> Example: Environmental data related to tornadoes</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="4" data-path="making-maps.html"><a href="making-maps.html"><i class="fa fa-check"></i><b>4</b> Making Maps</a>
<ul>
<li class="chapter" data-level="4.1" data-path="making-maps.html"><a href="making-maps.html#maps-with-tmap"><i class="fa fa-check"></i><b>4.1</b> Maps with tmap</a>
<ul>
<li class="chapter" data-level="4.1.1" data-path="making-maps.html"><a href="making-maps.html#example-1-what-state-contains-the-geographic-centroid-of-tornado-activity"><i class="fa fa-check"></i><b>4.1.1</b> Example 1: What state contains the geographic centroid of tornado activity?</a></li>
<li class="chapter" data-level="4.1.2" data-path="making-maps.html"><a href="making-maps.html#example-2-state-level-tornado-rates"><i class="fa fa-check"></i><b>4.1.2</b> Example 2: State-level tornado rates</a></li>
<li class="chapter" data-level="4.1.3" data-path="making-maps.html"><a href="making-maps.html#map-layout-facets-and-inserts"><i class="fa fa-check"></i><b>4.1.3</b> Map layout, facets, and inserts</a></li>
<li class="chapter" data-level="4.1.4" data-path="making-maps.html"><a href="making-maps.html#example-3-tornado-locations-by-month"><i class="fa fa-check"></i><b>4.1.4</b> Example 3: Tornado locations by month</a></li>
<li class="chapter" data-level="4.1.5" data-path="making-maps.html"><a href="making-maps.html#inset-map"><i class="fa fa-check"></i><b>4.1.5</b> Inset map</a></li>
<li class="chapter" data-level="4.1.6" data-path="making-maps.html"><a href="making-maps.html#turn-a-static-map-into-an-interactive-map"><i class="fa fa-check"></i><b>4.1.6</b> Turn a static map into an interactive map</a></li>
<li class="chapter" data-level="4.1.7" data-path="making-maps.html"><a href="making-maps.html#example-4-tornado-occurrences-on-a-grid"><i class="fa fa-check"></i><b>4.1.7</b> Example 4: Tornado occurrences on a grid</a></li>
</ul></li>
<li class="chapter" data-level="4.2" data-path="making-maps.html"><a href="making-maps.html#maps-with-ggplot"><i class="fa fa-check"></i><b>4.2</b> Maps with ggplot</a></li>
<li class="chapter" data-level="4.3" data-path="making-maps.html"><a href="making-maps.html#cartograms"><i class="fa fa-check"></i><b>4.3</b> Cartograms</a></li>
<li class="chapter" data-level="4.4" data-path="making-maps.html"><a href="making-maps.html#coordinate-systems"><i class="fa fa-check"></i><b>4.4</b> Coordinate systems</a>
<ul>
<li class="chapter" data-level="4.4.1" data-path="making-maps.html"><a href="making-maps.html#projected-coordinate-systems"><i class="fa fa-check"></i><b>4.4.1</b> Projected coordinate systems</a></li>
<li class="chapter" data-level="4.4.2" data-path="making-maps.html"><a href="making-maps.html#crss-in-r"><i class="fa fa-check"></i><b>4.4.2</b> CRSs in R</a></li>
<li class="chapter" data-level="4.4.3" data-path="making-maps.html"><a href="making-maps.html#units"><i class="fa fa-check"></i><b>4.4.3</b> Units</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="5" data-path="analyzing-and-modeling-spatial-data-in-areal-units.html"><a href="analyzing-and-modeling-spatial-data-in-areal-units.html"><i class="fa fa-check"></i><b>5</b> Analyzing and Modeling Spatial Data in Areal Units</a>
<ul>
<li class="chapter" data-level="5.1" data-path="analyzing-and-modeling-spatial-data-in-areal-units.html"><a href="analyzing-and-modeling-spatial-data-in-areal-units.html#quantifying-spatial-autocorrelation"><i class="fa fa-check"></i><b>5.1</b> Quantifying spatial autocorrelation</a>
<ul>
<li class="chapter" data-level="5.1.1" data-path="analyzing-and-modeling-spatial-data-in-areal-units.html"><a href="analyzing-and-modeling-spatial-data-in-areal-units.html#spatial-autocorrelation"><i class="fa fa-check"></i><b>5.1.1</b> Spatial autocorrelation</a></li>
<li class="chapter" data-level="5.1.2" data-path="analyzing-and-modeling-spatial-data-in-areal-units.html"><a href="analyzing-and-modeling-spatial-data-in-areal-units.html#quantifying-spatial-autocorrelation-1"><i class="fa fa-check"></i><b>5.1.2</b> Quantifying spatial autocorrelation</a></li>
<li class="chapter" data-level="5.1.3" data-path="analyzing-and-modeling-spatial-data-in-areal-units.html"><a href="analyzing-and-modeling-spatial-data-in-areal-units.html#an-example-columbus-ohio-crime"><i class="fa fa-check"></i><b>5.1.3</b> An example: Columbus, Ohio crime</a></li>
<li class="chapter" data-level="5.1.4" data-path="analyzing-and-modeling-spatial-data-in-areal-units.html"><a href="analyzing-and-modeling-spatial-data-in-areal-units.html#list-of-neighbors"><i class="fa fa-check"></i><b>5.1.4</b> List of neighbors</a></li>
<li class="chapter" data-level="5.1.5" data-path="analyzing-and-modeling-spatial-data-in-areal-units.html"><a href="analyzing-and-modeling-spatial-data-in-areal-units.html#weights-matrix"><i class="fa fa-check"></i><b>5.1.5</b> Weights matrix</a></li>
<li class="chapter" data-level="5.1.6" data-path="analyzing-and-modeling-spatial-data-in-areal-units.html"><a href="analyzing-and-modeling-spatial-data-in-areal-units.html#morans-i"><i class="fa fa-check"></i><b>5.1.6</b> Moran’s I</a></li>
<li class="chapter" data-level="5.1.7" data-path="analyzing-and-modeling-spatial-data-in-areal-units.html"><a href="analyzing-and-modeling-spatial-data-in-areal-units.html#spatial-lag"><i class="fa fa-check"></i><b>5.1.7</b> Spatial lag</a></li>
</ul></li>
<li class="chapter" data-level="5.2" data-path="analyzing-and-modeling-spatial-data-in-areal-units.html"><a href="analyzing-and-modeling-spatial-data-in-areal-units.html#statistical-significance-of-spatial-autocorrelation"><i class="fa fa-check"></i><b>5.2</b> Statistical significance of spatial autocorrelation</a>
<ul>
<li class="chapter" data-level="5.2.1" data-path="analyzing-and-modeling-spatial-data-in-areal-units.html"><a href="analyzing-and-modeling-spatial-data-in-areal-units.html#monte-carlo-approach-to-inference"><i class="fa fa-check"></i><b>5.2.1</b> Monte Carlo approach to inference</a></li>
<li class="chapter" data-level="5.2.2" data-path="analyzing-and-modeling-spatial-data-in-areal-units.html"><a href="analyzing-and-modeling-spatial-data-in-areal-units.html#spatial-autocorrelation-in-model-residuals"><i class="fa fa-check"></i><b>5.2.2</b> Spatial autocorrelation in model residuals</a></li>
<li class="chapter" data-level="5.2.3" data-path="analyzing-and-modeling-spatial-data-in-areal-units.html"><a href="analyzing-and-modeling-spatial-data-in-areal-units.html#challenge"><i class="fa fa-check"></i><b>5.2.3</b> Challenge</a></li>
<li class="chapter" data-level="5.2.4" data-path="analyzing-and-modeling-spatial-data-in-areal-units.html"><a href="analyzing-and-modeling-spatial-data-in-areal-units.html#percent-of-whites-in-mississippi-counties"><i class="fa fa-check"></i><b>5.2.4</b> Percent of whites in Mississippi counties</a></li>
<li class="chapter" data-level="5.2.5" data-path="analyzing-and-modeling-spatial-data-in-areal-units.html"><a href="analyzing-and-modeling-spatial-data-in-areal-units.html#bivariate-spatial-autocorrelation"><i class="fa fa-check"></i><b>5.2.5</b> Bivariate spatial autocorrelation</a></li>
</ul></li>
<li class="chapter" data-level="5.3" data-path="analyzing-and-modeling-spatial-data-in-areal-units.html"><a href="analyzing-and-modeling-spatial-data-in-areal-units.html#local-indicators-of-spatial-autocorrelation-lisa"><i class="fa fa-check"></i><b>5.3</b> Local indicators of spatial autocorrelation (LISA)</a>
<ul>
<li class="chapter" data-level="5.3.1" data-path="analyzing-and-modeling-spatial-data-in-areal-units.html"><a href="analyzing-and-modeling-spatial-data-in-areal-units.html#spatial-autocorrelation-in-model-residuals-1"><i class="fa fa-check"></i><b>5.3.1</b> Spatial autocorrelation in model residuals</a></li>
</ul></li>
<li class="chapter" data-level="5.4" data-path="analyzing-and-modeling-spatial-data-in-areal-units.html"><a href="analyzing-and-modeling-spatial-data-in-areal-units.html#geographic-regression"><i class="fa fa-check"></i><b>5.4</b> Geographic regression</a>
<ul>
<li class="chapter" data-level="5.4.1" data-path="analyzing-and-modeling-spatial-data-in-areal-units.html"><a href="analyzing-and-modeling-spatial-data-in-areal-units.html#example-southern-homicides"><i class="fa fa-check"></i><b>5.4.1</b> Example: Southern homicides</a></li>
</ul></li>
<li class="chapter" data-level="5.5" data-path="analyzing-and-modeling-spatial-data-in-areal-units.html"><a href="analyzing-and-modeling-spatial-data-in-areal-units.html#spatial-regression"><i class="fa fa-check"></i><b>5.5</b> Spatial regression</a>
<ul>
<li class="chapter" data-level="5.5.1" data-path="analyzing-and-modeling-spatial-data-in-areal-units.html"><a href="analyzing-and-modeling-spatial-data-in-areal-units.html#spatial-lag-model-and-spatial-error-models"><i class="fa fa-check"></i><b>5.5.1</b> Spatial lag model and spatial error models</a></li>
<li class="chapter" data-level="5.5.2" data-path="analyzing-and-modeling-spatial-data-in-areal-units.html"><a href="analyzing-and-modeling-spatial-data-in-areal-units.html#lagrange-multiplier-test-for-the-type-of-spatial-autocorrelation"><i class="fa fa-check"></i><b>5.5.2</b> Lagrange multiplier test for the type of spatial autocorrelation</a></li>
<li class="chapter" data-level="5.5.3" data-path="analyzing-and-modeling-spatial-data-in-areal-units.html"><a href="analyzing-and-modeling-spatial-data-in-areal-units.html#model-fitting"><i class="fa fa-check"></i><b>5.5.3</b> Model fitting</a></li>
<li class="chapter" data-level="5.5.4" data-path="analyzing-and-modeling-spatial-data-in-areal-units.html"><a href="analyzing-and-modeling-spatial-data-in-areal-units.html#predictions"><i class="fa fa-check"></i><b>5.5.4</b> Predictions</a></li>
<li class="chapter" data-level="5.5.5" data-path="analyzing-and-modeling-spatial-data-in-areal-units.html"><a href="analyzing-and-modeling-spatial-data-in-areal-units.html#example-california-house-prices"><i class="fa fa-check"></i><b>5.5.5</b> Example: California house prices</a></li>
</ul></li>
<li class="chapter" data-level="5.6" data-path="analyzing-and-modeling-spatial-data-in-areal-units.html"><a href="analyzing-and-modeling-spatial-data-in-areal-units.html#bayesian-spatial-regression-using-inla"><i class="fa fa-check"></i><b>5.6</b> Bayesian spatial regression using INLA</a>
<ul>
<li class="chapter" data-level="5.6.1" data-path="analyzing-and-modeling-spatial-data-in-areal-units.html"><a href="analyzing-and-modeling-spatial-data-in-areal-units.html#the-inla-package"><i class="fa fa-check"></i><b>5.6.1</b> The {INLA} package</a></li>
<li class="chapter" data-level="5.6.2" data-path="analyzing-and-modeling-spatial-data-in-areal-units.html"><a href="analyzing-and-modeling-spatial-data-in-areal-units.html#example-california-house-prices-1"><i class="fa fa-check"></i><b>5.6.2</b> Example: California house prices</a></li>
<li class="chapter" data-level="5.6.3" data-path="analyzing-and-modeling-spatial-data-in-areal-units.html"><a href="analyzing-and-modeling-spatial-data-in-areal-units.html#bayesian-spatial-regression-using-stan"><i class="fa fa-check"></i><b>5.6.3</b> Bayesian spatial regression using Stan</a></li>
</ul></li>
<li class="chapter" data-level="5.7" data-path="analyzing-and-modeling-spatial-data-in-areal-units.html"><a href="analyzing-and-modeling-spatial-data-in-areal-units.html#problem-set-3"><i class="fa fa-check"></i><b>5.7</b> Problem Set #3</a></li>
<li class="chapter" data-level="5.8" data-path="analyzing-and-modeling-spatial-data-in-areal-units.html"><a href="analyzing-and-modeling-spatial-data-in-areal-units.html#challenge-problem-home-foreclosures-in-chicago"><i class="fa fa-check"></i><b>5.8</b> Challenge problem: Home foreclosures in Chicago</a></li>
</ul></li>
</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Applied Spatial Statistics for Geographers</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="spatial-data" class="section level1" number="3">
<h1><span class="header-section-number">3</span> Spatial Data</h1>
<p><strong>“Feeling a little uncomfortable with your skills is a sign of learning, and continuous learning is what the tech industry thrives on!”</strong> — Vanessa Hurst</p>
<p>Spatial data in R.</p>
<div id="spatial-vector-data-sp-package" class="section level2" number="3.1">
<h2><span class="header-section-number">3.1</span> Spatial Vector Data: <strong>sp</strong> Package</h2>
<p>The <em>vector data model</em> represents the world using points, lines and polygons. These objects have discrete, well-defined borders, meaning that these datasets usually have a high level of precision (Of course precision does not imply accuracy).</p>
<p>The <em>raster data model</em> divides geographic space into a grid of cells of constant size (resolution). The raster model is used for representing continuous phenomena such as elevation or rainfall. Rasters aggregate specific features to a given resolution, meaning that they are consistent over space and scalable (many worldwide raster datasets are available). The downside is that the smallest features are blurred or lost.</p>
<p>Choosing between vector or raster models depends on your application:</p>
<ul>
<li>Vector data tends to dominate the social sciences because human settlements and boundaries have discrete borders.</li>
<li>Raster data (e.g., remotely sensed imagery) tends to dominate the environmental sciences because environmental conditions are typically continuous.</li>
</ul>
<p>There is overlap. Geographers, ecologists, demographers often use vector and raster data.</p>
<p>In this class (and in the R spatial ecosystem) we use functions from the <strong>sp</strong> and <strong>sf</strong> packages to work with vector data and functions in the <strong>raster</strong> packages to work with raster datasets.</p>
<p>R’s spatial ecosystem continues to evolve. Most changes build on what has already been done. Occasionally there is a significant change that builds from scratch. The <strong>sf</strong> package is a significant change.</p>
<p>Install and load the packages.</p>
<div class="sourceCode" id="cb286"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb286-1"><a href="spatial-data.html#cb286-1"></a><span class="kw">library</span>(sp)</span>
<span id="cb286-2"><a href="spatial-data.html#cb286-2"></a><span class="kw">library</span>(sf)</span></code></pre></div>
<p>Functions in these packages link to software libraries outside of R. For example GDAL is a set of libraries for reading and writing geospatial data and PROJ is a set of libraries for performing conversions between cartographic projections.</p>
<p>The <strong>sp</strong> package has methods for working with ‘vector’ spatial data. Note: ‘vector’ is in quotes because this is different than vector as a data type.</p>
<p>Several of the packages for analyzing and modeling spatial data we will use this semester depend on <strong>sp</strong>. Check out <a href="http://cran.r-project.org/web/packages/sp/index.html">sp</a> and note the number of packages that depend on <strong>sp</strong> (reverse depends and reverse imports).</p>
<p>Spatial objects from the <strong>sp</strong> package fall into two types: 1) spatial-only information (the topology). These include <code>SpatialPoints</code>, <code>SpatialLines</code>, <code>SpatialPolygons</code>, etc, and 2) extensions to these cases where attribute information is available and stored in a data frame. These include <code>SpatialPointsDataFrame</code>, <code>SpatialLinesDataFrame</code>, etc.</p>
<p>As an example, we download the shapefile from the SPC (if it’s not already available in your working directory) and use <code>st_read()</code> from the <strong>sf</strong> package keeping only tornadoes since 2007. Note that we use the <code>filter()</code> function and the piping operator from the <strong>dplyr</strong> package as part of the <strong>tidyverse</strong> group of packages.</p>
<div class="sourceCode" id="cb287"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb287-1"><a href="spatial-data.html#cb287-1"></a><span class="kw">library</span>(tidyverse)</span>
<span id="cb287-2"><a href="spatial-data.html#cb287-2"></a></span>
<span id="cb287-3"><a href="spatial-data.html#cb287-3"></a>sfdf &lt;-<span class="st"> </span><span class="kw">st_read</span>(<span class="dt">dsn =</span> <span class="st">&quot;1950-2018-torn-aspath&quot;</span>) <span class="op">%&gt;%</span></span>
<span id="cb287-4"><a href="spatial-data.html#cb287-4"></a><span class="st">  </span><span class="kw">filter</span>(yr <span class="op">&gt;=</span><span class="st"> </span><span class="dv">2007</span>)</span></code></pre></div>
<pre><code>## Reading layer `1950-2018-torn-aspath&#39; from data source `/Users/jelsner/Desktop/Projects/ASSFG-Book/1950-2018-torn-aspath&#39; using driver `ESRI Shapefile&#39;
## Simple feature collection with 63645 features and 22 fields
## geometry type:  LINESTRING
## dimension:      XY
## bbox:           xmin: -163.53 ymin: 18.13 xmax: -64.9 ymax: 61.02
## CRS:            4326</code></pre>
<div class="sourceCode" id="cb289"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb289-1"><a href="spatial-data.html#cb289-1"></a><span class="kw">class</span>(sfdf)</span></code></pre></div>
<pre><code>## [1] &quot;sf&quot;         &quot;data.frame&quot;</code></pre>
<p>The object <code>sfdf</code> is of class <code>sf</code> and <code>data.frame</code> (simple feature data frame).</p>
<p>Note: <code>st_read()</code> is the same as <code>read_sf()</code> that we used in the last two lessons except the attribute table is a data frame rather than a tabled data frame (tibble).</p>
<p>To convert <code>sfdf</code> with class <code>sf</code> as an S3 object to an S4 spatial object use <code>as(sfdf, "Spatial")</code>.</p>
<div class="sourceCode" id="cb291"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb291-1"><a href="spatial-data.html#cb291-1"></a>sldf &lt;-<span class="st"> </span><span class="kw">as</span>(sfdf, <span class="st">&quot;Spatial&quot;</span>)</span></code></pre></div>
<p>The spatial object <code>sldf</code> is a S4 spatial object of class <code>SpatialLinesDataFrame</code>. Information contained in S4 spatial objects is accessed through a slot name. For example, <code>x@coords</code> contains the coordinates of a S4 spatial object <code>x</code> and <code>x@data</code> contains the attribute table as a data frame.</p>
<div class="sourceCode" id="cb292"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb292-1"><a href="spatial-data.html#cb292-1"></a><span class="kw">glimpse</span>(sldf<span class="op">@</span>data)</span></code></pre></div>
<pre><code>## Rows: 14,349
## Columns: 22
## $ om    &lt;dbl&gt; 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, …
## $ yr    &lt;dbl&gt; 2007, 2007, 2007, 2007, 2007, 2007, 2007, 2007, 2007, 2007, 200…
## $ mo    &lt;dbl&gt; 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, …
## $ dy    &lt;dbl&gt; 4, 4, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 7, 7, 7, 7, 12, 13…
## $ date  &lt;chr&gt; &quot;2007-01-04&quot;, &quot;2007-01-04&quot;, &quot;2007-01-05&quot;, &quot;2007-01-05&quot;, &quot;2007-0…
## $ time  &lt;chr&gt; &quot;15:45:00&quot;, &quot;16:35:00&quot;, &quot;00:27:00&quot;, &quot;00:40:00&quot;, &quot;00:57:00&quot;, &quot;01…
## $ tz    &lt;dbl&gt; 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, …
## $ st    &lt;chr&gt; &quot;LA&quot;, &quot;LA&quot;, &quot;MS&quot;, &quot;MS&quot;, &quot;MS&quot;, &quot;MS&quot;, &quot;MS&quot;, &quot;MS&quot;, &quot;MS&quot;, &quot;GA&quot;, &quot;GA…
## $ stf   &lt;dbl&gt; 22, 22, 28, 28, 28, 28, 28, 28, 28, 13, 13, 45, 45, 37, 13, 1, …
## $ stn   &lt;dbl&gt; 1, 2, 1, 2, 3, 4, 5, 6, 7, 1, 2, 1, 2, 1, 3, 1, 4, 2, 3, 1, 2, …
## $ mag   &lt;dbl&gt; 1, 1, 1, 0, 1, 1, 2, 2, 1, 1, 0, 1, 0, 0, 0, 1, 2, 0, 1, 0, 1, …
## $ inj   &lt;dbl&gt; 15, 0, 0, 0, 0, 0, 0, 9, 0, 0, 0, 15, 0, 0, 0, 0, 0, 0, 0, 0, 0…
## $ fat   &lt;dbl&gt; 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, …
## $ loss  &lt;dbl&gt; 1.500, 0.500, 0.075, 0.050, 2.200, 0.200, 0.150, 0.600, 0.020, …
## $ closs &lt;dbl&gt; 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, …
## $ slat  &lt;dbl&gt; 29.92, 30.60, 31.73, 30.85, 32.54, 32.62, 32.72, 32.61, 33.00, …
## $ slon  &lt;dbl&gt; -91.80, -91.45, -89.29, -89.13, -89.27, -89.23, -89.03, -88.70,…
## $ elat  &lt;dbl&gt; 30.05, 30.62, 31.74, 30.85, 32.59, 32.65, 32.73, 32.65, 33.01, …
## $ elon  &lt;dbl&gt; -91.73, -91.47, -89.28, -89.13, -89.25, -89.20, -89.01, -88.69,…
## $ len   &lt;dbl&gt; 15.07, 1.83, 1.20, 0.36, 5.30, 3.00, 1.40, 2.24, 3.70, 5.39, 1.…
## $ wid   &lt;dbl&gt; 100, 75, 100, 50, 300, 400, 150, 250, 300, 200, 200, 20, 50, 20…
## $ fc    &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, …</code></pre>
<p>The <code>@</code> symbol is similar to the <code>$</code> symbol for regular data frames.</p>
<p>Slots in a <code>SpatialLinesDataFrame</code> include <code>data</code>, <code>lines</code>, <code>bbox</code>, and <code>proj4string</code>.</p>
<div class="sourceCode" id="cb294"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb294-1"><a href="spatial-data.html#cb294-1"></a><span class="kw">slotNames</span>(sldf)</span></code></pre></div>
<pre><code>## [1] &quot;data&quot;        &quot;lines&quot;       &quot;bbox&quot;        &quot;proj4string&quot;</code></pre>
<p>Selecting, retrieving, or replacing attributes in S4 spatial data frames is done with methods in <strong>base</strong> R. For example <code>[]</code> is used to select rows and/or columns. To select <code>mag</code> of the 7th tornado type</p>
<div class="sourceCode" id="cb296"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb296-1"><a href="spatial-data.html#cb296-1"></a>sldf<span class="op">$</span>mag[<span class="dv">7</span>]</span></code></pre></div>
<pre><code>## [1] 2</code></pre>
<p>Other methods include: <code>plot</code>, <code>summary</code>,<code>dim</code> and <code>names</code> (operate on the data slot), <code>as.data.frame</code>, <code>as.matrix</code> and <code>image</code> (for gridded spatial data), and <code>length</code> (number of features).</p>
<p>CAUTION: we can’t use the <strong>dplyr</strong> verbs on S4 data frames. To convert from an S4 spatial data frame to a simple feature data frame, use <code>st_as_sf()</code>.</p>
<div id="geocomputation-on-s4-spatial-data-frames" class="section level3" number="3.1.1">
<h3><span class="header-section-number">3.1.1</span> Geocomputation on S4 spatial data frames</h3>
<p>Geocomputation refers to math performed on geographic data. The interface to the geometry engine-open source (GEOS) is through the <strong>rgeos</strong> package.</p>
<div class="sourceCode" id="cb298"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb298-1"><a href="spatial-data.html#cb298-1"></a><span class="kw">library</span>(rgeos)</span></code></pre></div>
<pre><code>## rgeos version: 0.5-2, (SVN revision 621)
##  GEOS runtime version: 3.7.2-CAPI-1.11.2 
##  Linking to sp version: 1.4-1 
##  Polygon checking: TRUE</code></pre>
<p>When possible we will do our geocomputations on simple feature data frames (S3). However, sometimes it is more convenient to perform geocomputations on S4 data frames. Also much of the current R code you might encounter doing GIS will be written with S4 objects.</p>
<p>Geocomputation should not be done on spatial objects with geographic coordinates (lat/lon). To see if the S4 spatial data frame is projected type</p>
<div class="sourceCode" id="cb300"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb300-1"><a href="spatial-data.html#cb300-1"></a><span class="kw">is.projected</span>(sldf)</span></code></pre></div>
<pre><code>## [1] FALSE</code></pre>
<p>To see the coordinate reference system (CRS) of the spatial data frame type</p>
<div class="sourceCode" id="cb302"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb302-1"><a href="spatial-data.html#cb302-1"></a>sldf<span class="op">@</span>proj4string</span></code></pre></div>
<pre><code>## CRS arguments:
##  +proj=longlat +datum=WGS84 +no_defs +ellps=WGS84 +towgs84=0,0,0</code></pre>
<p>The CRS arguments include the projection (<code>+proj</code>), the datum (<code>+datum</code>), and the ellipsoid (<code>+ellps</code>). Here we see the projection is <code>longlat</code> indicating that this is a geographic CRS (not projected).</p>
<p>To create a projected <code>SpatialLinesDataFrame</code> we use the <code>spTransform()</code> function. The first argument is the original spatial data frame and the second argument is the coordinate reference system as a character string.</p>
<div class="sourceCode" id="cb304"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb304-1"><a href="spatial-data.html#cb304-1"></a>sldfP &lt;-<span class="st"> </span><span class="kw">spTransform</span>(sldf, </span>
<span id="cb304-2"><a href="spatial-data.html#cb304-2"></a>                     <span class="dt">CRS =</span> <span class="kw">CRS</span>(<span class="st">&quot;+proj=merc +ellps=GRS80 +units=m&quot;</span>))</span>
<span id="cb304-3"><a href="spatial-data.html#cb304-3"></a><span class="kw">is.projected</span>(sldfP)</span></code></pre></div>
<pre><code>## [1] TRUE</code></pre>
<p>The CRS character string is in the open GIS standard format. It includes the projection type (here Mercator), the ellipsoid shape (here GRS80) and the spatial units (here meters).</p>
<div class="sourceCode" id="cb306"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb306-1"><a href="spatial-data.html#cb306-1"></a>sldfP<span class="op">@</span>proj4string</span></code></pre></div>
<pre><code>## CRS arguments: +proj=merc +ellps=GRS80 +units=m</code></pre>
<p>We now have two copies of our <code>SpatialLinesDataFrame</code> object (unprojected <code>sldf</code> and projected <code>sldfP</code>).</p>
<p>We perform geocomputation on the projected spatial data frame using functions from the <strong>rgeos</strong> package.</p>
<p>Computations can be done across all features (e.g., all tornado reports together) or feature by feature (<code>byid = TRUE</code>). For example, to the <code>gEnvelope()</code> function computes the rectangular bounding box surrounding all the features.</p>
<div class="sourceCode" id="cb308"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb308-1"><a href="spatial-data.html#cb308-1"></a><span class="kw">library</span>(rgeos)</span>
<span id="cb308-2"><a href="spatial-data.html#cb308-2"></a></span>
<span id="cb308-3"><a href="spatial-data.html#cb308-3"></a>box &lt;-<span class="st"> </span><span class="kw">gEnvelope</span>(sldfP)</span>
<span id="cb308-4"><a href="spatial-data.html#cb308-4"></a><span class="kw">class</span>(box)</span></code></pre></div>
<pre><code>## [1] &quot;SpatialPolygons&quot;
## attr(,&quot;package&quot;)
## [1] &quot;sp&quot;</code></pre>
<p>The assigned object <code>box</code> is of class <code>SpatialPolygons</code>. It contains a single polygon rectangle. The <code>byid = FALSE</code> is the default. There are no attributes.</p>
<p>Plot the box and the tornadoes using <strong>base</strong> R.</p>
<div class="sourceCode" id="cb310"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb310-1"><a href="spatial-data.html#cb310-1"></a><span class="kw">plot</span>(box)</span>
<span id="cb310-2"><a href="spatial-data.html#cb310-2"></a><span class="kw">plot</span>(sldfP, <span class="dt">add =</span> <span class="ot">TRUE</span>)</span></code></pre></div>
<p><img src="assfg-book_files/figure-html/unnamed-chunk-140-1.png" width="672" /></p>
<p>Note that the <code>plot()</code> method applied to an S4 spatial object plots the geometries without the attributes.</p>
<p>Another example: Consider the ESRI shapefile containing police expenditure data from Mississippi. The data are on my Web site and are downloaded and imported as follows.</p>
<div class="sourceCode" id="cb311"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb311-1"><a href="spatial-data.html#cb311-1"></a><span class="kw">download.file</span>(<span class="st">&quot;http://myweb.fsu.edu/jelsner/temp/data/police.zip&quot;</span>,</span>
<span id="cb311-2"><a href="spatial-data.html#cb311-2"></a>              <span class="st">&quot;police.zip&quot;</span>)</span>
<span id="cb311-3"><a href="spatial-data.html#cb311-3"></a><span class="kw">unzip</span>(<span class="st">&quot;police.zip&quot;</span>)</span>
<span id="cb311-4"><a href="spatial-data.html#cb311-4"></a></span>
<span id="cb311-5"><a href="spatial-data.html#cb311-5"></a>sfdf &lt;-<span class="st"> </span><span class="kw">st_read</span>(<span class="dt">dsn =</span> <span class="st">&quot;police&quot;</span>)</span></code></pre></div>
<pre><code>## Reading layer `police&#39; from data source `/Users/jelsner/Desktop/Projects/ASSFG-Book/police&#39; using driver `ESRI Shapefile&#39;
## Simple feature collection with 82 features and 21 fields
## geometry type:  POLYGON
## dimension:      XY
## bbox:           xmin: -91.64356 ymin: 30.19474 xmax: -88.09043 ymax: 35.00496
## CRS:            NA</code></pre>
<p>Create an S4 spatial object from the simple feature object.</p>
<div class="sourceCode" id="cb313"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb313-1"><a href="spatial-data.html#cb313-1"></a>spdf &lt;-<span class="st"> </span><span class="kw">as</span>(sfdf, <span class="st">&quot;Spatial&quot;</span>)</span></code></pre></div>
<p>Note that the proj4string is specified as <code>NA</code> (missing). We know these data have a geographic CRS so we assign it as follows.</p>
<div class="sourceCode" id="cb314"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb314-1"><a href="spatial-data.html#cb314-1"></a><span class="kw">proj4string</span>(spdf) &lt;-<span class="st"> &quot;+proj=longlat +datum=WGS84 +ellps=WGS84&quot;</span></span></code></pre></div>
<p>The <code>plot()</code> method plots the polygons. First using the native geographic coordinates then using projected coordinates. We set up the side-by-side plots using the <code>par()</code> function.</p>
<div class="sourceCode" id="cb315"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb315-1"><a href="spatial-data.html#cb315-1"></a><span class="kw">par</span>(<span class="dt">mfrow =</span> <span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">2</span>))</span>
<span id="cb315-2"><a href="spatial-data.html#cb315-2"></a></span>
<span id="cb315-3"><a href="spatial-data.html#cb315-3"></a><span class="kw">plot</span>(spdf)</span>
<span id="cb315-4"><a href="spatial-data.html#cb315-4"></a>spdfP &lt;-<span class="st"> </span><span class="kw">spTransform</span>(spdf, </span>
<span id="cb315-5"><a href="spatial-data.html#cb315-5"></a>                     <span class="dt">CRS =</span> <span class="kw">CRS</span>(<span class="st">&quot;+proj=lcc +lat_1=60 +lat_2=30 +lon_0=-80 +units=km&quot;</span>))</span>
<span id="cb315-6"><a href="spatial-data.html#cb315-6"></a><span class="kw">plot</span>(spdfP)</span></code></pre></div>
<p><img src="assfg-book_files/figure-html/unnamed-chunk-144-1.png" width="672" /></p>
<div class="sourceCode" id="cb316"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb316-1"><a href="spatial-data.html#cb316-1"></a><span class="kw">par</span>(<span class="dt">mfrow =</span> <span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">1</span>))</span></code></pre></div>
<p>Note: Here the projection is a Lambert conformal conic with secant latitudes at 30 and 60N and centered at 80W longitude.</p>
<p>By including the <code>byid = TRUE</code> argument in the <code>gEnvelope()</code> function, we create a spatial polygon object with 82 rectangles.</p>
<div class="sourceCode" id="cb317"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb317-1"><a href="spatial-data.html#cb317-1"></a>boxes &lt;-<span class="st"> </span><span class="kw">gEnvelope</span>(spdfP, </span>
<span id="cb317-2"><a href="spatial-data.html#cb317-2"></a>                   <span class="dt">byid =</span> <span class="ot">TRUE</span>)</span>
<span id="cb317-3"><a href="spatial-data.html#cb317-3"></a><span class="kw">plot</span>(boxes)</span></code></pre></div>
<p><img src="assfg-book_files/figure-html/unnamed-chunk-145-1.png" width="672" /></p>
<p>The <code>gCentroid()</code> function computes the geometric center of the spatial object and returns a S4 spatial object of class <code>SpatialPoints</code>.</p>
<div class="sourceCode" id="cb318"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb318-1"><a href="spatial-data.html#cb318-1"></a>centers &lt;-<span class="st"> </span><span class="kw">gCentroid</span>(spdfP, </span>
<span id="cb318-2"><a href="spatial-data.html#cb318-2"></a>                     <span class="dt">byid =</span> <span class="ot">TRUE</span>)</span>
<span id="cb318-3"><a href="spatial-data.html#cb318-3"></a><span class="kw">class</span>(centers)</span></code></pre></div>
<pre><code>## [1] &quot;SpatialPoints&quot;
## attr(,&quot;package&quot;)
## [1] &quot;sp&quot;</code></pre>
<div class="sourceCode" id="cb320"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb320-1"><a href="spatial-data.html#cb320-1"></a><span class="kw">plot</span>(centers)</span></code></pre></div>
<p><img src="assfg-book_files/figure-html/unnamed-chunk-146-1.png" width="672" /></p>
<p>The function <code>gArea()</code> returns the geographical area (in square kilometers) of the geometries.</p>
<div class="sourceCode" id="cb321"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb321-1"><a href="spatial-data.html#cb321-1"></a>areas &lt;-<span class="st"> </span><span class="kw">gArea</span>(spdfP, </span>
<span id="cb321-2"><a href="spatial-data.html#cb321-2"></a>               <span class="dt">byid =</span> <span class="ot">TRUE</span>) <span class="op">%&gt;%</span></span>
<span id="cb321-3"><a href="spatial-data.html#cb321-3"></a><span class="st">   </span><span class="kw">glimpse</span>()</span></code></pre></div>
<pre><code>##  Named num [1:82] 1022 1091 1137 1027 1247 ...
##  - attr(*, &quot;names&quot;)= chr [1:82] &quot;1&quot; &quot;2&quot; &quot;3&quot; &quot;4&quot; ...</code></pre>
<p>The output here is a numeric vector of length 82 listing the area of each county (in square kilometers).</p>
<p>Q: How would you determine the area of the entire state?</p>
<p>The <code>gContains()</code> function tests whether one geometry contains or is contained within another geometry. For example, which county contains the geographic center of the state? First determine the center with the <code>gCentroid()</code> function then determine which county contains it using the <code>gContain()</code> function.</p>
<div class="sourceCode" id="cb323"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb323-1"><a href="spatial-data.html#cb323-1"></a>center &lt;-<span class="st"> </span><span class="kw">gCentroid</span>(spdfP)</span>
<span id="cb323-2"><a href="spatial-data.html#cb323-2"></a>countyCenter &lt;-<span class="st"> </span><span class="kw">gContains</span>(spdfP, </span>
<span id="cb323-3"><a href="spatial-data.html#cb323-3"></a>                          center, </span>
<span id="cb323-4"><a href="spatial-data.html#cb323-4"></a>                          <span class="dt">byid =</span> <span class="ot">TRUE</span>)</span>
<span id="cb323-5"><a href="spatial-data.html#cb323-5"></a>countyCenter</span></code></pre></div>
<pre><code>##       1     2     3     4     5     6     7     8     9    10    11    12    13
## 1 FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE
##      14    15    16    17    18    19    20    21    22    23    24    25    26
## 1 FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE
##      27    28    29    30    31    32    33    34    35    36    37    38    39
## 1 FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE
##      40    41    42    43   44    45    46    47    48    49    50    51    52
## 1 FALSE FALSE FALSE FALSE TRUE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE
##      53    54    55    56    57    58    59    60    61    62    63    64    65
## 1 FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE
##      66    67    68    69    70    71    72    73    74    75    76    77    78
## 1 FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE
##      79    80    81    82
## 1 FALSE FALSE FALSE FALSE</code></pre>
<p>The result is a matrix containing all values equal to <code>FALSE</code> except for the county containing the geographic center.</p>
<p>To see this we use the <code>plot()</code> method. First the county boundaries then the center point as a red cross.</p>
<div class="sourceCode" id="cb325"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb325-1"><a href="spatial-data.html#cb325-1"></a><span class="kw">plot</span>(spdfP)</span>
<span id="cb325-2"><a href="spatial-data.html#cb325-2"></a><span class="kw">plot</span>(center, </span>
<span id="cb325-3"><a href="spatial-data.html#cb325-3"></a>     <span class="dt">add =</span> <span class="ot">TRUE</span>,</span>
<span id="cb325-4"><a href="spatial-data.html#cb325-4"></a>     <span class="dt">col =</span> <span class="st">&quot;red&quot;</span>)</span></code></pre></div>
<p>Suppose we want to subset the center county making it it’s own <code>SpatialPolygonsDataFrame</code>. We first turn the <code>matrix</code> object <code>countyCenter</code> into a vector then use the <code>[]</code> operator on <code>spdfP</code>.</p>
<div class="sourceCode" id="cb326"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb326-1"><a href="spatial-data.html#cb326-1"></a>centerCounty &lt;-<span class="st"> </span>spdfP[<span class="kw">as.vector</span>(countyCenter), ]</span>
<span id="cb326-2"><a href="spatial-data.html#cb326-2"></a><span class="kw">plot</span>(spdfP)</span>
<span id="cb326-3"><a href="spatial-data.html#cb326-3"></a><span class="kw">plot</span>(centerCounty, </span>
<span id="cb326-4"><a href="spatial-data.html#cb326-4"></a>     <span class="dt">col =</span> <span class="st">&quot;red&quot;</span>, </span>
<span id="cb326-5"><a href="spatial-data.html#cb326-5"></a>     <span class="dt">add =</span> <span class="ot">TRUE</span>)</span></code></pre></div>
<p>The <code>gBuffer()</code> function expands the given geometry to include the area within the specified width with specific styling options. Here we create a buffer around the state at a distance of 100 km.</p>
<div class="sourceCode" id="cb327"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb327-1"><a href="spatial-data.html#cb327-1"></a>largerState &lt;-<span class="st"> </span><span class="kw">gBuffer</span>(spdfP, </span>
<span id="cb327-2"><a href="spatial-data.html#cb327-2"></a>                       <span class="dt">width =</span> <span class="dv">100</span>)</span>
<span id="cb327-3"><a href="spatial-data.html#cb327-3"></a><span class="kw">plot</span>(largerState)</span>
<span id="cb327-4"><a href="spatial-data.html#cb327-4"></a><span class="kw">plot</span>(spdfP, </span>
<span id="cb327-5"><a href="spatial-data.html#cb327-5"></a>     <span class="dt">add =</span> <span class="ot">TRUE</span>)</span></code></pre></div>
<p>The output from <code>gBuffer()</code> is a <code>SpatialPolyons</code> object.</p>
<p>There are many more functions for geocomputation on S4 spatial data frames. The reference manual is available here <a href="https://cran.r-project.org/web/packages/rgeos/rgeos.pdf" class="uri">https://cran.r-project.org/web/packages/rgeos/rgeos.pdf</a></p>
</div>
<div id="a-few-notes-about-coordinate-reference-systems" class="section level3" number="3.1.2">
<h3><span class="header-section-number">3.1.2</span> A few notes about coordinate reference systems</h3>
<p>CRS provide a standardized way of describing locations. Many different CRS are used to describe geographic data. The CRS that is chosen depends on when the data was collected, the geographic extent of the data, the purpose of the data, etc.</p>
<p>When data with different CRS are combined it is important to transform them to a common CRS so they align with one another. This is similar to making sure that units are the same when measuring volume or distances.</p>
<p>In S4 spatial objects, CRS information is available in the <code>proj4string</code> slot.</p>
<div class="sourceCode" id="cb328"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb328-1"><a href="spatial-data.html#cb328-1"></a><span class="kw">proj4string</span>(sldf)</span></code></pre></div>
<pre><code>## [1] &quot;+proj=longlat +datum=WGS84 +no_defs +ellps=WGS84 +towgs84=0,0,0&quot;</code></pre>
<p>Information is given as a character string that includes the projection (here <code>+proj=longlat</code>), the datum (here <code>+datum=WGS84 +towgs84=0,0,0</code>), and the ellipsoid (here <code>+ellps=WGS84</code>). The syntax uses the PROJ standard. Various options are listed with the <code>projInfo()</code> function from the <strong>rgdal</strong> package.</p>
<div class="sourceCode" id="cb330"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb330-1"><a href="spatial-data.html#cb330-1"></a><span class="kw">library</span>(rgdal)</span></code></pre></div>
<pre><code>## rgdal: version: 1.4-8, (SVN revision 845)
##  Geospatial Data Abstraction Library extensions to R successfully loaded
##  Loaded GDAL runtime: GDAL 2.4.2, released 2019/06/28
##  Path to GDAL shared files: /Library/Frameworks/R.framework/Versions/4.0/Resources/library/rgdal/gdal
##  GDAL binary built with GEOS: FALSE 
##  Loaded PROJ.4 runtime: Rel. 5.2.0, September 15th, 2018, [PJ_VERSION: 520]
##  Path to PROJ.4 shared files: /Library/Frameworks/R.framework/Versions/4.0/Resources/library/rgdal/proj
##  Linking to sp version: 1.4-1</code></pre>
<div class="sourceCode" id="cb332"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb332-1"><a href="spatial-data.html#cb332-1"></a><span class="kw">head</span>(<span class="kw">projInfo</span>(<span class="dt">type =</span> <span class="st">&quot;proj&quot;</span>))</span></code></pre></div>
<pre><code>##     name                  description
## 1    aea            Albers Equal Area
## 2   aeqd        Azimuthal Equidistant
## 3   airy                         Airy
## 4 aitoff                       Aitoff
## 5   alsk Mod. Stereographic of Alaska
## 6  apian             Apian Globular I</code></pre>
<div class="sourceCode" id="cb334"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb334-1"><a href="spatial-data.html#cb334-1"></a><span class="kw">projInfo</span>(<span class="dt">type =</span> <span class="st">&quot;datum&quot;</span>)</span></code></pre></div>
<pre><code>##             name   ellipse
## 1          WGS84     WGS84
## 2         GGRS87     GRS80
## 3          NAD83     GRS80
## 4          NAD27    clrk66
## 5        potsdam    bessel
## 6       carthage clrk80ign
## 7  hermannskogel    bessel
## 8          ire65  mod_airy
## 9         nzgd49      intl
## 10        OSGB36      airy
##                                                        definition
## 1                                                   towgs84=0,0,0
## 2                                    towgs84=-199.87,74.79,246.62
## 3                                                   towgs84=0,0,0
## 4               nadgrids=@conus,@alaska,@ntv2_0.gsb,@ntv1_can.dat
## 5                                          nadgrids=@BETA2007.gsb
## 6                                        towgs84=-263.0,6.0,431.0
## 7         towgs84=577.326,90.129,463.919,5.137,1.474,5.297,2.4232
## 8      towgs84=482.530,-130.596,564.557,-1.042,-0.214,-0.631,8.15
## 9              towgs84=59.47,-5.04,187.44,0.47,-0.1,1.024,-4.5993
## 10 towgs84=446.448,-125.157,542.060,0.1502,0.2470,0.8421,-20.4894
##                             description
## 1                                      
## 2  Greek_Geodetic_Reference_System_1987
## 3             North_American_Datum_1983
## 4             North_American_Datum_1927
## 5           Potsdam Rauenberg 1950 DHDN
## 6                 Carthage 1934 Tunisia
## 7                         Hermannskogel
## 8                          Ireland 1965
## 9       New Zealand Geodetic Datum 1949
## 10                            Airy 1830</code></pre>
<div class="sourceCode" id="cb336"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb336-1"><a href="spatial-data.html#cb336-1"></a><span class="kw">head</span>(<span class="kw">projInfo</span>(<span class="dt">type =</span> <span class="st">&quot;ellps&quot;</span>))</span></code></pre></div>
<pre><code>##     name         major              ell               description
## 1  MERIT   a=6378137.0       rf=298.257                MERIT 1983
## 2  SGS85   a=6378136.0       rf=298.257 Soviet Geodetic System 85
## 3  GRS80   a=6378137.0 rf=298.257222101      GRS 1980(IUGG, 1980)
## 4  IAU76   a=6378140.0       rf=298.257                  IAU 1976
## 5   airy a=6377563.396    b=6356256.910                 Airy 1830
## 6 APL4.9  a=6378137.0.        rf=298.25       Appl. Physics. 1965</code></pre>
<p>The ellipsoid describes the shape of the Earth and the datum provides the information needed to anchor the abstract coordinates to the Earth. The datum defines an origin point of the coordinate axes and defines the direction of the axes.</p>
<p>The datum always specifies the ellipsoid, but the ellipsoid does not specify the datum. Datums are based on specific ellipsoids and sometimes have the same name as the ellipsoid.
A CRS can be referenced by its EPSG code (e.g., <code>epsg:4121</code>). The EPSG is a structured dataset of CRSs originally compiled by the European Petroleum Survey Group (EPSG). Details of a particular EPSG code is obtained by</p>
<div class="sourceCode" id="cb338"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb338-1"><a href="spatial-data.html#cb338-1"></a><span class="kw">CRS</span>(<span class="st">&quot;+init=epsg:4326&quot;</span>)</span></code></pre></div>
<pre><code>## CRS arguments:
##  +init=epsg:4326 +proj=longlat +datum=WGS84 +no_defs +ellps=WGS84
## +towgs84=0,0,0</code></pre>
<p>EPSG codes for commonly used CRSs include:</p>
<ul>
<li><p>Geographic</p></li>
<li><p>WGS84 (EPSG:4326) Used by organizations that provide GIS data for the entire globe. Used by Google Earth.</p></li>
<li><p>NAD83 (EPSG:4269) Used by U.S. federal agencies.</p></li>
<li><p>Projected</p></li>
<li><p>Mercator (EPSG:3857) Mercator, tiles from Google Maps, Open Street Maps, Stamen Maps</p></li>
<li><p>UTM, Zone 10 (EPSG:32610) Pacific Northwest</p></li>
</ul>
<p>When <code>readOGR()</code> and <code>st_read()</code> are used to load spatial data, the CRS information is included as part of the spatial object.</p>
<div class="sourceCode" id="cb340"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb340-1"><a href="spatial-data.html#cb340-1"></a><span class="kw">proj4string</span>(sldf)</span></code></pre></div>
<pre><code>## [1] &quot;+proj=longlat +datum=WGS84 +no_defs +ellps=WGS84 +towgs84=0,0,0&quot;</code></pre>
<div class="sourceCode" id="cb342"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb342-1"><a href="spatial-data.html#cb342-1"></a><span class="kw">attr</span>(sfdf<span class="op">$</span>geometry, <span class="st">&quot;crs&quot;</span>)<span class="op">$</span>proj4string</span></code></pre></div>
<pre><code>## [1] NA</code></pre>
<p>To assign a known CRS to a S4 spatial object <code>x</code> type either:</p>
<div class="sourceCode" id="cb344"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb344-1"><a href="spatial-data.html#cb344-1"></a><span class="kw">proj4string</span>(x) &lt;-<span class="st"> </span><span class="kw">CRS</span>(<span class="st">&quot;+init=epsg:28992&quot;</span>)</span>
<span id="cb344-2"><a href="spatial-data.html#cb344-2"></a><span class="kw">proj4string</span>(x) &lt;-<span class="st"> </span><span class="kw">CRS</span>(<span class="st">&quot;+proj=utm +zone=10 +datum=WGS84&quot;</span>)</span></code></pre></div>
<p>CAUTION: Assigning a CRS does not re-project the geometry. Also, this is only for S4 spatial data. To transform from one CRS to another use the <code>spTransform</code> function from the <strong>rgdal</strong> package. For example, type either:</p>
<div class="sourceCode" id="cb345"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb345-1"><a href="spatial-data.html#cb345-1"></a>xT &lt;-<span class="st"> </span><span class="kw">spTransform</span>(x, <span class="kw">CRS</span>(<span class="st">&quot;+init=epsg:4238&quot;</span>))</span>
<span id="cb345-2"><a href="spatial-data.html#cb345-2"></a>xT &lt;-<span class="st"> </span><span class="kw">spTransform</span>(x, <span class="kw">proj4string</span>(z))</span></code></pre></div>
<p>Here <code>z</code> is a spatial data with a valid CRS.</p>
<p>An overview of CRSs is available here <a href="https://www.nceas.ucsb.edu/~frazier/RSpatialGuides/OverviewCoordinateReferenceSystems.pdf" class="uri">https://www.nceas.ucsb.edu/~frazier/RSpatialGuides/OverviewCoordinateReferenceSystems.pdf</a></p>
<p>Note: NOAA’s National Geodetic Survey is currently working on the modernization of the National Spatial Reference System (NSRS), which will replace the North American Datum of 1983 (NAD83) and the North American Vertical Datum of 1988 (NAVD88) with a new geometric reference frame and geopotential datum in 2022.</p>
<p>Dennis Riordan, the NGS representative for the Gulf coast, has agreed to give a presentation on this change to our class on February 11th. I will open it up to other students and faculty.</p>
</div>
<div id="creating-an-s4-object" class="section level3" number="3.1.3">
<h3><span class="header-section-number">3.1.3</span> Creating an S4 object</h3>
<p>Most of the time there is no need to create a spatial data frame since it will be imported as such. However it’s helpful to understand how spatial data are constructed and stored.</p>
<p>For example, here we import a data frame the contains information on the location of the CRAN sites in 2007.</p>
<div class="sourceCode" id="cb346"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb346-1"><a href="spatial-data.html#cb346-1"></a>df &lt;-<span class="st"> </span><span class="kw">read.table</span>(<span class="dt">file =</span> <span class="st">&quot;http://myweb.fsu.edu/jelsner/temp/data/CRAN051001a.txt&quot;</span>,</span>
<span id="cb346-2"><a href="spatial-data.html#cb346-2"></a>                 <span class="dt">header =</span> <span class="ot">TRUE</span>)</span>
<span id="cb346-3"><a href="spatial-data.html#cb346-3"></a><span class="kw">head</span>(df)</span></code></pre></div>
<pre><code>##            place   north     east       loc      long       lat
## 1       Brisbane 27d28&#39;S 153d02&#39;E Australia 153.03333 -27.46667
## 2      Melbourne 37d49&#39;S 144d58&#39;E Australia 144.96667 -37.81667
## 3           Wien 48d13&#39;N  16d20&#39;E   Austria  16.33333  48.21667
## 4       Curitiba 25d25&#39;S  49d16&#39;W    Brazil -49.26667 -25.41667
## 5          Vioza 20d45&#39;S  42d52&#39;W    Brazil -42.86667 -20.75000
## 6 Rio de Janeiro 22d54&#39;S  43d12&#39;W    Brazil -43.20000 -22.90000</code></pre>
<p>Note here I use the <code>read.table()</code> function from base R. It is very similar to the <code>read_table()</code> function from the <strong>readr</strong> package but the default requires you to specify whether the first row of the file contains column names (<code>header = TRUE</code>).</p>
<p>Each row is a location. The location includes the name of the location and spatial coordinates.</p>
<p>Here we create a spatial points data frame using the <code>coordinates()</code> function (from the <strong>sp</strong> package). We first assign to the object <code>spdf</code> the original data frame. We then specify what columns in <code>spdf</code> we want as the coordinates. Here use the columns labeled <code>long</code> and <code>lat</code>.</p>
<div class="sourceCode" id="cb348"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb348-1"><a href="spatial-data.html#cb348-1"></a>spdf &lt;-<span class="st"> </span>df</span>
<span id="cb348-2"><a href="spatial-data.html#cb348-2"></a><span class="kw">coordinates</span>(spdf) &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;long&quot;</span>, <span class="st">&quot;lat&quot;</span>)</span></code></pre></div>
<p>Note: Unlike most functions, the <code>coordinates()</code> is on the left side of the assignment operator.</p>
<div class="sourceCode" id="cb349"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb349-1"><a href="spatial-data.html#cb349-1"></a><span class="kw">head</span>(spdf)</span></code></pre></div>
<pre><code>## class       : SpatialPointsDataFrame 
## features    : 6 
## extent      : -49.26667, 153.0333, -37.81667, 48.21667  (xmin, xmax, ymin, ymax)
## crs         : NA 
## variables   : 4
## names       :    place,   north,     east,       loc 
## min values  : Brisbane, 20d45&#39;S, 144d58&#39;E, Australia 
## max values  :     Wien, 48d13&#39;N,  49d16&#39;W,    Brazil</code></pre>
<div class="sourceCode" id="cb351"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb351-1"><a href="spatial-data.html#cb351-1"></a><span class="kw">head</span>(spdf<span class="op">@</span>data)</span></code></pre></div>
<pre><code>##            place   north     east       loc
## 1       Brisbane 27d28&#39;S 153d02&#39;E Australia
## 2      Melbourne 37d49&#39;S 144d58&#39;E Australia
## 3           Wien 48d13&#39;N  16d20&#39;E   Austria
## 4       Curitiba 25d25&#39;S  49d16&#39;W    Brazil
## 5          Vioza 20d45&#39;S  42d52&#39;W    Brazil
## 6 Rio de Janeiro 22d54&#39;S  43d12&#39;W    Brazil</code></pre>
<p>The columns <code>long</code> and <code>lat</code> are moved to the <code>coords</code> slot of the now spatial points data frame.</p>
<div class="sourceCode" id="cb353"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb353-1"><a href="spatial-data.html#cb353-1"></a><span class="kw">head</span>(<span class="kw">slot</span>(spdf, <span class="st">&quot;coords&quot;</span>))</span></code></pre></div>
<pre><code>##           long       lat
## [1,] 153.03333 -27.46667
## [2,] 144.96667 -37.81667
## [3,]  16.33333  48.21667
## [4,] -49.26667 -25.41667
## [5,] -42.86667 -20.75000
## [6,] -43.20000 -22.90000</code></pre>
<p>The <code>proj4string</code> slot is coded as <code>NA</code> indicating that there is no coordinate reference system (CRS). We see that with the <code>proj4string()</code> function or with <code>spdf@proj4string</code>.</p>
<div class="sourceCode" id="cb355"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb355-1"><a href="spatial-data.html#cb355-1"></a><span class="kw">proj4string</span>(spdf)</span></code></pre></div>
<pre><code>## [1] NA</code></pre>
<div class="sourceCode" id="cb357"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb357-1"><a href="spatial-data.html#cb357-1"></a>spdf<span class="op">@</span>proj4string</span></code></pre></div>
<pre><code>## CRS arguments: NA</code></pre>
<p>Since the coordinates are longitude and latitude we assign a geographic CRS. We do that by first using the <code>CRS()</code> function and specifying a PROJ character string. We then assign this to the spatial points data frame with the <code>proj4string()</code> function.</p>
<div class="sourceCode" id="cb359"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb359-1"><a href="spatial-data.html#cb359-1"></a>llCRS &lt;-<span class="st"> </span><span class="kw">CRS</span>(<span class="st">&quot;+proj=longlat +ellps=WGS84&quot;</span>)</span>
<span id="cb359-2"><a href="spatial-data.html#cb359-2"></a><span class="kw">proj4string</span>(spdf) &lt;-<span class="st"> </span>llCRS</span>
<span id="cb359-3"><a href="spatial-data.html#cb359-3"></a><span class="kw">proj4string</span>(spdf)</span></code></pre></div>
<pre><code>## [1] &quot;+proj=longlat +ellps=WGS84&quot;</code></pre>
<p>We can speak of a geographic CRS (model for shape of the earth plus lat/lon) or a projected CRS (model for shape of Earth plus a specific geometric model for projecting to a flat surface).</p>
<div class="sourceCode" id="cb361"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb361-1"><a href="spatial-data.html#cb361-1"></a><span class="kw">is.projected</span>(spdf)</span></code></pre></div>
<pre><code>## [1] FALSE</code></pre>
<p>Once the data has a CRS, it can be re-projected using the <code>spTransform()</code> function in the <strong>rgdal</strong> package.</p>
</div>
<div id="the-spplot-method" class="section level3" number="3.1.4">
<h3><span class="header-section-number">3.1.4</span> The <code>spplot()</code> method</h3>
<p>The easiest way to make a thematic map with an S4 spatial data frame is with the <code>spplot()</code> method. The first argument in the <code>spplot()</code> function is the spatial data frame object and the second argument specifies what column to use to fill or color.</p>
<p>For example, returning to the police expenditure spatial polygons data frame (<code>spdfP</code>) we create a map of police expenditures by county. The expendures are in the column labeled <code>POLICE</code> so we specify this column name with the argument <code>zcol = "POLICE"</code>.</p>
<div class="sourceCode" id="cb363"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb363-1"><a href="spatial-data.html#cb363-1"></a><span class="kw">spplot</span>(spdfP, </span>
<span id="cb363-2"><a href="spatial-data.html#cb363-2"></a>       <span class="dt">zcol =</span> <span class="st">&quot;POLICE&quot;</span>)</span></code></pre></div>
<p><img src="assfg-book_files/figure-html/unnamed-chunk-165-1.png" width="672" /></p>
<p>The result is a choropleth map indicating police expenditures with a default color ramp from dark blue (indicating low expenditure) to yellow (indicating high expenditure).</p>
<p>While easy to apply the default settings on this method fail to produce a good map. We can improve things but it requires some trial-and-error.</p>
<p>For example, to improve the color ramp. We first specify a range of values using the <code>seq()</code> function then a set of 6 colors using the <code>brewer.pal()</code> function from the <strong>RColorBrewer</strong> package. We determine the range with the <code>range()</code> function.</p>
<p>We specify the color palette to be 6 shades of green. We then add the arguments <code>col.regions =</code> and <code>at =</code> in the <code>spplot()</code> function call.</p>
<div class="sourceCode" id="cb364"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb364-1"><a href="spatial-data.html#cb364-1"></a><span class="kw">library</span>(RColorBrewer)</span>
<span id="cb364-2"><a href="spatial-data.html#cb364-2"></a></span>
<span id="cb364-3"><a href="spatial-data.html#cb364-3"></a><span class="kw">range</span>(spdfP<span class="op">$</span>POLICE)</span></code></pre></div>
<pre><code>## [1]    49 10971</code></pre>
<div class="sourceCode" id="cb366"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb366-1"><a href="spatial-data.html#cb366-1"></a>rng &lt;-<span class="st"> </span><span class="kw">seq</span>(<span class="dv">0</span>, <span class="dv">12000</span>, <span class="dv">2000</span>)</span>
<span id="cb366-2"><a href="spatial-data.html#cb366-2"></a>cls &lt;-<span class="st"> </span><span class="kw">brewer.pal</span>(<span class="dv">6</span>, <span class="st">&quot;Greens&quot;</span>)</span>
<span id="cb366-3"><a href="spatial-data.html#cb366-3"></a><span class="kw">spplot</span>(spdfP, </span>
<span id="cb366-4"><a href="spatial-data.html#cb366-4"></a>       <span class="dt">zcol =</span> <span class="st">&quot;POLICE&quot;</span>, </span>
<span id="cb366-5"><a href="spatial-data.html#cb366-5"></a>       <span class="dt">col.regions =</span> cls, </span>
<span id="cb366-6"><a href="spatial-data.html#cb366-6"></a>       <span class="dt">at =</span> rng)</span></code></pre></div>
<p><img src="assfg-book_files/figure-html/unnamed-chunk-166-1.png" width="672" /></p>
<p>Better.</p>
<p>We reuse this code making small modifications to create a thematic map showing percentage of the population that is unemployed.</p>
<div class="sourceCode" id="cb367"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb367-1"><a href="spatial-data.html#cb367-1"></a><span class="kw">range</span>(spdfP<span class="op">$</span>UNEMP)</span></code></pre></div>
<pre><code>## [1]  4 17</code></pre>
<div class="sourceCode" id="cb369"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb369-1"><a href="spatial-data.html#cb369-1"></a>rng &lt;-<span class="st"> </span><span class="kw">seq</span>(<span class="dv">4</span>, <span class="dv">18</span>, <span class="dv">2</span>)</span>
<span id="cb369-2"><a href="spatial-data.html#cb369-2"></a>cls &lt;-<span class="st"> </span><span class="kw">brewer.pal</span>(<span class="dv">7</span>, <span class="st">&quot;Blues&quot;</span>)</span>
<span id="cb369-3"><a href="spatial-data.html#cb369-3"></a><span class="kw">spplot</span>(spdfP, </span>
<span id="cb369-4"><a href="spatial-data.html#cb369-4"></a>       <span class="dt">zcol =</span> <span class="st">&quot;UNEMP&quot;</span>, </span>
<span id="cb369-5"><a href="spatial-data.html#cb369-5"></a>       <span class="dt">col.regions =</span> cls, </span>
<span id="cb369-6"><a href="spatial-data.html#cb369-6"></a>       <span class="dt">at =</span> rng,</span>
<span id="cb369-7"><a href="spatial-data.html#cb369-7"></a>       <span class="dt">colorkey =</span> <span class="kw">list</span>(<span class="dt">space =</span> <span class="st">&quot;bottom&quot;</span>), </span>
<span id="cb369-8"><a href="spatial-data.html#cb369-8"></a>       <span class="dt">sub =</span> <span class="st">&quot;Unemployment (%)&quot;</span>)</span></code></pre></div>
<p><img src="assfg-book_files/figure-html/unnamed-chunk-167-1.png" width="672" /></p>
<p>Note that the color key is blaced on the bottom.</p>
<p>We add a north arrow by first determining the bounding box of the plot and then creating a list that specifies the scale and location of the arrow. This list gets passed to the <code>spplot()</code> function through the <code>sp.layout =</code> argument. Here we start by reprojecting the spatial data frame.</p>
<div class="sourceCode" id="cb370"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb370-1"><a href="spatial-data.html#cb370-1"></a>spdfP &lt;-<span class="st"> </span><span class="kw">spTransform</span>(spdfP, </span>
<span id="cb370-2"><a href="spatial-data.html#cb370-2"></a>                     <span class="dt">CRS =</span> <span class="kw">CRS</span>(<span class="st">&quot;+proj=lcc +lat_1=60 +lat_2=30 +lon_0=-90 +units=km&quot;</span>))</span>
<span id="cb370-3"><a href="spatial-data.html#cb370-3"></a></span>
<span id="cb370-4"><a href="spatial-data.html#cb370-4"></a><span class="kw">bbox</span>(spdfP)</span></code></pre></div>
<pre><code>##         min       max
## x -155.6854  171.4047
## y 3714.4452 4244.1786</code></pre>
<div class="sourceCode" id="cb372"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb372-1"><a href="spatial-data.html#cb372-1"></a>l1 &lt;-<span class="st"> </span><span class="kw">list</span>(<span class="st">&quot;SpatialPolygonsRescale&quot;</span>, </span>
<span id="cb372-2"><a href="spatial-data.html#cb372-2"></a>           <span class="kw">layout.north.arrow</span>(), </span>
<span id="cb372-3"><a href="spatial-data.html#cb372-3"></a>           <span class="dt">offset =</span> <span class="kw">c</span>(<span class="op">-</span><span class="dv">125</span>, <span class="dv">4200</span>), </span>
<span id="cb372-4"><a href="spatial-data.html#cb372-4"></a>           <span class="dt">scale =</span> <span class="dv">40</span>)</span>
<span id="cb372-5"><a href="spatial-data.html#cb372-5"></a><span class="kw">spplot</span>(spdfP, </span>
<span id="cb372-6"><a href="spatial-data.html#cb372-6"></a>       <span class="dt">zcol =</span> <span class="st">&quot;UNEMP&quot;</span>, </span>
<span id="cb372-7"><a href="spatial-data.html#cb372-7"></a>       <span class="dt">col.regions =</span> cls, </span>
<span id="cb372-8"><a href="spatial-data.html#cb372-8"></a>       <span class="dt">at =</span> rng,</span>
<span id="cb372-9"><a href="spatial-data.html#cb372-9"></a>       <span class="dt">sp.layout =</span> <span class="kw">list</span>(l1),</span>
<span id="cb372-10"><a href="spatial-data.html#cb372-10"></a>       <span class="dt">colorkey =</span> <span class="kw">list</span>(<span class="dt">space =</span> <span class="st">&quot;bottom&quot;</span>), </span>
<span id="cb372-11"><a href="spatial-data.html#cb372-11"></a>       <span class="dt">sub =</span> <span class="st">&quot;Unemployment (%)&quot;</span>)</span></code></pre></div>
<p><img src="assfg-book_files/figure-html/unnamed-chunk-168-1.png" width="672" /></p>
<p>Similarly, we add a scale bar.</p>
<div class="sourceCode" id="cb373"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb373-1"><a href="spatial-data.html#cb373-1"></a>l3 &lt;-<span class="st"> </span><span class="kw">list</span>(<span class="st">&quot;SpatialPolygonsRescale&quot;</span>, </span>
<span id="cb373-2"><a href="spatial-data.html#cb373-2"></a>          <span class="kw">layout.scale.bar</span>(), </span>
<span id="cb373-3"><a href="spatial-data.html#cb373-3"></a>          <span class="dt">offset =</span> <span class="kw">c</span>(<span class="op">-</span><span class="dv">125</span>, <span class="dv">3734</span>), </span>
<span id="cb373-4"><a href="spatial-data.html#cb373-4"></a>            <span class="dt">scale =</span> <span class="dv">50</span>, <span class="dt">fill =</span> <span class="kw">c</span>(<span class="st">&quot;transparent&quot;</span>,<span class="st">&quot;black&quot;</span>))</span>
<span id="cb373-5"><a href="spatial-data.html#cb373-5"></a>l4 &lt;-<span class="st"> </span><span class="kw">list</span>(<span class="st">&quot;sp.text&quot;</span>, <span class="kw">c</span>(<span class="op">-</span><span class="dv">125</span>, <span class="dv">3724</span>), <span class="st">&quot;0&quot;</span>)</span>
<span id="cb373-6"><a href="spatial-data.html#cb373-6"></a>l5 &lt;-<span class="st"> </span><span class="kw">list</span>(<span class="st">&quot;sp.text&quot;</span>, <span class="kw">c</span>(<span class="op">-</span><span class="dv">75</span>, <span class="dv">3724</span>), <span class="st">&quot;50 km&quot;</span>)</span>
<span id="cb373-7"><a href="spatial-data.html#cb373-7"></a><span class="kw">spplot</span>(spdfP, </span>
<span id="cb373-8"><a href="spatial-data.html#cb373-8"></a>       <span class="dt">zcol =</span> <span class="st">&quot;UNEMP&quot;</span>, </span>
<span id="cb373-9"><a href="spatial-data.html#cb373-9"></a>       <span class="dt">col.regions =</span> cls, </span>
<span id="cb373-10"><a href="spatial-data.html#cb373-10"></a>       <span class="dt">at =</span> rng,</span>
<span id="cb373-11"><a href="spatial-data.html#cb373-11"></a>  <span class="dt">sp.layout =</span> <span class="kw">list</span>(l1, l3, l4, l5), </span>
<span id="cb373-12"><a href="spatial-data.html#cb373-12"></a>  <span class="dt">colorkey =</span> <span class="kw">list</span>(<span class="dt">space =</span> <span class="st">&quot;bottom&quot;</span>), </span>
<span id="cb373-13"><a href="spatial-data.html#cb373-13"></a>  <span class="dt">sub =</span> <span class="st">&quot;Unemployment (%)&quot;</span>)</span></code></pre></div>
<p><img src="assfg-book_files/figure-html/unnamed-chunk-169-1.png" width="672" /></p>
<p>This takes a lot of trial and error.</p>
</div>
</div>
<div id="simple-features" class="section level2" number="3.2">
<h2><span class="header-section-number">3.2</span> Simple Features</h2>
<p>Simple features is a standard from the Open (as in ‘open source’) Geospatial Consortium (OGC) to represent geographic information. It simplifies working with geographic data by condensing geographic forms into a single geometry class.</p>
<p>The standard is implemented in spatial databases (e.g., PostGIS), commercial GIS (e.g., ESRI) and forms the vector data basis for libraries such as <a href="http://www.gdal.org/">GDAL</a>. A subset of simple features forms the <a href="http://geojson.org/">GeoJSON</a> standard.</p>
<p>The <strong>sf</strong> package (Pebesma 2017) supports these classes and includes plotting and other methods.</p>
<p>Functions in the <strong>sf</strong> package can represent all of the common vector geometry types: points, lines, polygons and their respective ‘multi’ versions (which group together features of the same type into a single feature). The functions in the <strong>sf</strong> also support geometry collections, which can contain multiple geometry types in a single object. But the <code>raster</code> data classes are not supported.</p>
<p>The <strong>sf</strong> package incorporates the three main packages of the spatial R ecosystem: <strong>sp</strong> (Pebesma and Bivand 2017) for the class system, <strong>rgdal</strong> (Bivand, Keitt, and Rowlingson 2017) for reading and writing data, and <strong>rgeos</strong> (Bivand and Rundel 2017) for spatial operations done with GEOS.</p>
<p>Simple features are data frames with a spatial column. The spatial column is usually called <code>geometry</code> (or <code>geom</code>). The geometry column is referenced like a regular column. For example, <code>world$geom</code> refers to the spatial column of the <code>world</code> simple feature data frame.</p>
<p>The difference is that the geometry column is a ‘list column’ of class <code>sfc</code> (simple feature column). The <code>sfc</code> is composed of objects of class <code>sfg</code> (simple feature geometries).</p>
<div class="figure">
<img src="figures/sf_anatomy.png" alt="" />
<p class="caption">Simple Feature Anatomy</p>
</div>
<p>Here we see:</p>
<ul>
<li>in green a simple feature: a single record, or <code>data.frame</code> row, consisting of attributes and geometry</li>
<li>in blue a single simple feature geometry (an object of class <code>sfg</code>)</li>
<li>in red a simple feature list-column (an object of class <code>sfc</code>, which is a column in the <code>data.frame</code>)</li>
<li>the geometries are represented as well-known text (WKT)</li>
</ul>
<p>Geometries are the building blocks of simple features. Well-known binary (WKB) and well-known text (WKT) are the way simple feature geometries are coded. WKB representations are hexadecimal strings readable by computers. This is why GIS and spatial databases use WKB to transfer and store geometry objects. WKT is a human-readable text description of simple features. The two formats are exchangeable.</p>
<p>A point is a coordinate in 2D, 3D or 4D space (see <code>vignette("sf1")</code> for more information) such as:</p>
<ul>
<li><code>POINT (5 2)</code></li>
</ul>
<p>The first number is the x coordinate and the second number is the y coordinate.</p>
<p>A linestring is a sequence of points with a straight line connecting the points, for example:</p>
<ul>
<li><code>LINESTRING (1 5, 4 4, 4 1, 2 2, 3 2)</code></li>
</ul>
<p>Each pair of x and y coordinates is separated by a comma.</p>
<p>A polygon is a sequence of points that form a closed, non-intersecting ring. Closed means that the first and the last point of a polygon have the same coordinates. A polygon has one exterior boundary (outer ring) but it can have interior boundaries (inner rings). An inner ring is called a ‘hole’.</p>
<ul>
<li>Polygon without a hole - <code>POLYGON ((1 5, 2 2, 4 1, 4 4, 1 5))</code></li>
</ul>
<p>Here there are two parentheses to start and two to end the string of coordinates.</p>
<ul>
<li>Polygon with one hole - <code>POLYGON ((1 5, 2 2, 4 1, 4 4, 1 5), (2 4, 3 4, 3 3, 2 3, 2 4))</code></li>
</ul>
<p>Here the first set of coordinates defines the outer edge of the polygon and the next set of coordinates defines the hole. The outer edge vertexes are connected in a counterclockwise direction. The inner edge vertexes (defining the hole in the polygon) are connected in a clockwise direction.</p>
<p>Simple features allow multiple geometries (hence the term ‘geometry collection’) using ‘multi’ version of each geometry type:</p>
<ul>
<li>Multipoint - <code>MULTIPOINT (5 2, 1 3, 3 4, 3 2)</code></li>
<li>Multistring - <code>MULTILINESTRING ((1 5, 4 4, 4 1, 2 2, 3 2), (1 2, 2 4))</code></li>
<li>Multipolygon - <code>MULTIPOLYGON (((1 5, 2 2, 4 1, 4 4, 1 5), (0 2, 1 2, 1 3, 0 3, 0 2)))</code></li>
</ul>
<p>Q: What is the syntatical difference between a polygon with a hole and a multipolygon?</p>
<p>A collection of these is made:</p>
<ul>
<li>Geometry collection - <code>GEOMETRYCOLLECTION (MULTIPOINT (5 2, 1 3, 3 4, 3 2), LINESTRING (1 5, 4 4, 4 1, 2 2, 3 2)))</code></li>
</ul>
<div id="simple-feature-geometry-sfg" class="section level3" number="3.2.1">
<h3><span class="header-section-number">3.2.1</span> Simple feature geometry (<code>sfg</code>)</h3>
<p>The <code>sfg</code> class represents the simple feature geometry types: point, linestring, polygon (and their ‘multi’ equivalents, such as multipoints) or geometry collection.</p>
<p>Usually we don’t need to create geometries when we import our data. However, there are a set of functions to create simple feature geometry objects (<code>sfg</code>) from scratch if needed. The names of these functions are simple and consistent, as they all start with the <code>st_</code> prefix and end with the name of the geometry type in lowercase letters:</p>
<ul>
<li>A point - <code>st_point()</code></li>
<li>A linestring - <code>st_linestring()</code></li>
<li>A polygon - <code>st_polygon()</code></li>
<li>A multipoint - <code>st_multipoint()</code></li>
<li>A multilinestring - <code>st_multilinestring()</code></li>
<li>A multipolygon - <code>st_multipolygon()</code></li>
<li>A geometry collection - <code>st_geometrycollection()</code></li>
</ul>
<p>An <code>sfg</code> object can be created from three data types:</p>
<ul>
<li>A numeric vector - a single point</li>
<li>A matrix - a set of points, where each row contains a point - a multipoint or linestring</li>
<li>A list - any other set, e.g. a multilinestring or geometry collection</li>
</ul>
<p>To create point objects, we use the <code>st_point()</code> function in conjunction with a numeric vector:</p>
<div class="sourceCode" id="cb374"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb374-1"><a href="spatial-data.html#cb374-1"></a><span class="kw">library</span>(sf)</span>
<span id="cb374-2"><a href="spatial-data.html#cb374-2"></a></span>
<span id="cb374-3"><a href="spatial-data.html#cb374-3"></a><span class="kw">st_point</span>(<span class="kw">c</span>(<span class="dv">5</span>, <span class="dv">2</span>)) <span class="co"># XY point</span></span></code></pre></div>
<pre><code>## POINT (5 2)</code></pre>
<div class="sourceCode" id="cb376"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb376-1"><a href="spatial-data.html#cb376-1"></a><span class="kw">st_point</span>(<span class="kw">c</span>(<span class="dv">5</span>, <span class="dv">2</span>, <span class="dv">3</span>)) <span class="co"># XYZ point</span></span></code></pre></div>
<pre><code>## POINT Z (5 2 3)</code></pre>
<p>To create multipoint objects, we use matrices:</p>
<div class="sourceCode" id="cb378"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb378-1"><a href="spatial-data.html#cb378-1"></a>mp.matrix &lt;-<span class="st"> </span><span class="kw">rbind</span>(<span class="kw">c</span>(<span class="dv">5</span>, <span class="dv">2</span>), <span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">3</span>), <span class="kw">c</span>(<span class="dv">3</span>, <span class="dv">4</span>), <span class="kw">c</span>(<span class="dv">3</span>, <span class="dv">2</span>))</span>
<span id="cb378-2"><a href="spatial-data.html#cb378-2"></a>mp.matrix</span></code></pre></div>
<pre><code>##      [,1] [,2]
## [1,]    5    2
## [2,]    1    3
## [3,]    3    4
## [4,]    3    2</code></pre>
<div class="sourceCode" id="cb380"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb380-1"><a href="spatial-data.html#cb380-1"></a><span class="kw">st_multipoint</span>(mp.matrix)</span></code></pre></div>
<pre><code>## MULTIPOINT ((5 2), (1 3), (3 4), (3 2))</code></pre>
<div class="sourceCode" id="cb382"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb382-1"><a href="spatial-data.html#cb382-1"></a>ls.matrix &lt;-<span class="st"> </span><span class="kw">rbind</span>(<span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">5</span>), <span class="kw">c</span>(<span class="dv">4</span>, <span class="dv">4</span>), <span class="kw">c</span>(<span class="dv">4</span>, <span class="dv">1</span>), <span class="kw">c</span>(<span class="dv">2</span>, <span class="dv">2</span>), <span class="kw">c</span>(<span class="dv">3</span>, <span class="dv">2</span>))</span>
<span id="cb382-2"><a href="spatial-data.html#cb382-2"></a><span class="kw">st_linestring</span>(ls.matrix)</span></code></pre></div>
<pre><code>## LINESTRING (1 5, 4 4, 4 1, 2 2, 3 2)</code></pre>
<p>To create a polygon, we use lists.</p>
<div class="sourceCode" id="cb384"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb384-1"><a href="spatial-data.html#cb384-1"></a><span class="co">## POLYGON</span></span>
<span id="cb384-2"><a href="spatial-data.html#cb384-2"></a>poly.list &lt;-<span class="st"> </span><span class="kw">list</span>(<span class="kw">rbind</span>(<span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">5</span>), <span class="kw">c</span>(<span class="dv">2</span>, <span class="dv">2</span>), <span class="kw">c</span>(<span class="dv">4</span>, <span class="dv">1</span>), <span class="kw">c</span>(<span class="dv">4</span>, <span class="dv">4</span>), <span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">5</span>)))</span>
<span id="cb384-3"><a href="spatial-data.html#cb384-3"></a><span class="kw">st_polygon</span>(poly.list)</span></code></pre></div>
<pre><code>## POLYGON ((1 5, 2 2, 4 1, 4 4, 1 5))</code></pre>
<div class="sourceCode" id="cb386"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb386-1"><a href="spatial-data.html#cb386-1"></a><span class="co">## POLYGON with a hole</span></span>
<span id="cb386-2"><a href="spatial-data.html#cb386-2"></a>poly.border &lt;-<span class="st"> </span><span class="kw">rbind</span>(<span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">5</span>), <span class="kw">c</span>(<span class="dv">2</span>, <span class="dv">2</span>), <span class="kw">c</span>(<span class="dv">4</span>, <span class="dv">1</span>), <span class="kw">c</span>(<span class="dv">4</span>, <span class="dv">4</span>), <span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">5</span>))</span>
<span id="cb386-3"><a href="spatial-data.html#cb386-3"></a>poly.hole &lt;-<span class="st"> </span><span class="kw">rbind</span>(<span class="kw">c</span>(<span class="dv">2</span>, <span class="dv">4</span>), <span class="kw">c</span>(<span class="dv">3</span>, <span class="dv">4</span>), <span class="kw">c</span>(<span class="dv">3</span>, <span class="dv">3</span>), <span class="kw">c</span>(<span class="dv">2</span>, <span class="dv">3</span>), <span class="kw">c</span>(<span class="dv">2</span>, <span class="dv">4</span>))</span>
<span id="cb386-4"><a href="spatial-data.html#cb386-4"></a>poly.with.hole.list &lt;-<span class="st"> </span><span class="kw">list</span>(poly.border, poly.hole)</span>
<span id="cb386-5"><a href="spatial-data.html#cb386-5"></a><span class="kw">st_polygon</span>(poly.with.hole.list)</span></code></pre></div>
<pre><code>## POLYGON ((1 5, 2 2, 4 1, 4 4, 1 5), (2 4, 3 4, 3 3, 2 3, 2 4))</code></pre>
</div>
<div id="simple-feature-geometry-column" class="section level3" number="3.2.2">
<h3><span class="header-section-number">3.2.2</span> Simple feature geometry column</h3>
<p>One <code>sfg</code> object contains a single simple feature geometry. A simple feature geometry column (<code>sfc</code>) is a list of <code>sfg</code> objects together with information about the coordinate reference system.</p>
<p>For example, to combine two simple features into one object with two features, we use the <code>st_sfc()</code> function. This is important since <code>sfg</code> represents the geometry column in <code>sf</code> data frames.</p>
<div class="sourceCode" id="cb388"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb388-1"><a href="spatial-data.html#cb388-1"></a><span class="co"># sfc POINT</span></span>
<span id="cb388-2"><a href="spatial-data.html#cb388-2"></a>point1 &lt;-<span class="st"> </span><span class="kw">st_point</span>(<span class="kw">c</span>(<span class="dv">5</span>, <span class="dv">2</span>))</span>
<span id="cb388-3"><a href="spatial-data.html#cb388-3"></a>point2 &lt;-<span class="st"> </span><span class="kw">st_point</span>(<span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">3</span>))</span>
<span id="cb388-4"><a href="spatial-data.html#cb388-4"></a><span class="kw">st_sfc</span>(point1, point2)</span></code></pre></div>
<pre><code>## Geometry set for 2 features 
## geometry type:  POINT
## dimension:      XY
## bbox:           xmin: 1 ymin: 2 xmax: 5 ymax: 3
## CRS:            NA</code></pre>
<pre><code>## POINT (5 2)</code></pre>
<pre><code>## POINT (1 3)</code></pre>
<p>In most cases, a <code>sfc</code> object contains objects of the same geometry type. Thus, when we convert <code>sfg</code> objects of type <code>polygon</code> into a simple feature geometry column, we also end up with an <code>sfc</code> object of type <code>polygon</code>. Equally, a geometry column of multiple line strings would result in an <code>sfc</code> object of type <code>multilinestring</code>.</p>
<p>An example with polygons.</p>
<div class="sourceCode" id="cb392"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb392-1"><a href="spatial-data.html#cb392-1"></a>poly.list1 &lt;-<span class="st"> </span><span class="kw">list</span>(<span class="kw">rbind</span>(<span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">5</span>), <span class="kw">c</span>(<span class="dv">2</span>, <span class="dv">2</span>), <span class="kw">c</span>(<span class="dv">4</span>, <span class="dv">1</span>), <span class="kw">c</span>(<span class="dv">4</span>, <span class="dv">4</span>), <span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">5</span>)))</span>
<span id="cb392-2"><a href="spatial-data.html#cb392-2"></a>polygon1 &lt;-<span class="st"> </span><span class="kw">st_polygon</span>(poly.list)</span>
<span id="cb392-3"><a href="spatial-data.html#cb392-3"></a>poly.list2 &lt;-<span class="st"> </span><span class="kw">list</span>(<span class="kw">rbind</span>(<span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">2</span>), <span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">2</span>), <span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">3</span>), <span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">3</span>), <span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">2</span>)))</span>
<span id="cb392-4"><a href="spatial-data.html#cb392-4"></a>polygon2 &lt;-<span class="st"> </span><span class="kw">st_polygon</span>(poly.list2)</span>
<span id="cb392-5"><a href="spatial-data.html#cb392-5"></a><span class="kw">st_sfc</span>(polygon1, polygon2)</span></code></pre></div>
<pre><code>## Geometry set for 2 features 
## geometry type:  POLYGON
## dimension:      XY
## bbox:           xmin: 0 ymin: 1 xmax: 4 ymax: 5
## CRS:            NA</code></pre>
<pre><code>## POLYGON ((1 5, 2 2, 4 1, 4 4, 1 5))</code></pre>
<pre><code>## POLYGON ((0 2, 1 2, 1 3, 0 3, 0 2))</code></pre>
<p>An example with line strings.</p>
<div class="sourceCode" id="cb396"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb396-1"><a href="spatial-data.html#cb396-1"></a>mls.list1 &lt;-<span class="st"> </span><span class="kw">list</span>(<span class="kw">rbind</span>(<span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">5</span>), <span class="kw">c</span>(<span class="dv">4</span>, <span class="dv">4</span>), <span class="kw">c</span>(<span class="dv">4</span>, <span class="dv">1</span>), <span class="kw">c</span>(<span class="dv">2</span>, <span class="dv">2</span>), <span class="kw">c</span>(<span class="dv">3</span>, <span class="dv">2</span>)), </span>
<span id="cb396-2"><a href="spatial-data.html#cb396-2"></a>                  <span class="kw">rbind</span>(<span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">2</span>), <span class="kw">c</span>(<span class="dv">2</span>, <span class="dv">4</span>)))</span>
<span id="cb396-3"><a href="spatial-data.html#cb396-3"></a>mls1 &lt;-<span class="st"> </span><span class="kw">st_multilinestring</span>((mls.list1))</span>
<span id="cb396-4"><a href="spatial-data.html#cb396-4"></a>mls.list2 &lt;-<span class="st"> </span><span class="kw">list</span>(<span class="kw">rbind</span>(<span class="kw">c</span>(<span class="dv">2</span>, <span class="dv">9</span>), <span class="kw">c</span>(<span class="dv">7</span>, <span class="dv">9</span>), <span class="kw">c</span>(<span class="dv">5</span>, <span class="dv">6</span>), <span class="kw">c</span>(<span class="dv">4</span>, <span class="dv">7</span>), <span class="kw">c</span>(<span class="dv">2</span>, <span class="dv">7</span>)), </span>
<span id="cb396-5"><a href="spatial-data.html#cb396-5"></a>                  <span class="kw">rbind</span>(<span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">7</span>), <span class="kw">c</span>(<span class="dv">3</span>, <span class="dv">8</span>)))</span>
<span id="cb396-6"><a href="spatial-data.html#cb396-6"></a>mls2 &lt;-<span class="st"> </span><span class="kw">st_multilinestring</span>((mls.list2))</span>
<span id="cb396-7"><a href="spatial-data.html#cb396-7"></a><span class="kw">st_sfc</span>(mls1, mls2)</span></code></pre></div>
<pre><code>## Geometry set for 2 features 
## geometry type:  MULTILINESTRING
## dimension:      XY
## bbox:           xmin: 1 ymin: 1 xmax: 7 ymax: 9
## CRS:            NA</code></pre>
<pre><code>## MULTILINESTRING ((1 5, 4 4, 4 1, 2 2, 3 2), (1 ...</code></pre>
<pre><code>## MULTILINESTRING ((2 9, 7 9, 5 6, 4 7, 2 7), (1 ...</code></pre>
<p>An example with a geometry collection.</p>
<div class="sourceCode" id="cb400"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb400-1"><a href="spatial-data.html#cb400-1"></a><span class="kw">st_sfc</span>(point1, mls1)</span></code></pre></div>
<pre><code>## Geometry set for 2 features 
## geometry type:  GEOMETRY
## dimension:      XY
## bbox:           xmin: 1 ymin: 1 xmax: 5 ymax: 5
## CRS:            NA</code></pre>
<pre><code>## POINT (5 2)</code></pre>
<pre><code>## MULTILINESTRING ((1 5, 4 4, 4 1, 2 2, 3 2), (1 ...</code></pre>
<p>A <code>sfc</code> object stores information on the coordinate reference systems (CRS). To specify a certain CRS, we can use the <code>epsg</code> (SRID) or <code>proj4string</code> attributes. The default value of <code>epsg</code> (SRID) and <code>proj4string</code> is <code>NA</code> (Not Available).</p>
<div class="sourceCode" id="cb404"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb404-1"><a href="spatial-data.html#cb404-1"></a><span class="kw">st_sfc</span>(point1, point2)</span></code></pre></div>
<pre><code>## Geometry set for 2 features 
## geometry type:  POINT
## dimension:      XY
## bbox:           xmin: 1 ymin: 2 xmax: 5 ymax: 3
## CRS:            NA</code></pre>
<pre><code>## POINT (5 2)</code></pre>
<pre><code>## POINT (1 3)</code></pre>
<p>All geometries in an <code>sfc</code> object must have the same CRS.</p>
<p>We add coordinate reference system as a <code>crs =</code> argument in <code>st_sfc()</code>. The argument accepts either an integer with the epsg code (for example, 4326).</p>
<div class="sourceCode" id="cb408"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb408-1"><a href="spatial-data.html#cb408-1"></a><span class="kw">st_sfc</span>(point1, point2, </span>
<span id="cb408-2"><a href="spatial-data.html#cb408-2"></a>       <span class="dt">crs =</span> <span class="dv">4326</span>)</span></code></pre></div>
<pre><code>## Geometry set for 2 features 
## geometry type:  POINT
## dimension:      XY
## bbox:           xmin: 1 ymin: 2 xmax: 5 ymax: 3
## CRS:            EPSG:4326</code></pre>
<pre><code>## POINT (5 2)</code></pre>
<pre><code>## POINT (1 3)</code></pre>
<p>Or a <code>proj4string</code> character string (for example, <code>"+proj=longlat +datum=WGS84 +no_defs"</code>).</p>
<div class="sourceCode" id="cb412"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb412-1"><a href="spatial-data.html#cb412-1"></a><span class="kw">st_sfc</span>(point1, point2, </span>
<span id="cb412-2"><a href="spatial-data.html#cb412-2"></a>       <span class="dt">crs =</span> <span class="st">&quot;+proj=longlat +datum=WGS84 +no_defs&quot;</span>)</span></code></pre></div>
<pre><code>## Geometry set for 2 features 
## geometry type:  POINT
## dimension:      XY
## bbox:           xmin: 1 ymin: 2 xmax: 5 ymax: 3
## CRS:            +proj=longlat +datum=WGS84 +no_defs</code></pre>
<pre><code>## POINT (5 2)</code></pre>
<pre><code>## POINT (1 3)</code></pre>
<p>For example, we can set the UTM (Universal Transverse Mercator) Zone 11N projection with epsg code 2955.</p>
<div class="sourceCode" id="cb416"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb416-1"><a href="spatial-data.html#cb416-1"></a><span class="kw">st_sfc</span>(point1, point2, <span class="dt">crs =</span> <span class="dv">2955</span>)</span></code></pre></div>
<pre><code>## Geometry set for 2 features 
## geometry type:  POINT
## dimension:      XY
## bbox:           xmin: 1 ymin: 2 xmax: 5 ymax: 3
## CRS:            EPSG:2955</code></pre>
<pre><code>## POINT (5 2)</code></pre>
<pre><code>## POINT (1 3)</code></pre>
<p>The <code>proj4string</code> definition is automatically added. Now we set the CRS using proj4string:</p>
<div class="sourceCode" id="cb420"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb420-1"><a href="spatial-data.html#cb420-1"></a><span class="kw">st_sfc</span>(point1, point2, </span>
<span id="cb420-2"><a href="spatial-data.html#cb420-2"></a>       <span class="dt">crs =</span> <span class="st">&quot;+proj=utm +zone=11 +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +units=m +no_defs&quot;</span>)</span></code></pre></div>
<pre><code>## Geometry set for 2 features 
## geometry type:  POINT
## dimension:      XY
## bbox:           xmin: 1 ymin: 2 xmax: 5 ymax: 3
## CRS:            +proj=utm +zone=11 +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +units=m +no_defs</code></pre>
<pre><code>## POINT (5 2)</code></pre>
<pre><code>## POINT (1 3)</code></pre>
<p>In this case the epsg string remains empty demonstrating there is no general method to convert from proj4string to epsg.</p>
</div>
<div id="simple-feature-objects" class="section level3" number="3.2.3">
<h3><span class="header-section-number">3.2.3</span> Simple feature objects</h3>
<p>Features (geometries) often come with associated attributes. The attributes might represent the name of the geometry, measured values, groups to which the geometry belongs, etc.</p>
<p>For example, we measure a temperature of 10C at FSU on January 23, 2020. Thus, we have a specific point in space (the coordinates), the name of the location (FSU), a temperature value and the date of the measurement. Other attributes might include a urbanity category (campus or city), or a remark if the measurement was made with an automatic station.</p>
<p>The simple feature class, <code>sf</code>, is a combination of an attribute table (<code>data.frame</code>) and a simple feature geometry column (<code>sfc</code>). Simple features are created using the <code>st_sf()</code> function.</p>
<div class="sourceCode" id="cb424"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb424-1"><a href="spatial-data.html#cb424-1"></a><span class="co"># sfg objects</span></span>
<span id="cb424-2"><a href="spatial-data.html#cb424-2"></a>FSU.point &lt;-<span class="st"> </span><span class="kw">st_point</span>(<span class="kw">c</span>(<span class="op">-</span><span class="fl">84.29849</span>, <span class="fl">30.44188</span>))</span>
<span id="cb424-3"><a href="spatial-data.html#cb424-3"></a>TLH.point &lt;-<span class="st"> </span><span class="kw">st_point</span>(<span class="kw">c</span>(<span class="op">-</span><span class="fl">84.34505</span>, <span class="fl">30.39541</span>))</span>
<span id="cb424-4"><a href="spatial-data.html#cb424-4"></a></span>
<span id="cb424-5"><a href="spatial-data.html#cb424-5"></a><span class="co"># sfc object</span></span>
<span id="cb424-6"><a href="spatial-data.html#cb424-6"></a>our.geometry &lt;-<span class="st"> </span><span class="kw">st_sfc</span>(FSU.point, TLH.point, </span>
<span id="cb424-7"><a href="spatial-data.html#cb424-7"></a>                       <span class="dt">crs =</span> <span class="dv">4326</span>)</span>
<span id="cb424-8"><a href="spatial-data.html#cb424-8"></a></span>
<span id="cb424-9"><a href="spatial-data.html#cb424-9"></a><span class="co"># data.frame object</span></span>
<span id="cb424-10"><a href="spatial-data.html#cb424-10"></a>our.attributes &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">name =</span> <span class="kw">c</span>(<span class="st">&quot;FSU&quot;</span>, <span class="st">&quot;Airport&quot;</span>),</span>
<span id="cb424-11"><a href="spatial-data.html#cb424-11"></a>                             <span class="dt">temperature =</span> <span class="kw">c</span>(<span class="dv">10</span>, <span class="dv">5</span>),</span>
<span id="cb424-12"><a href="spatial-data.html#cb424-12"></a>                             <span class="dt">date =</span> <span class="kw">c</span>(<span class="kw">as.Date</span>(<span class="st">&quot;2020-01-23&quot;</span>), <span class="kw">as.Date</span>(<span class="st">&quot;2020-01-23&quot;</span>)),</span>
<span id="cb424-13"><a href="spatial-data.html#cb424-13"></a>                             <span class="dt">category =</span> <span class="kw">c</span>(<span class="st">&quot;campus&quot;</span>, <span class="st">&quot;airport&quot;</span>),</span>
<span id="cb424-14"><a href="spatial-data.html#cb424-14"></a>                             <span class="dt">automatic =</span> <span class="kw">c</span>(<span class="ot">TRUE</span>, <span class="ot">FALSE</span>))</span>
<span id="cb424-15"><a href="spatial-data.html#cb424-15"></a></span>
<span id="cb424-16"><a href="spatial-data.html#cb424-16"></a><span class="co"># sf object</span></span>
<span id="cb424-17"><a href="spatial-data.html#cb424-17"></a>sf.points &lt;-<span class="st"> </span><span class="kw">st_sf</span>(our.attributes, </span>
<span id="cb424-18"><a href="spatial-data.html#cb424-18"></a>                   <span class="dt">geometry =</span> our.geometry)</span></code></pre></div>
<p>The example illustrates the components of <code>sf</code> objects. First, coordinates define the geometry of the simple feature geometry (<code>sfg</code>). Second, we can combine the geometries into a simple feature geometry column (<code>sfc</code>) which also stores the CRS. Third, we store the attribute information on the geometries in a <code>data.frame</code>. Fourth, the <code>st_sf()</code> function combines the attribute table and the <code>sfc</code> object in an <code>sf</code> object.</p>
<div class="sourceCode" id="cb425"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb425-1"><a href="spatial-data.html#cb425-1"></a>sf.points</span></code></pre></div>
<pre><code>## Simple feature collection with 2 features and 5 fields
## geometry type:  POINT
## dimension:      XY
## bbox:           xmin: -84.34505 ymin: 30.39541 xmax: -84.29849 ymax: 30.44188
## CRS:            EPSG:4326
##      name temperature       date category automatic                   geometry
## 1     FSU          10 2020-01-23   campus      TRUE POINT (-84.29849 30.44188)
## 2 Airport           5 2020-01-23  airport     FALSE POINT (-84.34505 30.39541)</code></pre>
<div class="sourceCode" id="cb427"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb427-1"><a href="spatial-data.html#cb427-1"></a><span class="kw">class</span>(sf.points)</span></code></pre></div>
<pre><code>## [1] &quot;sf&quot;         &quot;data.frame&quot;</code></pre>
<p>Simple features have two classes, <code>sf</code> and <code>data.frame</code>. Simple features are data frames (square tables), but with spatial attributes (usually stored in a special <code>geom</code> list-column in the data frame).</p>
<p>This duality is central to the concept of simple features: most of the time a <code>sf</code> can be treated as, and behaves like, a <code>data.frame</code>. Simple features are, in essence, data frames with a spatial extension.</p>
<p>I refer to simple feature objects redundantly as ‘simple feature data frames’ to distinguish them from S4 class spatial data frames.</p>
<p>We create a <code>data.frame</code> with a geometry list-column but that is not of class <code>sf</code> using the <code>as.data.frame()</code> function.</p>
<div class="sourceCode" id="cb429"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb429-1"><a href="spatial-data.html#cb429-1"></a>df &lt;-<span class="st"> </span><span class="kw">as.data.frame</span>(sf.points)</span>
<span id="cb429-2"><a href="spatial-data.html#cb429-2"></a><span class="kw">class</span>(df)</span></code></pre></div>
<pre><code>## [1] &quot;data.frame&quot;</code></pre>
<p>In this case the <code>geometry</code> column is</p>
<ul>
<li>no longer a <code>sfc</code>.</li>
<li>no longer has a plot method, and</li>
<li>lacks all dedicated methods listed above for class <code>sf</code></li>
</ul>
</div>
<div id="your-turn" class="section level3" number="3.2.4">
<h3><span class="header-section-number">3.2.4</span> Your turn</h3>
<ol style="list-style-type: decimal">
<li>Create a simple feature data frame from the following information about the Joplin tornado that killed 158 people on May 22, 2011. Hint: use <code>st_linestring()</code> and <code>rbind()</code>.</li>
</ol>
<p>Start longitude = -94.5932
Start latitude = 37.0524
End longitude = -94.2213
End latitude = 36.9838
crs = geographic
number of fatalities = 158</p>
<ol start="2" style="list-style-type: decimal">
<li>The object <code>us_states</code> from the <strong>spData</strong> package is a simple feature data frame from the U.S. Census Bureau. The variables include the name, region, area, and population.</li>
</ol>
<p>A. Create a new data frame containing only the population information. (10)</p>
<div class="sourceCode" id="cb431"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb431-1"><a href="spatial-data.html#cb431-1"></a><span class="kw">library</span>(dplyr)</span>
<span id="cb431-2"><a href="spatial-data.html#cb431-2"></a><span class="kw">library</span>(spData)</span>
<span id="cb431-3"><a href="spatial-data.html#cb431-3"></a></span>
<span id="cb431-4"><a href="spatial-data.html#cb431-4"></a>df1 &lt;-<span class="st"> </span>us_states <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb431-5"><a href="spatial-data.html#cb431-5"></a><span class="st">  </span><span class="kw">select</span>(<span class="kw">starts_with</span>(<span class="st">&quot;total&quot;</span>)) </span>
<span id="cb431-6"><a href="spatial-data.html#cb431-6"></a><span class="kw">head</span>(df1)</span></code></pre></div>
<pre><code>## Simple feature collection with 6 features and 2 fields
## geometry type:  MULTIPOLYGON
## dimension:      XY
## bbox:           xmin: -114.8136 ymin: 24.55868 xmax: -71.78699 ymax: 42.04964
## CRS:            EPSG:4269
##   total_pop_10 total_pop_15                       geometry
## 1      4712651      4830620 MULTIPOLYGON (((-88.20006 3...
## 2      6246816      6641928 MULTIPOLYGON (((-114.7196 3...
## 3      4887061      5278906 MULTIPOLYGON (((-109.0501 4...
## 4      3545837      3593222 MULTIPOLYGON (((-73.48731 4...
## 5     18511620     19645772 MULTIPOLYGON (((-81.81169 2...
## 6      9468815     10006693 MULTIPOLYGON (((-85.60516 3...</code></pre>
<div class="sourceCode" id="cb433"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb433-1"><a href="spatial-data.html#cb433-1"></a><span class="co"># or</span></span>
<span id="cb433-2"><a href="spatial-data.html#cb433-2"></a></span>
<span id="cb433-3"><a href="spatial-data.html#cb433-3"></a>df1 &lt;-<span class="st"> </span>us_states <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb433-4"><a href="spatial-data.html#cb433-4"></a><span class="st">  </span><span class="kw">select</span>(total_pop_<span class="dv">10</span>, total_pop_<span class="dv">15</span>)</span></code></pre></div>
<p>B. Create a new data frame containing only states from the South region. (10)</p>
<div class="sourceCode" id="cb434"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb434-1"><a href="spatial-data.html#cb434-1"></a>df2 &lt;-<span class="st"> </span>us_states <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb434-2"><a href="spatial-data.html#cb434-2"></a><span class="st">  </span><span class="kw">filter</span>(REGION <span class="op">==</span><span class="st"> &quot;South&quot;</span>)</span>
<span id="cb434-3"><a href="spatial-data.html#cb434-3"></a><span class="kw">head</span>(df2)</span></code></pre></div>
<pre><code>## Simple feature collection with 6 features and 6 fields
## geometry type:  MULTIPOLYGON
## dimension:      XY
## bbox:           xmin: -103.0024 ymin: 24.55868 xmax: -78.54109 ymax: 37.0001
## CRS:            EPSG:4269
##   GEOID           NAME REGION             AREA total_pop_10 total_pop_15
## 1    01        Alabama  South 133709.27 [km^2]      4712651      4830620
## 2    12        Florida  South 151052.01 [km^2]     18511620     19645772
## 3    13        Georgia  South 152725.21 [km^2]      9468815     10006693
## 4    22      Louisiana  South 122345.76 [km^2]      4429940      4625253
## 5    40       Oklahoma  South 180971.40 [km^2]      3675339      3849733
## 6    45 South Carolina  South  80903.58 [km^2]      4511428      4777576
##                         geometry
## 1 MULTIPOLYGON (((-88.20006 3...
## 2 MULTIPOLYGON (((-81.81169 2...
## 3 MULTIPOLYGON (((-85.60516 3...
## 4 MULTIPOLYGON (((-92.01783 2...
## 5 MULTIPOLYGON (((-103.0022 3...
## 6 MULTIPOLYGON (((-83.10861 3...</code></pre>
<p>C. Create a new data frame containing only states from the West region having area less then 250,000 square km and a 2015 population more than 5,000,000 residents. Hint: you will need to use <code>as.numeric(AREA)</code> to remove the units. (10)</p>
<div class="sourceCode" id="cb436"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb436-1"><a href="spatial-data.html#cb436-1"></a>df3 &lt;-<span class="st"> </span>us_states <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb436-2"><a href="spatial-data.html#cb436-2"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">AREA =</span> <span class="kw">as.numeric</span>(AREA)) <span class="op">%&gt;%</span></span>
<span id="cb436-3"><a href="spatial-data.html#cb436-3"></a><span class="st">  </span><span class="kw">filter</span>(REGION <span class="op">==</span><span class="st"> &quot;West&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb436-4"><a href="spatial-data.html#cb436-4"></a><span class="st">  </span><span class="kw">filter</span>(AREA <span class="op">&gt;</span><span class="st"> </span><span class="dv">250000</span> <span class="op">&amp;</span><span class="st"> </span>total_pop_<span class="dv">15</span> <span class="op">&gt;</span><span class="st"> </span><span class="dv">5000000</span>)</span>
<span id="cb436-5"><a href="spatial-data.html#cb436-5"></a><span class="kw">head</span>(df3)</span></code></pre></div>
<pre><code>## Simple feature collection with 3 features and 6 fields
## geometry type:  MULTIPOLYGON
## dimension:      XY
## bbox:           xmin: -124.4096 ymin: 31.33224 xmax: -102.0422 ymax: 42.00952
## CRS:            EPSG:4269
##   GEOID       NAME REGION     AREA total_pop_10 total_pop_15
## 1    04    Arizona   West 295281.3      6246816      6641928
## 2    08   Colorado   West 269573.1      4887061      5278906
## 3    06 California   West 409747.1     36637290     38421464
##                         geometry
## 1 MULTIPOLYGON (((-114.7196 3...
## 2 MULTIPOLYGON (((-109.0501 4...
## 3 MULTIPOLYGON (((-118.6034 3...</code></pre>
<p>D. What was the total population of the Midwest region in 2010 and 2015? (20)</p>
<div class="sourceCode" id="cb438"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb438-1"><a href="spatial-data.html#cb438-1"></a>us_states <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb438-2"><a href="spatial-data.html#cb438-2"></a><span class="st">  </span><span class="kw">filter</span>(REGION <span class="op">==</span><span class="st"> &quot;Midwest&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb438-3"><a href="spatial-data.html#cb438-3"></a><span class="st">  </span><span class="kw">summarize</span>(<span class="dt">TotalPop2010 =</span> <span class="kw">sum</span>(total_pop_<span class="dv">10</span>),</span>
<span id="cb438-4"><a href="spatial-data.html#cb438-4"></a>            <span class="dt">TotalPop2015 =</span> <span class="kw">sum</span>(total_pop_<span class="dv">15</span>))</span></code></pre></div>
<pre><code>## Simple feature collection with 1 feature and 2 fields
## geometry type:  MULTIPOLYGON
## dimension:      XY
## bbox:           xmin: -104.0577 ymin: 35.99568 xmax: -80.51869 ymax: 49.38436
## CRS:            EPSG:4269
##   TotalPop2010 TotalPop2015                       geometry
## 1     66514091     67546398 MULTIPOLYGON (((-89.2552 47...</code></pre>
<p>E. How many states are in each region? (20)</p>
<div class="sourceCode" id="cb440"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb440-1"><a href="spatial-data.html#cb440-1"></a>us_states <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb440-2"><a href="spatial-data.html#cb440-2"></a><span class="st">  </span><span class="kw">group_by</span>(REGION) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb440-3"><a href="spatial-data.html#cb440-3"></a><span class="st">  </span><span class="kw">summarize</span>(<span class="dt">nS =</span> <span class="kw">n</span>())</span></code></pre></div>
<pre><code>## Simple feature collection with 4 features and 2 fields
## geometry type:  MULTIPOLYGON
## dimension:      XY
## bbox:           xmin: -124.7042 ymin: 24.55868 xmax: -66.9824 ymax: 49.38436
## CRS:            EPSG:4269
## # A tibble: 4 x 3
##   REGION      nS                                                        geometry
##   &lt;fct&gt;    &lt;int&gt;                                              &lt;MULTIPOLYGON [°]&gt;
## 1 Norteast     9 (((-68.9446 44.11284, -68.82507 44.18634, -68.77029 44.06957, …
## 2 Midwest     12 (((-89.2552 47.8761, -89.17915 47.93503, -88.83571 48.05675, -…
## 3 South       17 (((-81.81169 24.56874, -81.74565 24.65988, -81.44351 24.81336,…
## 4 West        11 (((-118.6055 33.031, -118.37 32.83927, -118.4963 32.85157, -11…</code></pre>
<p>F. Make a bar chart showing the total area in millions of square kilometers by region. Hint: include <code>stat = "identity"</code> in the <code>geom_bar()</code> function. (30)</p>
<div class="sourceCode" id="cb442"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb442-1"><a href="spatial-data.html#cb442-1"></a><span class="kw">library</span>(ggplot2)</span>
<span id="cb442-2"><a href="spatial-data.html#cb442-2"></a></span>
<span id="cb442-3"><a href="spatial-data.html#cb442-3"></a>us_states <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb442-4"><a href="spatial-data.html#cb442-4"></a><span class="st">  </span><span class="kw">group_by</span>(REGION) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb442-5"><a href="spatial-data.html#cb442-5"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">AREA =</span> <span class="kw">as.numeric</span>(AREA)<span class="op">/</span><span class="dv">10</span><span class="op">^</span><span class="dv">6</span>) <span class="op">%&gt;%</span></span>
<span id="cb442-6"><a href="spatial-data.html#cb442-6"></a><span class="st">  </span><span class="kw">summarize</span>(<span class="dt">totalArea =</span> <span class="kw">sum</span>(AREA)) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb442-7"><a href="spatial-data.html#cb442-7"></a><span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">y =</span> totalArea, <span class="dt">x =</span> REGION)) <span class="op">+</span><span class="st"> </span></span>
<span id="cb442-8"><a href="spatial-data.html#cb442-8"></a><span class="st">    </span><span class="kw">geom_bar</span>(<span class="dt">stat =</span> <span class="st">&quot;identity&quot;</span>) <span class="op">+</span><span class="st"> </span></span>
<span id="cb442-9"><a href="spatial-data.html#cb442-9"></a><span class="st">    </span><span class="kw">ylab</span>(<span class="st">&quot;Total Area (millions sq. km)&quot;</span>)</span></code></pre></div>
<p><img src="assfg-book_files/figure-html/unnamed-chunk-190-1.png" width="672" /></p>
<p>G. How much has population density changed between 2010 and 2015 in each state? Calculate the change (in percent relative to population in 2010) for each state. (5)</p>
<div class="sourceCode" id="cb443"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb443-1"><a href="spatial-data.html#cb443-1"></a>sfdf &lt;-<span class="st"> </span>us_states <span class="op">%&gt;%</span></span>
<span id="cb443-2"><a href="spatial-data.html#cb443-2"></a><span class="st">    </span><span class="kw">mutate</span>(<span class="dt">Change =</span> (total_pop_<span class="dv">15</span> <span class="op">-</span><span class="st"> </span>total_pop_<span class="dv">10</span>)<span class="op">/</span>total_pop_<span class="dv">10</span> <span class="op">*</span><span class="st"> </span><span class="dv">100</span>)</span>
<span id="cb443-3"><a href="spatial-data.html#cb443-3"></a><span class="kw">head</span>(sfdf)</span></code></pre></div>
<pre><code>## Simple feature collection with 6 features and 7 fields
## geometry type:  MULTIPOLYGON
## dimension:      XY
## bbox:           xmin: -114.8136 ymin: 24.55868 xmax: -71.78699 ymax: 42.04964
## CRS:            EPSG:4269
##   GEOID        NAME   REGION             AREA total_pop_10 total_pop_15
## 1    01     Alabama    South 133709.27 [km^2]      4712651      4830620
## 2    04     Arizona     West 295281.25 [km^2]      6246816      6641928
## 3    08    Colorado     West 269573.06 [km^2]      4887061      5278906
## 4    09 Connecticut Norteast  12976.59 [km^2]      3545837      3593222
## 5    12     Florida    South 151052.01 [km^2]     18511620     19645772
## 6    13     Georgia    South 152725.21 [km^2]      9468815     10006693
##                         geometry   Change
## 1 MULTIPOLYGON (((-88.20006 3... 2.503241
## 2 MULTIPOLYGON (((-114.7196 3... 6.325014
## 3 MULTIPOLYGON (((-109.0501 4... 8.018009
## 4 MULTIPOLYGON (((-73.48731 4... 1.336356
## 5 MULTIPOLYGON (((-81.81169 2... 6.126703
## 6 MULTIPOLYGON (((-85.60516 3... 5.680521</code></pre>
<p><a href="https://web.cvent.com/event/36ebe042-0113-44f1-8e36-b9bc5d0733bf/summary?RefId=conference&amp;utm_campaign=Site%20Promo&amp;utm_medium=Ste&amp;utm_source=ConfPage" class="uri">https://web.cvent.com/event/36ebe042-0113-44f1-8e36-b9bc5d0733bf/summary?RefId=conference&amp;utm_campaign=Site%20Promo&amp;utm_medium=Ste&amp;utm_source=ConfPage</a></p>
</div>
<div id="why-simple-features" class="section level3" number="3.2.5">
<h3><span class="header-section-number">3.2.5</span> Why simple features?</h3>
<p>Why use the <strong>sf</strong> package when <strong>sp</strong> is already tried and tested?</p>
<ul>
<li>Fast reading and writing of data</li>
<li>Enhanced plotting performance</li>
<li><code>sf</code> objects are treated as data frames in most operations</li>
<li><code>sf</code> functions are combined using <code>%&gt;%</code> operator and they work well with the <strong>tidyverse</strong> packages</li>
<li><code>sf</code> function names are consistent and intuitive (all begin with <code>st_</code>)</li>
</ul>
<p>These advantages have prompted the development of spatial packages (including <strong>tmap</strong>, <strong>mapview</strong>. and <strong>tidycensus</strong>) to add support for simple feature objects. However, it will take years for some packages to transition and some will sunset.</p>
<p>In our current workflow we can take advantage of simple features because it is easy to convert between the two classes. Consider the <code>world</code> S3 spatial data frame from the <strong>spData</strong> package. We convert it to a S4 spatial data frame with the <code>as()</code> method.</p>
<div class="sourceCode" id="cb445"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb445-1"><a href="spatial-data.html#cb445-1"></a><span class="kw">library</span>(sf)</span>
<span id="cb445-2"><a href="spatial-data.html#cb445-2"></a><span class="kw">library</span>(sp)</span>
<span id="cb445-3"><a href="spatial-data.html#cb445-3"></a><span class="kw">library</span>(spData)</span>
<span id="cb445-4"><a href="spatial-data.html#cb445-4"></a></span>
<span id="cb445-5"><a href="spatial-data.html#cb445-5"></a>world.sp &lt;-<span class="st"> </span><span class="kw">as</span>(world, </span>
<span id="cb445-6"><a href="spatial-data.html#cb445-6"></a>               <span class="dt">Class =</span> <span class="st">&quot;Spatial&quot;</span>)</span></code></pre></div>
<p>The method coerces simple features to <code>Spatial*</code> and <code>Spatial*DataFrame</code> objects.</p>
<p>We convert a S4 spatial data frame into a simple feature data frame with the <code>st_as_sf()</code> function.</p>
<div class="sourceCode" id="cb446"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb446-1"><a href="spatial-data.html#cb446-1"></a>world.sf &lt;-<span class="st"> </span><span class="kw">st_as_sf</span>(world.sp, <span class="st">&quot;sf&quot;</span>)</span></code></pre></div>
<p>We can create basic maps from simple feature data frames with the base <code>plot()</code> method (<code>plot.sf()</code>). The function creates a multi-panel one sub-plot for each variable.</p>
<p>As an example consider the ESRI shapefile containing police expenditure data from Mississippi. The data are on my Web site and are downloaded and imported as follows. Here we download the data as a zipped file, unzip it, import it with the <code>st_read()</code> function then assign a geographic coordinate reference system (CRS) to it using the EPSG number 4326.</p>
<div class="sourceCode" id="cb447"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb447-1"><a href="spatial-data.html#cb447-1"></a><span class="kw">download.file</span>(<span class="st">&quot;http://myweb.fsu.edu/jelsner/temp/data/police.zip&quot;</span>,</span>
<span id="cb447-2"><a href="spatial-data.html#cb447-2"></a>              <span class="st">&quot;police.zip&quot;</span>)</span>
<span id="cb447-3"><a href="spatial-data.html#cb447-3"></a><span class="kw">unzip</span>(<span class="st">&quot;police.zip&quot;</span>)</span>
<span id="cb447-4"><a href="spatial-data.html#cb447-4"></a></span>
<span id="cb447-5"><a href="spatial-data.html#cb447-5"></a>sfdf &lt;-<span class="st"> </span><span class="kw">st_read</span>(<span class="dt">dsn =</span> <span class="st">&quot;police&quot;</span>)</span></code></pre></div>
<pre><code>## Reading layer `police&#39; from data source `/Users/jelsner/Desktop/Projects/ASSFG-Book/police&#39; using driver `ESRI Shapefile&#39;
## Simple feature collection with 82 features and 21 fields
## geometry type:  POLYGON
## dimension:      XY
## bbox:           xmin: -91.64356 ymin: 30.19474 xmax: -88.09043 ymax: 35.00496
## CRS:            NA</code></pre>
<p>Create an S4 spatial object from the simple feature object, give it a geographic coordinate reference system (CRS), and then transform it to a Lambert conformal conic (LCC) projection.</p>
<div class="sourceCode" id="cb449"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb449-1"><a href="spatial-data.html#cb449-1"></a>spdf &lt;-<span class="st"> </span><span class="kw">as</span>(sfdf, <span class="st">&quot;Spatial&quot;</span>)</span>
<span id="cb449-2"><a href="spatial-data.html#cb449-2"></a><span class="kw">proj4string</span>(spdf) &lt;-<span class="st"> &quot;+proj=longlat +datum=WGS84 +ellps=WGS84&quot;</span></span>
<span id="cb449-3"><a href="spatial-data.html#cb449-3"></a></span>
<span id="cb449-4"><a href="spatial-data.html#cb449-4"></a>spdfP &lt;-<span class="st"> </span><span class="kw">spTransform</span>(spdf, </span>
<span id="cb449-5"><a href="spatial-data.html#cb449-5"></a>                     <span class="dt">CRS =</span> <span class="kw">CRS</span>(<span class="st">&quot;+proj=lcc +lat_1=60 +lat_2=30 +lon_0=-90 +units=km&quot;</span>))</span></code></pre></div>
<p>How do you choose what projection to use?</p>
<ol style="list-style-type: decimal">
<li>Check what government agencies are using for the area of interest</li>
<li>Google ‘best projection for [area]’</li>
<li>Default to state plane for US states or UTM zones for global areas</li>
</ol>
<p>Now compare the <code>plot()</code> method with the <code>spplot()</code> method.</p>
<div class="sourceCode" id="cb450"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb450-1"><a href="spatial-data.html#cb450-1"></a>sfdfP &lt;-<span class="st"> </span><span class="kw">st_as_sf</span>(spdfP, <span class="st">&quot;sf&quot;</span>)</span>
<span id="cb450-2"><a href="spatial-data.html#cb450-2"></a></span>
<span id="cb450-3"><a href="spatial-data.html#cb450-3"></a><span class="kw">plot</span>(sfdfP[<span class="st">&quot;WHITE&quot;</span>])</span></code></pre></div>
<p><img src="assfg-book_files/figure-html/unnamed-chunk-196-1.png" width="672" /></p>
<div class="sourceCode" id="cb451"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb451-1"><a href="spatial-data.html#cb451-1"></a><span class="kw">spplot</span>(spdfP[<span class="st">&quot;WHITE&quot;</span>])</span></code></pre></div>
<p><img src="assfg-book_files/figure-html/unnamed-chunk-196-2.png" width="672" /></p>
<p>Using the <code>world</code> simple feature data frame we can map country-level population.</p>
<div class="sourceCode" id="cb452"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb452-1"><a href="spatial-data.html#cb452-1"></a><span class="kw">plot</span>(world[<span class="st">&quot;pop&quot;</span>])</span></code></pre></div>
<p><img src="assfg-book_files/figure-html/unnamed-chunk-197-1.png" width="672" /></p>
<p>Or map the continents.</p>
<div class="sourceCode" id="cb453"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb453-1"><a href="spatial-data.html#cb453-1"></a><span class="kw">plot</span>(world[<span class="st">&quot;continent&quot;</span>])</span></code></pre></div>
<p><img src="assfg-book_files/figure-html/unnamed-chunk-198-1.png" width="672" /></p>
<p>More on making maps with spatial data frames later.</p>
</div>
</div>
<div id="geocomputation-on-simple-features" class="section level2" number="3.3">
<h2><span class="header-section-number">3.3</span> Geocomputation on simple features</h2>
<p>Geocomputations on simple features involve the geometry engine-open source (GEOS).</p>
<p>Let’s return to the Mississippi police data. Here we again download the data as a zipped file, unzip it, import it with the <code>st_read()</code> function then assign a geographic coordinate reference system (CRS) to it using the EPSG number 4326.</p>
<div class="sourceCode" id="cb454"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb454-1"><a href="spatial-data.html#cb454-1"></a><span class="kw">download.file</span>(<span class="dt">url =</span> <span class="st">&quot;http://myweb.fsu.edu/jelsner/temp/data/police.zip&quot;</span>,</span>
<span id="cb454-2"><a href="spatial-data.html#cb454-2"></a>              <span class="dt">destfile =</span> <span class="st">&quot;police.zip&quot;</span>)</span>
<span id="cb454-3"><a href="spatial-data.html#cb454-3"></a><span class="kw">unzip</span>(<span class="st">&quot;police.zip&quot;</span>)</span>
<span id="cb454-4"><a href="spatial-data.html#cb454-4"></a>sfdf &lt;-<span class="st"> </span><span class="kw">st_read</span>(<span class="dt">dsn =</span> <span class="st">&quot;police&quot;</span>, </span>
<span id="cb454-5"><a href="spatial-data.html#cb454-5"></a>                <span class="dt">layer =</span> <span class="st">&quot;police&quot;</span>)</span></code></pre></div>
<pre><code>## Reading layer `police&#39; from data source `/Users/jelsner/Desktop/Projects/ASSFG-Book/police&#39; using driver `ESRI Shapefile&#39;
## Simple feature collection with 82 features and 21 fields
## geometry type:  POLYGON
## dimension:      XY
## bbox:           xmin: -91.64356 ymin: 30.19474 xmax: -88.09043 ymax: 35.00496
## CRS:            NA</code></pre>
<div class="sourceCode" id="cb456"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb456-1"><a href="spatial-data.html#cb456-1"></a><span class="kw">st_crs</span>(sfdf) &lt;-<span class="st"> </span><span class="dv">4326</span></span></code></pre></div>
<p>As a quick check on the data we just imported we use <code>plot()</code> method. If the simple feature consists of <code>POLYGON</code> geometry the map will be a choropleth. To make small multiple choropleth maps of all the attributes we type</p>
<div class="sourceCode" id="cb457"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb457-1"><a href="spatial-data.html#cb457-1"></a><span class="kw">plot</span>(sfdf)</span></code></pre></div>
<pre><code>## Warning: plotting the first 10 out of 21 attributes; use max.plot = 21 to plot
## all</code></pre>
<p><img src="assfg-book_files/figure-html/unnamed-chunk-200-1.png" width="672" /></p>
<p>Each column variable gets plotted, which is may not be a good idea.</p>
<p>For geocomputations we should set the coordinate reference system including the spatial units. Here we transform the geographic coordinate reference system to a specific Lambert conic conformal (planar) projection with units of kilometers.</p>
<div class="sourceCode" id="cb459"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb459-1"><a href="spatial-data.html#cb459-1"></a>sfdf &lt;-<span class="st"> </span><span class="kw">st_transform</span>(sfdf, </span>
<span id="cb459-2"><a href="spatial-data.html#cb459-2"></a>                     <span class="dt">crs =</span> <span class="st">&quot;+proj=lcc +lat_1=60 +lat_2=30 +lon_0=-90 +units=km&quot;</span>)</span></code></pre></div>
<p>Then to obtain the bounding box of the geometries we use the <code>st_bbox()</code> function.</p>
<div class="sourceCode" id="cb460"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb460-1"><a href="spatial-data.html#cb460-1"></a>( box &lt;-<span class="st"> </span><span class="kw">st_bbox</span>(sfdf) )</span></code></pre></div>
<pre><code>##      xmin      ymin      xmax      ymax 
## -155.6854 3714.4452  171.4047 4244.1786</code></pre>
<p>It returns an object of class <code>bbox</code>, which is a numeric vector of length four, with elements labeled <code>xmin</code>, <code>ymin</code>, <code>xmax</code>, and <code>ymax</code>.</p>
<p>The function <code>st_as_sfc()</code> has methods for class <code>bbox</code> to generate a polygon around the four bounding box points. Here we apply this function then visualize it using the <code>plot()</code> method.</p>
<div class="sourceCode" id="cb462"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb462-1"><a href="spatial-data.html#cb462-1"></a>box.sf &lt;-<span class="st"> </span><span class="kw">st_as_sfc</span>(box)</span>
<span id="cb462-2"><a href="spatial-data.html#cb462-2"></a></span>
<span id="cb462-3"><a href="spatial-data.html#cb462-3"></a><span class="kw">plot</span>(box.sf)</span>
<span id="cb462-4"><a href="spatial-data.html#cb462-4"></a><span class="kw">plot</span>(sfdf<span class="op">$</span>geometry, <span class="dt">add =</span> <span class="ot">TRUE</span>)</span></code></pre></div>
<p><img src="assfg-book_files/figure-html/unnamed-chunk-203-1.png" width="672" /></p>
<p>The <code>st_centroid()</code> function computes the geometric center of the spatial objects. By default it does this for all geometries (recall that with the S4 objects we needed <code>byid = TRUE</code>).</p>
<div class="sourceCode" id="cb463"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb463-1"><a href="spatial-data.html#cb463-1"></a>centers.sfdf &lt;-<span class="st"> </span><span class="kw">st_centroid</span>(sfdf)</span></code></pre></div>
<pre><code>## Warning in st_centroid.sf(sfdf): st_centroid assumes attributes are constant
## over geometries of x</code></pre>
<p>The warning is to let you know that the attributes represent a geometry (e.g., areal aggregate) that might be misleading when representing the new geometry.</p>
<p>The object returned is of the same class as <code>sfdf</code> (<code>sf</code> and <code>data.frame</code>). But the geometry is changed from <code>POLYGON</code> to <code>POINT</code>.</p>
<div class="sourceCode" id="cb465"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb465-1"><a href="spatial-data.html#cb465-1"></a><span class="kw">class</span>(sfdf)</span></code></pre></div>
<pre><code>## [1] &quot;sf&quot;         &quot;data.frame&quot;</code></pre>
<div class="sourceCode" id="cb467"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb467-1"><a href="spatial-data.html#cb467-1"></a><span class="kw">class</span>(centers.sfdf)</span></code></pre></div>
<pre><code>## [1] &quot;sf&quot;         &quot;data.frame&quot;</code></pre>
<div class="sourceCode" id="cb469"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb469-1"><a href="spatial-data.html#cb469-1"></a><span class="kw">st_geometry</span>(sfdf)</span></code></pre></div>
<pre><code>## Geometry set for 82 features 
## geometry type:  POLYGON
## dimension:      XY
## bbox:           xmin: -155.6854 ymin: 3714.445 xmax: 171.4047 ymax: 4244.179
## CRS:            +proj=lcc +lat_1=60 +lat_2=30 +lon_0=-90 +units=km
## First 5 geometries:</code></pre>
<pre><code>## POLYGON ((148.0339 4217.534, 115.9827 4216.624,...</code></pre>
<pre><code>## POLYGON ((151.6224 4185.617, 151.3714 4215.633,...</code></pre>
<pre><code>## POLYGON ((114.8534 4199.729, 83.13839 4199.54, ...</code></pre>
<pre><code>## POLYGON ((68.64999 4197.903, 63.81829 4197.772,...</code></pre>
<pre><code>## POLYGON ((-18.16626 4212.457, -17.93877 4227.40...</code></pre>
<div class="sourceCode" id="cb476"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb476-1"><a href="spatial-data.html#cb476-1"></a><span class="kw">st_geometry</span>(centers.sfdf)</span></code></pre></div>
<pre><code>## Geometry set for 82 features 
## geometry type:  POINT
## dimension:      XY
## bbox:           xmin: -127.5055 ymin: 3739.791 xmax: 159.1725 ymax: 4230.765
## CRS:            +proj=lcc +lat_1=60 +lat_2=30 +lon_0=-90 +units=km
## First 5 geometries:</code></pre>
<pre><code>## POINT (128.435 4230.765)</code></pre>
<pre><code>## POINT (159.1725 4216.013)</code></pre>
<pre><code>## POINT (98.98771 4218.144)</code></pre>
<pre><code>## POINT (73.74245 4222.987)</code></pre>
<pre><code>## POINT (0.9219511 4228.915)</code></pre>
<p>The data frame portion of the simple feature data frame contains the exact same set and values of the attributes.</p>
<div class="sourceCode" id="cb483"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb483-1"><a href="spatial-data.html#cb483-1"></a><span class="kw">plot</span>(centers.sfdf)</span></code></pre></div>
<pre><code>## Warning: plotting the first 10 out of 21 attributes; use max.plot = 21 to plot
## all</code></pre>
<p><img src="assfg-book_files/figure-html/unnamed-chunk-206-1.png" width="672" /></p>
<p>To get the centroid for the state we first create a new simple feature as a union of all counties.</p>
<div class="sourceCode" id="cb485"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb485-1"><a href="spatial-data.html#cb485-1"></a>state.sf &lt;-<span class="st"> </span><span class="kw">st_union</span>(sfdf)</span>
<span id="cb485-2"><a href="spatial-data.html#cb485-2"></a><span class="kw">class</span>(state.sf)</span></code></pre></div>
<pre><code>## [1] &quot;sfc_POLYGON&quot; &quot;sfc&quot;</code></pre>
<p>The individual county geometries are joined and a single-geometry <code>sfc</code> object is returned. There is no attribute information associated with the new geometry.</p>
<p>Now we compute the centroid for the state.</p>
<div class="sourceCode" id="cb487"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb487-1"><a href="spatial-data.html#cb487-1"></a>center.sf &lt;-<span class="st"> </span><span class="kw">st_centroid</span>(state.sf)</span>
<span id="cb487-2"><a href="spatial-data.html#cb487-2"></a></span>
<span id="cb487-3"><a href="spatial-data.html#cb487-3"></a><span class="kw">plot</span>(sfdf<span class="op">$</span>geometry)</span>
<span id="cb487-4"><a href="spatial-data.html#cb487-4"></a><span class="kw">plot</span>(center.sf, <span class="dt">col =</span> <span class="st">&quot;red&quot;</span>, <span class="dt">add =</span> <span class="ot">TRUE</span>)</span></code></pre></div>
<p><img src="assfg-book_files/figure-html/unnamed-chunk-208-1.png" width="672" /></p>
<p>There is no weighting by attribute value.</p>
<p>Which county contains the geographic center of the state? Here we use the geometric binary predicate <code>st_contains()</code>.</p>
<div class="sourceCode" id="cb488"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb488-1"><a href="spatial-data.html#cb488-1"></a>( mat &lt;-<span class="st"> </span><span class="kw">st_contains</span>(sfdf, </span>
<span id="cb488-2"><a href="spatial-data.html#cb488-2"></a>                     center.sf,</span>
<span id="cb488-3"><a href="spatial-data.html#cb488-3"></a>                     <span class="dt">sparse =</span> <span class="ot">FALSE</span>) )</span></code></pre></div>
<pre><code>##        [,1]
##  [1,] FALSE
##  [2,] FALSE
##  [3,] FALSE
##  [4,] FALSE
##  [5,] FALSE
##  [6,] FALSE
##  [7,] FALSE
##  [8,] FALSE
##  [9,] FALSE
## [10,] FALSE
## [11,] FALSE
## [12,] FALSE
## [13,] FALSE
## [14,] FALSE
## [15,] FALSE
## [16,] FALSE
## [17,] FALSE
## [18,] FALSE
## [19,] FALSE
## [20,] FALSE
## [21,] FALSE
## [22,] FALSE
## [23,] FALSE
## [24,] FALSE
## [25,] FALSE
## [26,] FALSE
## [27,] FALSE
## [28,] FALSE
## [29,] FALSE
## [30,] FALSE
## [31,] FALSE
## [32,] FALSE
## [33,] FALSE
## [34,] FALSE
## [35,] FALSE
## [36,] FALSE
## [37,] FALSE
## [38,] FALSE
## [39,] FALSE
## [40,] FALSE
## [41,] FALSE
## [42,] FALSE
## [43,] FALSE
## [44,]  TRUE
## [45,] FALSE
## [46,] FALSE
## [47,] FALSE
## [48,] FALSE
## [49,] FALSE
## [50,] FALSE
## [51,] FALSE
## [52,] FALSE
## [53,] FALSE
## [54,] FALSE
## [55,] FALSE
## [56,] FALSE
## [57,] FALSE
## [58,] FALSE
## [59,] FALSE
## [60,] FALSE
## [61,] FALSE
## [62,] FALSE
## [63,] FALSE
## [64,] FALSE
## [65,] FALSE
## [66,] FALSE
## [67,] FALSE
## [68,] FALSE
## [69,] FALSE
## [70,] FALSE
## [71,] FALSE
## [72,] FALSE
## [73,] FALSE
## [74,] FALSE
## [75,] FALSE
## [76,] FALSE
## [77,] FALSE
## [78,] FALSE
## [79,] FALSE
## [80,] FALSE
## [81,] FALSE
## [82,] FALSE</code></pre>
<p>We add the <code>sparse = FALSE</code> argument so the result is a matrix containing TRUEs and FALSEs. Since there are 82 counties and one centroid the matrix has 82 rows and 1 column. All matrix entries are <code>FALSE</code> except one.</p>
<p>To see the result we first plot the county geometries, then add the county geometry for the center county and fill it red. Note that we use the matrix to subset this county. Finally we add the location of the state centroid to the plot.</p>
<div class="sourceCode" id="cb490"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb490-1"><a href="spatial-data.html#cb490-1"></a><span class="kw">plot</span>(sfdf<span class="op">$</span>geometry)</span>
<span id="cb490-2"><a href="spatial-data.html#cb490-2"></a><span class="kw">plot</span>(sfdf<span class="op">$</span>geometry[mat[, <span class="dv">1</span>]], <span class="dt">add =</span> <span class="ot">TRUE</span>, <span class="dt">col =</span> <span class="st">&quot;red&quot;</span>)</span>
<span id="cb490-3"><a href="spatial-data.html#cb490-3"></a><span class="kw">plot</span>(center.sf, <span class="dt">add =</span> <span class="ot">TRUE</span>, <span class="dt">pch =</span> <span class="dv">9</span>)</span></code></pre></div>
<p><img src="assfg-book_files/figure-html/unnamed-chunk-210-1.png" width="672" /></p>
<p>The function <code>st_area()</code> returns a vector of the geographical area (in sq. units) of the spatial object.</p>
<div class="sourceCode" id="cb491"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb491-1"><a href="spatial-data.html#cb491-1"></a><span class="kw">st_area</span>(sfdf)</span></code></pre></div>
<pre><code>## Units: [km^2]
##  [1] 1022.408 1090.591 1137.026 1026.594 1247.334 1774.160 1168.702 1014.817
##  [9] 1045.083 1075.178 1732.531 1814.067 1489.805 1144.795 1014.629 1343.209
## [17] 1258.023 1266.125 1640.093 1493.901 2258.517 1944.140 1281.794 1771.483
## [25] 1132.148 1524.599 1033.107 1278.218 1073.463 1542.853 1025.853 1164.588
## [33] 1916.674 1049.683 1956.687 1100.144 1887.804 1767.370 1566.158 1136.158
## [41] 2360.048 1112.094 1459.652 1465.834 1910.487 1855.831 1537.387 1622.768
## [49] 2008.926 1789.925 1453.268 2253.060 1768.755 1769.137 1599.931 1234.292
## [57] 1540.603 2020.813 2000.772 1347.462 1834.503 1052.482 1058.725 1103.387
## [65] 1193.226 1475.083 1432.711 1384.481 1271.563 1213.841 1679.382 1780.714
## [73] 1793.521 1936.154 1057.054 1053.063 2138.092 1196.466 1170.242 1826.622
## [81] 1526.969 1234.167</code></pre>
<p>Units are given along with a vector of the area values.</p>
<p>There is an attribute called <code>AREA</code> in the data frame but it is better to calculate it from the spatial geometries because we are sure of the units.</p>
<p>What happens when we apply the area function on the centroid object?</p>
<div class="sourceCode" id="cb493"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb493-1"><a href="spatial-data.html#cb493-1"></a><span class="kw">st_area</span>(centers.sfdf)</span></code></pre></div>
<pre><code>## Units: [km^2]
##  [1] 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0
## [39] 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0
## [77] 0 0 0 0 0 0</code></pre>
<p>Compute a 100 km buffer around the state and show the result with a plot.</p>
<div class="sourceCode" id="cb495"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb495-1"><a href="spatial-data.html#cb495-1"></a><span class="kw">plot</span>(<span class="kw">st_buffer</span>(state.sf, <span class="dt">dist =</span> <span class="dv">100</span>))</span>
<span id="cb495-2"><a href="spatial-data.html#cb495-2"></a><span class="kw">plot</span>(state.sf, <span class="dt">add =</span> <span class="ot">TRUE</span>)</span></code></pre></div>
<p><img src="assfg-book_files/figure-html/unnamed-chunk-213-1.png" width="672" /></p>
<div id="attribute-manipulation" class="section level3" number="3.3.1">
<h3><span class="header-section-number">3.3.1</span> Attribute manipulation</h3>
<p>The <strong>sf</strong> package provides methods that allow <code>sf</code> objects to behave like regular data frames (see <a href="https://geocompr.robinlovelace.net/attr.html" class="uri">https://geocompr.robinlovelace.net/attr.html</a>).</p>
<div class="sourceCode" id="cb496"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb496-1"><a href="spatial-data.html#cb496-1"></a><span class="kw">methods</span>(<span class="dt">class =</span> <span class="st">&quot;sf&quot;</span>)</span></code></pre></div>
<pre><code>##  [1] [                     [[&lt;-                  $&lt;-                  
##  [4] aggregate             anti_join             arrange              
##  [7] as.data.frame         cbind                 coerce               
## [10] dbDataType            dbWriteTable          distinct             
## [13] filter                full_join             gather               
## [16] group_by              group_split           identify             
## [19] initialize            inner_join            left_join            
## [22] merge                 mutate                nest                 
## [25] plot                  print                 rbind                
## [28] rename                right_join            sample_frac          
## [31] sample_n              select                semi_join            
## [34] separate_rows         separate              show                 
## [37] slice                 slotsFromS3           spread               
## [40] st_agr                st_agr&lt;-              st_area              
## [43] st_as_sf              st_bbox               st_boundary          
## [46] st_buffer             st_cast               st_centroid          
## [49] st_collection_extract st_convex_hull        st_coordinates       
## [52] st_crop               st_crs                st_crs&lt;-             
## [55] st_difference         st_filter             st_geometry          
## [58] st_geometry&lt;-         st_interpolate_aw     st_intersection      
## [61] st_intersects         st_is_valid           st_is                
## [64] st_join               st_line_merge         st_m_range           
## [67] st_make_valid         st_nearest_points     st_node              
## [70] st_normalize          st_point_on_surface   st_polygonize        
## [73] st_precision          st_reverse            st_sample            
## [76] st_segmentize         st_set_precision      st_shift_longitude   
## [79] st_simplify           st_snap               st_sym_difference    
## [82] st_transform          st_triangulate        st_union             
## [85] st_voronoi            st_wrap_dateline      st_write             
## [88] st_z_range            st_zm                 summarise            
## [91] transform             transmute             ungroup              
## [94] unite                 unnest               
## see &#39;?methods&#39; for accessing help and source code</code></pre>
<p>Many of these functions were developed for data frames including <code>rbind()</code> (for binding rows of data together) and <code>$</code> (for creating new columns). The key feature of <code>sf</code> objects is that they store spatial and non-spatial data in the same way, as columns in a <code>data.frame</code>.</p>
<p>The geometry column of <strong>sf</strong> objects is typically called <code>geometry</code> but any name can be used. This allows geometries with any name to be used.</p>
<p>The following command, for example, creates a geometry column named <code>g</code>.</p>
<div class="sourceCode" id="cb498"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb498-1"><a href="spatial-data.html#cb498-1"></a><span class="kw">st_sf</span>(<span class="kw">data.frame</span>(<span class="dt">n =</span> world<span class="op">$</span>name_long), </span>
<span id="cb498-2"><a href="spatial-data.html#cb498-2"></a>      <span class="dt">g =</span> world<span class="op">$</span>geom)</span></code></pre></div>
<pre><code>## Simple feature collection with 177 features and 1 field
## geometry type:  MULTIPOLYGON
## dimension:      XY
## bbox:           xmin: -180 ymin: -90 xmax: 180 ymax: 83.64513
## CRS:            EPSG:4326
## First 10 features:
##                   n                              g
## 1              Fiji MULTIPOLYGON (((180 -16.067...
## 2          Tanzania MULTIPOLYGON (((33.90371 -0...
## 3    Western Sahara MULTIPOLYGON (((-8.66559 27...
## 4            Canada MULTIPOLYGON (((-122.84 49,...
## 5     United States MULTIPOLYGON (((-122.84 49,...
## 6        Kazakhstan MULTIPOLYGON (((87.35997 49...
## 7        Uzbekistan MULTIPOLYGON (((55.96819 41...
## 8  Papua New Guinea MULTIPOLYGON (((141.0002 -2...
## 9         Indonesia MULTIPOLYGON (((141.0002 -2...
## 10        Argentina MULTIPOLYGON (((-68.63401 -...</code></pre>
<p>Thus <code>sf</code> objects take advantage of R’s data analysis capabilities to be used on geographic data. It’s worth reviewing how to discover basic properties of vector data objects.</p>
<p>For example, we get information about the size and breadth of the <code>world</code> simple feature data frame from the <strong>spData</strong> package using <code>dim()</code>, <code>nrow()</code>, etc.</p>
<div class="sourceCode" id="cb500"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb500-1"><a href="spatial-data.html#cb500-1"></a><span class="kw">dim</span>(world)</span></code></pre></div>
<pre><code>## [1] 177  11</code></pre>
<div class="sourceCode" id="cb502"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb502-1"><a href="spatial-data.html#cb502-1"></a><span class="kw">nrow</span>(world)</span></code></pre></div>
<pre><code>## [1] 177</code></pre>
<div class="sourceCode" id="cb504"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb504-1"><a href="spatial-data.html#cb504-1"></a><span class="kw">ncol</span>(world)</span></code></pre></div>
<pre><code>## [1] 11</code></pre>
<p>The data contains ten non-geographic columns (and one geometry list-column) with almost 200 rows representing the world’s countries.</p>
<p>Extracting the attribute data from an <code>sf</code> object is the same as removing its geometry.</p>
<div class="sourceCode" id="cb506"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb506-1"><a href="spatial-data.html#cb506-1"></a>world_df &lt;-<span class="st"> </span><span class="kw">st_set_geometry</span>(world, <span class="ot">NULL</span>)</span>
<span id="cb506-2"><a href="spatial-data.html#cb506-2"></a><span class="kw">class</span>(world_df)</span></code></pre></div>
<pre><code>## [1] &quot;tbl_df&quot;     &quot;tbl&quot;        &quot;data.frame&quot;</code></pre>
<p>Recall attributes are the variables (stored as columns) in a spatial data frame.</p>
<p>There is no harm in keeping the geometry column because data operations on <code>sf</code> objects only change an object’s geometry when appropriate (e.g. by dissolving borders between adjacent polygons following aggregation). This means that the speed of operations with attribute data in <code>sf</code> objects is the same as with columns in a data frames.</p>
<div id="attribute-subsetting" class="section level4" number="3.3.1.1">
<h4><span class="header-section-number">3.3.1.1</span> Attribute subsetting</h4>
<p>Subset functions include <code>[</code>, <code>subset()</code> and <code>$</code>. <strong>dplyr</strong> subset functions include <code>select()</code>, <code>filter()</code>, and <code>pull()</code>. Both sets of functions preserve the spatial components of attribute data in <code>sf</code> objects.</p>
<p>The <code>[</code> operator can subset rows and columns. We use indices to specify the elements we wish to extract from an object, e.g. object[i, j], with i and j typically being numbers representing rows and columns. Leaving i or j empty returns all rows or columns, so <code>world[1:5, ]</code> returns the first five rows and all columns. Here are some examples.</p>
<div class="sourceCode" id="cb508"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb508-1"><a href="spatial-data.html#cb508-1"></a>world[<span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">5</span>, <span class="dv">9</span>), ] <span class="co"># subset rows by position</span></span></code></pre></div>
<pre><code>## Simple feature collection with 3 features and 10 fields
## geometry type:  MULTIPOLYGON
## dimension:      XY
## bbox:           xmin: -180 ymin: -18.28799 xmax: 180 ymax: 71.35776
## CRS:            EPSG:4326
## # A tibble: 3 x 11
##   iso_a2 name_long continent region_un subregion type  area_km2    pop lifeExp
##   &lt;chr&gt;  &lt;chr&gt;     &lt;chr&gt;     &lt;chr&gt;     &lt;chr&gt;     &lt;chr&gt;    &lt;dbl&gt;  &lt;dbl&gt;   &lt;dbl&gt;
## 1 FJ     Fiji      Oceania   Oceania   Melanesia Sove…   19290. 8.86e5    70.0
## 2 US     United S… North Am… Americas  Northern… Coun… 9510744. 3.19e8    78.8
## 3 ID     Indonesia Asia      Asia      South-Ea… Sove… 1819251. 2.55e8    68.9
## # … with 2 more variables: gdpPercap &lt;dbl&gt;, geom &lt;MULTIPOLYGON [°]&gt;</code></pre>
<div class="sourceCode" id="cb510"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb510-1"><a href="spatial-data.html#cb510-1"></a>world[, <span class="dv">1</span><span class="op">:</span><span class="dv">3</span>] <span class="co"># subset columns by position</span></span></code></pre></div>
<pre><code>## Simple feature collection with 177 features and 3 fields
## geometry type:  MULTIPOLYGON
## dimension:      XY
## bbox:           xmin: -180 ymin: -90 xmax: 180 ymax: 83.64513
## CRS:            EPSG:4326
## # A tibble: 177 x 4
##    iso_a2 name_long    continent                                            geom
##    &lt;chr&gt;  &lt;chr&gt;        &lt;chr&gt;                                  &lt;MULTIPOLYGON [°]&gt;
##  1 FJ     Fiji         Oceania     (((180 -16.06713, 180 -16.55522, 179.3641 -1…
##  2 TZ     Tanzania     Africa      (((33.90371 -0.95, 34.07262 -1.05982, 37.698…
##  3 EH     Western Sah… Africa      (((-8.66559 27.65643, -8.665124 27.58948, -8…
##  4 CA     Canada       North Amer… (((-122.84 49, -122.9742 49.00254, -124.9102…
##  5 US     United Stat… North Amer… (((-122.84 49, -120 49, -117.0312 49, -116.0…
##  6 KZ     Kazakhstan   Asia        (((87.35997 49.21498, 86.59878 48.54918, 85.…
##  7 UZ     Uzbekistan   Asia        (((55.96819 41.30864, 55.92892 44.99586, 58.…
##  8 PG     Papua New G… Oceania     (((141.0002 -2.600151, 142.7352 -3.289153, 1…
##  9 ID     Indonesia    Asia        (((141.0002 -2.600151, 141.0171 -5.859022, 1…
## 10 AR     Argentina    South Amer… (((-68.63401 -52.63637, -68.25 -53.1, -67.75…
## # … with 167 more rows</code></pre>
<div class="sourceCode" id="cb512"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb512-1"><a href="spatial-data.html#cb512-1"></a>world[, <span class="kw">c</span>(<span class="st">&quot;name_long&quot;</span>, <span class="st">&quot;lifeExp&quot;</span>)] <span class="co"># subset columns by name</span></span></code></pre></div>
<pre><code>## Simple feature collection with 177 features and 2 fields
## geometry type:  MULTIPOLYGON
## dimension:      XY
## bbox:           xmin: -180 ymin: -90 xmax: 180 ymax: 83.64513
## CRS:            EPSG:4326
## # A tibble: 177 x 3
##    name_long      lifeExp                                                   geom
##    &lt;chr&gt;            &lt;dbl&gt;                                     &lt;MULTIPOLYGON [°]&gt;
##  1 Fiji              70.0 (((180 -16.06713, 180 -16.55522, 179.3641 -16.80135, …
##  2 Tanzania          64.2 (((33.90371 -0.95, 34.07262 -1.05982, 37.69869 -3.096…
##  3 Western Sahara    NA   (((-8.66559 27.65643, -8.665124 27.58948, -8.6844 27.…
##  4 Canada            82.0 (((-122.84 49, -122.9742 49.00254, -124.9102 49.98456…
##  5 United States     78.8 (((-122.84 49, -120 49, -117.0312 49, -116.0482 49, -…
##  6 Kazakhstan        71.6 (((87.35997 49.21498, 86.59878 48.54918, 85.76823 48.…
##  7 Uzbekistan        71.0 (((55.96819 41.30864, 55.92892 44.99586, 58.50313 45.…
##  8 Papua New Gui…    65.2 (((141.0002 -2.600151, 142.7352 -3.289153, 144.584 -3…
##  9 Indonesia         68.9 (((141.0002 -2.600151, 141.0171 -5.859022, 141.0339 -…
## 10 Argentina         76.3 (((-68.63401 -52.63637, -68.25 -53.1, -67.75 -53.85, …
## # … with 167 more rows</code></pre>
<p>Here we use logical vectors for subsetting. First we create a logical vector <code>sel_area</code></p>
<div class="sourceCode" id="cb514"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb514-1"><a href="spatial-data.html#cb514-1"></a>sel_area &lt;-<span class="st"> </span>world<span class="op">$</span>area_km2 <span class="op">&lt;</span><span class="st"> </span><span class="dv">10000</span></span>
<span id="cb514-2"><a href="spatial-data.html#cb514-2"></a><span class="kw">head</span>(sel_area)</span></code></pre></div>
<pre><code>## [1] FALSE FALSE FALSE FALSE FALSE FALSE</code></pre>
<div class="sourceCode" id="cb516"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb516-1"><a href="spatial-data.html#cb516-1"></a><span class="kw">summary</span>(sel_area)</span></code></pre></div>
<pre><code>##    Mode   FALSE    TRUE 
## logical     170       7</code></pre>
<p>And then we select only cases from the <code>world</code> simple feature dsta frame where the elements of the <code>sel_area</code> vector are <code>TRUE</code>.</p>
<div class="sourceCode" id="cb518"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb518-1"><a href="spatial-data.html#cb518-1"></a>small_countries &lt;-<span class="st"> </span>world[sel_area, ]</span></code></pre></div>
<p>This creates a new simple feature data frame, <code>small_countries</code>, containing nations whose surface area is smaller than 10,000 sq km.</p>
<p>The base R function <code>subset()</code> provides another way to get the same result.</p>
<div class="sourceCode" id="cb519"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb519-1"><a href="spatial-data.html#cb519-1"></a>small_countries &lt;-<span class="st"> </span><span class="kw">subset</span>(world, area_km2 <span class="op">&lt;</span><span class="st"> </span><span class="dv">10000</span>)</span></code></pre></div>
<p>Importantly the <strong>dplyr</strong> verbs can also be used on <strong>sf</strong> objects. The main <strong>dplyr</strong> subsetting functions are <code>select()</code> and <code>filter()</code>.</p>
<p>But caution! The <strong>dplyr</strong> (and <strong>raster</strong>) package has a function called <code>select()</code>. When using both packages, the function in the most recently attached package will be used, ‘masking’ the incumbent function.</p>
<p>This can generate error messages containing text like: unable to find an inherited method for function ‘select’ for signature “sf”. To avoid this error message, and prevent ambiguity, we use the long-form function name, prefixed by the package name and two colons <code>dplyr::select()</code>.</p>
<p>The <code>select()</code> function selects columns by name or position. For example, we can select only two columns, <code>name_long</code> and <code>pop</code>, with the following command.</p>
<div class="sourceCode" id="cb520"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb520-1"><a href="spatial-data.html#cb520-1"></a>world1 &lt;-<span class="st"> </span>world <span class="op">%&gt;%</span></span>
<span id="cb520-2"><a href="spatial-data.html#cb520-2"></a><span class="st">  </span><span class="kw">select</span>(name_long, pop)</span>
<span id="cb520-3"><a href="spatial-data.html#cb520-3"></a><span class="kw">names</span>(world1)</span></code></pre></div>
<pre><code>## [1] &quot;name_long&quot; &quot;pop&quot;       &quot;geom&quot;</code></pre>
<p>Note that the result is a simple feature data frame with the geometry column.</p>
<p>The <code>select()</code> function lets us subset and rename columns at the same time.</p>
<div class="sourceCode" id="cb522"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb522-1"><a href="spatial-data.html#cb522-1"></a>world2 &lt;-<span class="st"> </span><span class="kw">select</span>(world, </span>
<span id="cb522-2"><a href="spatial-data.html#cb522-2"></a>                 name_long, </span>
<span id="cb522-3"><a href="spatial-data.html#cb522-3"></a>                 <span class="dt">population =</span> pop)</span>
<span id="cb522-4"><a href="spatial-data.html#cb522-4"></a>world2 &lt;-<span class="st"> </span>world <span class="op">%&gt;%</span></span>
<span id="cb522-5"><a href="spatial-data.html#cb522-5"></a><span class="st">  </span><span class="kw">select</span>(name_long,</span>
<span id="cb522-6"><a href="spatial-data.html#cb522-6"></a>         <span class="dt">population =</span> pop)</span>
<span id="cb522-7"><a href="spatial-data.html#cb522-7"></a><span class="kw">names</span>(world2)</span></code></pre></div>
<pre><code>## [1] &quot;name_long&quot;  &quot;population&quot; &quot;geom&quot;</code></pre>
<p>The <code>pull()</code> function will return a single vector.</p>
<div class="sourceCode" id="cb524"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb524-1"><a href="spatial-data.html#cb524-1"></a>population &lt;-<span class="st"> </span>world <span class="op">%&gt;%</span></span>
<span id="cb524-2"><a href="spatial-data.html#cb524-2"></a><span class="st">  </span><span class="kw">pull</span>(pop)</span>
<span id="cb524-3"><a href="spatial-data.html#cb524-3"></a><span class="kw">head</span>(population)</span></code></pre></div>
<pre><code>## [1]    885806  52234869        NA  35535348 318622525  17288285</code></pre>
<p>The <code>filter()</code> function is <strong>dplyr</strong>’s equivalent of base R <code>subset()</code> function. It keeps only rows matching given criteria, e.g., only countries with a very high average life expectancy.</p>
<div class="sourceCode" id="cb526"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb526-1"><a href="spatial-data.html#cb526-1"></a>world3 &lt;-<span class="st"> </span>world <span class="op">%&gt;%</span></span>
<span id="cb526-2"><a href="spatial-data.html#cb526-2"></a><span class="st">  </span><span class="kw">filter</span>(lifeExp <span class="op">&gt;</span><span class="st"> </span><span class="dv">82</span>)</span>
<span id="cb526-3"><a href="spatial-data.html#cb526-3"></a><span class="kw">head</span>(world3)</span></code></pre></div>
<pre><code>## Simple feature collection with 6 features and 10 fields
## geometry type:  MULTIPOLYGON
## dimension:      XY
## bbox:           xmin: -9.392884 ymin: -43.6346 xmax: 153.5695 ymax: 69.10625
## CRS:            EPSG:4326
## # A tibble: 6 x 11
##   iso_a2 name_long continent region_un subregion type  area_km2    pop lifeExp
##   &lt;chr&gt;  &lt;chr&gt;     &lt;chr&gt;     &lt;chr&gt;     &lt;chr&gt;     &lt;chr&gt;    &lt;dbl&gt;  &lt;dbl&gt;   &lt;dbl&gt;
## 1 IL     Israel    Asia      Asia      Western … Coun…   22991. 8.22e6    82.2
## 2 SE     Sweden    Europe    Europe    Northern… Sove…  450582. 9.70e6    82.3
## 3 CH     Switzerl… Europe    Europe    Western … Sove…   46185. 8.19e6    83.2
## 4 LU     Luxembou… Europe    Europe    Western … Sove…    2417. 5.56e5    82.2
## 5 ES     Spain     Europe    Europe    Southern… Sove…  502306. 4.65e7    83.2
## 6 AU     Australia Oceania   Oceania   Australi… Coun… 7687614. 2.35e7    82.3
## # … with 2 more variables: gdpPercap &lt;dbl&gt;, geom &lt;MULTIPOLYGON [°]&gt;</code></pre>
</div>
<div id="attribute-aggregation" class="section level4" number="3.3.1.2">
<h4><span class="header-section-number">3.3.1.2</span> Attribute aggregation</h4>
<p>Aggregation summarize datasets by a grouping variable, typically an attribute column. An example of attribute aggregation is calculating the number of people per continent based on country-level data (one row per country).</p>
<p>The <code>world</code> dataset contains the necessary ingredients: the columns <code>pop</code> and <code>continent</code>, the population and the grouping variable, respectively. The goal is to find the <code>sum()</code> of country populations for each continent.</p>
<p>This is done with the <code>group_by()</code> and <code>summarize()</code> functions from the <strong>dplyr</strong> package.</p>
<div class="sourceCode" id="cb528"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb528-1"><a href="spatial-data.html#cb528-1"></a><span class="kw">library</span>(dplyr)</span>
<span id="cb528-2"><a href="spatial-data.html#cb528-2"></a></span>
<span id="cb528-3"><a href="spatial-data.html#cb528-3"></a>world_agg &lt;-<span class="st"> </span>world <span class="op">%&gt;%</span></span>
<span id="cb528-4"><a href="spatial-data.html#cb528-4"></a><span class="st">  </span><span class="kw">group_by</span>(continent) <span class="op">%&gt;%</span></span>
<span id="cb528-5"><a href="spatial-data.html#cb528-5"></a><span class="st">  </span><span class="kw">summarize</span>(<span class="dt">pop =</span> <span class="kw">sum</span>(pop, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>))</span>
<span id="cb528-6"><a href="spatial-data.html#cb528-6"></a><span class="kw">head</span>(world_agg)</span></code></pre></div>
<pre><code>## Simple feature collection with 6 features and 2 fields
## geometry type:  MULTIPOLYGON
## dimension:      XY
## bbox:           xmin: -180 ymin: -90 xmax: 180 ymax: 83.64513
## CRS:            EPSG:4326
## # A tibble: 6 x 3
##   continent         pop                                                     geom
##   &lt;chr&gt;           &lt;dbl&gt;                                       &lt;MULTIPOLYGON [°]&gt;
## 1 Africa         1.15e9 (((49.54352 -12.46983, 49.80898 -12.89528, 50.05651 -13…
## 2 Antarctica     0.     (((-48.66062 -78.04702, -48.1514 -78.04707, -46.66286 -…
## 3 Asia           4.31e9 (((120.295 -10.25865, 118.9678 -9.557969, 119.9003 -9.3…
## 4 Europe         6.69e8 (((-51.6578 4.156232, -52.24934 3.241094, -52.55642 2.5…
## 5 North Ameri…   5.65e8 (((-61.68 10.76, -61.105 10.89, -60.895 10.855, -60.935…
## 6 Oceania        3.78e7 (((169.6678 -43.55533, 170.5249 -43.03169, 171.1251 -42…</code></pre>
<p>This approach gives us control over the new column names. For example to calculate the Earth’s population and the number of countries type</p>
<div class="sourceCode" id="cb530"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb530-1"><a href="spatial-data.html#cb530-1"></a>world <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb530-2"><a href="spatial-data.html#cb530-2"></a><span class="st">  </span><span class="kw">summarize</span>(<span class="dt">pop =</span> <span class="kw">sum</span>(pop, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>),</span>
<span id="cb530-3"><a href="spatial-data.html#cb530-3"></a>            <span class="dt">nC =</span> <span class="kw">n</span>())</span></code></pre></div>
<pre><code>## Simple feature collection with 1 feature and 2 fields
## geometry type:  MULTIPOLYGON
## dimension:      XY
## bbox:           xmin: -180 ymin: -90 xmax: 180 ymax: 83.64513
## CRS:            EPSG:4326
## # A tibble: 1 x 3
##         pop    nC                                                           geom
##       &lt;dbl&gt; &lt;int&gt;                                             &lt;MULTIPOLYGON [°]&gt;
## 1    7.15e9   177 (((-163.7129 -78.59567, -163.7129 -78.59567, -163.1058 -78.22…</code></pre>
<p>The two columns in the resulting attribute table are <code>pop</code> and <code>nC</code>. The functions <code>sum()</code> and <code>n()</code> were the aggregating functions.</p>
<p>The result is an <code>sf</code> object with a single row representing the world (this works thanks to the geometric operation called ‘union’).</p>
<p>We can chain together functions to find the world’s three most populous continents and the number of countries they contain.</p>
<div class="sourceCode" id="cb532"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb532-1"><a href="spatial-data.html#cb532-1"></a>world <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb532-2"><a href="spatial-data.html#cb532-2"></a><span class="st">  </span><span class="kw">select</span>(pop, continent) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb532-3"><a href="spatial-data.html#cb532-3"></a><span class="st">  </span><span class="kw">group_by</span>(continent) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb532-4"><a href="spatial-data.html#cb532-4"></a><span class="st">  </span><span class="kw">summarize</span>(<span class="dt">pop =</span> <span class="kw">sum</span>(pop, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>), </span>
<span id="cb532-5"><a href="spatial-data.html#cb532-5"></a>            <span class="dt">nC =</span> <span class="kw">n</span>()) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb532-6"><a href="spatial-data.html#cb532-6"></a><span class="st">  </span><span class="kw">top_n</span>(<span class="dt">n =</span> <span class="dv">3</span>, <span class="dt">wt =</span> pop) <span class="op">%&gt;%</span></span>
<span id="cb532-7"><a href="spatial-data.html#cb532-7"></a><span class="st">  </span><span class="kw">st_set_geometry</span>(<span class="dt">value =</span> <span class="ot">NULL</span>) </span></code></pre></div>
<pre><code>## # A tibble: 3 x 3
##   continent        pop    nC
## * &lt;chr&gt;          &lt;dbl&gt; &lt;int&gt;
## 1 Africa    1154946633    51
## 2 Asia      4311408059    47
## 3 Europe     669036256    39</code></pre>
</div>
<div id="attribute-joining" class="section level4" number="3.3.1.3">
<h4><span class="header-section-number">3.3.1.3</span> Attribute joining</h4>
<p>Combining data from different sources based on a shared ‘key’ variable is common. The <strong>dplyr</strong> package has multiple join functions including <code>left_join()</code> and <code>inner_join()</code>. Names follow conventions used in the SQL database language.</p>
<p>Here we see how to join non-spatial datasets to <code>sf</code> objects. Join functions work the same on <code>data.frames</code> and <code>sf</code> objects. The most common type of attribute join on spatial data takes an <code>sf</code> object as the first argument and adds columns to it from a <code>data.frame</code> specified as the second argument.</p>
<p>For example, we combine data on coffee production with the world dataset. The coffee data is in a data frame called <code>coffee_data</code> from the <strong>spData</strong> package (see <code>?coffee_data</code> for details). It has 3 columns: <code>name_long</code> names major coffee-producing nations and <code>coffee_production_2016</code> and <code>coffee_production_2017</code> contain estimated values for coffee production in units of 60-kg bags in each year.</p>
<p>The <code>left_join()</code> function, which preserves the first dataset, merges <code>world</code> with <code>coffee_data</code>.</p>
<div class="sourceCode" id="cb534"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb534-1"><a href="spatial-data.html#cb534-1"></a>world_coffee &lt;-<span class="st"> </span><span class="kw">left_join</span>(world, </span>
<span id="cb534-2"><a href="spatial-data.html#cb534-2"></a>                          coffee_data)</span></code></pre></div>
<pre><code>## Joining, by = &quot;name_long&quot;</code></pre>
<div class="sourceCode" id="cb536"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb536-1"><a href="spatial-data.html#cb536-1"></a><span class="kw">class</span>(world_coffee)</span></code></pre></div>
<pre><code>## [1] &quot;sf&quot;         &quot;tbl_df&quot;     &quot;tbl&quot;        &quot;data.frame&quot;</code></pre>
<p>Because the input data frames share a variable (<code>name_long</code>) the join works without using the <code>by =</code> argument (see <code>?left_join</code> for details). The result is an <code>sf</code> object identical to the original world object but with two new variables (with column indices 11 and 12) on coffee production.</p>
<div class="sourceCode" id="cb538"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb538-1"><a href="spatial-data.html#cb538-1"></a><span class="kw">names</span>(world_coffee)</span></code></pre></div>
<pre><code>##  [1] &quot;iso_a2&quot;                 &quot;name_long&quot;              &quot;continent&quot;             
##  [4] &quot;region_un&quot;              &quot;subregion&quot;              &quot;type&quot;                  
##  [7] &quot;area_km2&quot;               &quot;pop&quot;                    &quot;lifeExp&quot;               
## [10] &quot;gdpPercap&quot;              &quot;geom&quot;                   &quot;coffee_production_2016&quot;
## [13] &quot;coffee_production_2017&quot;</code></pre>
<p>For joining to work, a ‘key’ variable must be supplied in both datasets.</p>
<p>Another feature of <code>left_join()</code> is that the results have the same number of rows as the first dataset. Although there are only 47 rows of data in <code>coffee_data</code>, all 177 the country records in <code>world</code> are kept intact in <code>world_coffee</code> (and <code>world_coffee2</code>). Rows in the first dataset with no match are assigned <code>NA</code> values for the new coffee production variables.</p>
<p>If we want to keep only countries that have a match in the key variable then we use <code>inner_join()</code>.</p>
<div class="sourceCode" id="cb540"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb540-1"><a href="spatial-data.html#cb540-1"></a>world_coffee_inner &lt;-<span class="st"> </span><span class="kw">inner_join</span>(world, </span>
<span id="cb540-2"><a href="spatial-data.html#cb540-2"></a>                                 coffee_data)</span></code></pre></div>
<pre><code>## Joining, by = &quot;name_long&quot;</code></pre>
<div class="sourceCode" id="cb542"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb542-1"><a href="spatial-data.html#cb542-1"></a><span class="kw">nrow</span>(world_coffee_inner)</span></code></pre></div>
<pre><code>## [1] 45</code></pre>
<p>Note that the result of <code>inner_join()</code> has only 45 rows compared with 47 in coffee_data. What happened to the other two rows? We can identify the rows that did not match using the <code>setdiff()</code> function.</p>
<div class="sourceCode" id="cb544"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb544-1"><a href="spatial-data.html#cb544-1"></a><span class="kw">setdiff</span>(coffee_data<span class="op">$</span>name_long, world<span class="op">$</span>name_long)</span></code></pre></div>
<pre><code>## [1] &quot;Congo, Dem. Rep. of&quot; &quot;Others&quot;</code></pre>
<p><code>Others</code> accounts for one row not present in the <code>world_coffee</code> dataset and name of the Democratic Republic of the Congo accounts for the other. The name has been abbreviated, causing the join to miss it.</p>
<p>Here we use the <code>str_subset()</code> function (string matching) from the <strong>stringr</strong> package to confirm what ‘Congo, Dem. Rep.’ of should be.</p>
<div class="sourceCode" id="cb546"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb546-1"><a href="spatial-data.html#cb546-1"></a><span class="kw">library</span>(stringr)</span>
<span id="cb546-2"><a href="spatial-data.html#cb546-2"></a><span class="kw">str_subset</span>(world<span class="op">$</span>name_long, <span class="st">&quot;Dem*.+Congo&quot;</span>)</span></code></pre></div>
<pre><code>## [1] &quot;Democratic Republic of the Congo&quot;</code></pre>
<p>To fix this issue, we will create a new version of <code>coffee_data</code> and update the name. Note: <code>grepl()</code> returns a logical vector for names that contain ‘Congo’.</p>
<div class="sourceCode" id="cb548"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb548-1"><a href="spatial-data.html#cb548-1"></a>coffee_data<span class="op">$</span>name_long[<span class="kw">grepl</span>(<span class="st">&quot;Congo&quot;</span>, coffee_data<span class="op">$</span>name_long)] &lt;-<span class="st"> </span><span class="kw">str_subset</span>(world<span class="op">$</span>name_long, <span class="st">&quot;Dem*.+Congo&quot;</span>)</span>
<span id="cb548-2"><a href="spatial-data.html#cb548-2"></a>world_coffee_match &lt;-<span class="st"> </span><span class="kw">inner_join</span>(world, coffee_data)</span></code></pre></div>
<pre><code>## Joining, by = &quot;name_long&quot;</code></pre>
<div class="sourceCode" id="cb550"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb550-1"><a href="spatial-data.html#cb550-1"></a><span class="kw">nrow</span>(world_coffee_match)</span></code></pre></div>
<pre><code>## [1] 46</code></pre>
<p>It is also possible to join in the other direction: starting with a regular data frame and adding variables from a simple features object.</p>
<p>Often, we would like to create a new column based on already existing columns. For example, we want to calculate population density for each country. For this we need to divide a population column, here <code>pop</code>, by an area column, here <code>area_km2</code> with unit area in square kilometers.</p>
<p>We use one of the verbs - <code>mutate()</code> or <code>transmute()</code>. <code>mutate()</code> adds new columns in the <code>sf</code> object (the last one is reserved for the geometry).</p>
<div class="sourceCode" id="cb552"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb552-1"><a href="spatial-data.html#cb552-1"></a>world <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb552-2"><a href="spatial-data.html#cb552-2"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">pop_dens =</span> pop <span class="op">/</span><span class="st"> </span>area_km2)</span></code></pre></div>
<pre><code>## Simple feature collection with 177 features and 11 fields
## geometry type:  MULTIPOLYGON
## dimension:      XY
## bbox:           xmin: -180 ymin: -90 xmax: 180 ymax: 83.64513
## CRS:            EPSG:4326
## # A tibble: 177 x 12
##    iso_a2 name_long continent region_un subregion type  area_km2     pop lifeExp
##  * &lt;chr&gt;  &lt;chr&gt;     &lt;chr&gt;     &lt;chr&gt;     &lt;chr&gt;     &lt;chr&gt;    &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;
##  1 FJ     Fiji      Oceania   Oceania   Melanesia Sove…   1.93e4  8.86e5    70.0
##  2 TZ     Tanzania  Africa    Africa    Eastern … Sove…   9.33e5  5.22e7    64.2
##  3 EH     Western … Africa    Africa    Northern… Inde…   9.63e4 NA         NA  
##  4 CA     Canada    North Am… Americas  Northern… Sove…   1.00e7  3.55e7    82.0
##  5 US     United S… North Am… Americas  Northern… Coun…   9.51e6  3.19e8    78.8
##  6 KZ     Kazakhst… Asia      Asia      Central … Sove…   2.73e6  1.73e7    71.6
##  7 UZ     Uzbekist… Asia      Asia      Central … Sove…   4.61e5  3.08e7    71.0
##  8 PG     Papua Ne… Oceania   Oceania   Melanesia Sove…   4.65e5  7.76e6    65.2
##  9 ID     Indonesia Asia      Asia      South-Ea… Sove…   1.82e6  2.55e8    68.9
## 10 AR     Argentina South Am… Americas  South Am… Sove…   2.78e6  4.30e7    76.3
## # … with 167 more rows, and 3 more variables: gdpPercap &lt;dbl&gt;,
## #   geom &lt;MULTIPOLYGON [°]&gt;, pop_dens &lt;dbl&gt;</code></pre>
<p>The difference between <code>mutate()</code> and <code>transmute()</code> is that the latter skips all other existing columns (except for the sticky geometry column):</p>
<p>More information: <a href="https://geocompr.robinlovelace.net/attr.html" class="uri">https://geocompr.robinlovelace.net/attr.html</a></p>
</div>
</div>
<div id="areal-weighted-interpolation" class="section level3" number="3.3.2">
<h3><span class="header-section-number">3.3.2</span> Areal weighted interpolation</h3>
<p>Areal weighted interpolation estimates the value of some attribute from a set of polygons to an overlapping but incongruent set of target polygons. For example, suppose we want demographic information given at the Census tract level to be estimated within the tornado damage path.</p>
<p>Obviously tornado damage paths do not align with census tract boundaries, so areal interpolation is used to produce population estimates at the tornado level.</p>
<p>Two function prefixes are available in the <strong>areal</strong> package that allow users to take advantage of RStudio’s auto complete.</p>
<ul>
<li><code>ar_</code> - data and functions that are used for multiple interpolation methods</li>
<li><code>aw_</code> - functions that are used specifically for areal weighted interpolation</li>
</ul>
<div class="sourceCode" id="cb554"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb554-1"><a href="spatial-data.html#cb554-1"></a><span class="kw">library</span>(areal)</span></code></pre></div>
<p>The package contains four overlapping data sets.</p>
<div class="sourceCode" id="cb555"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb555-1"><a href="spatial-data.html#cb555-1"></a><span class="kw">data</span>(<span class="dt">package =</span> <span class="st">&quot;areal&quot;</span>)</span></code></pre></div>
<ul>
<li><code>ar_stl_race</code> (2017 ACS demographic counts at the census tract level; n = 106)</li>
<li><code>ar_stl_asthma</code> (2017 asthma rates at the census tract level; n = 106)</li>
<li><code>ar_stl_wards</code> (the 2010 political subdivisions in St. Louis; n = 28).</li>
<li><code>ar_stl_wardsClipped</code> Clipped (the 2010 political subdivisions in St. Louis clipped to the Mississippi River shoreline; n = 28).</li>
</ul>
<p>Functions in the <strong>areal</strong> package assume that data are simple feature data frames.</p>
<p>A projected coordinate reference system is recommend. All data must be projected using the same system. Unnecessary columns should be removed prior to projection.</p>
<p>Areal weighted interpolation makes a single (significant) assumption about the data. Populations are evenly distributed within the source data.</p>
<p>Imagine a census tract with 3,000 residents. Areal weighted interpolation assumes that these 3,000 residents are evenly spread through out the tract.</p>
<p>This assumption is not likely to be valid in general (e.g., tracts with large parks or dense housing developments alongside commercial buildings).</p>
<p>The interpolation is done with the <code>aw_interpolate()</code> function.</p>
<div id="example-population-given-at-tract-level-interpolated-to-the-ward-level" class="section level4" number="3.3.2.1">
<h4><span class="header-section-number">3.3.2.1</span> Example: Population given at tract level interpolated to the ward level</h4>
<p>The number of people within each Census tract is known. But suppose we want the number of people in each ward. Wards are overlapping but incongruent polygons relative to the tracts.</p>
<p>The simple feature data frame <code>ar_stl_wards</code> contains a vector of unique ward numbers (<code>WARD</code>) and a list of unique <code>POLYGON</code> geometry features.</p>
<div class="sourceCode" id="cb556"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb556-1"><a href="spatial-data.html#cb556-1"></a><span class="kw">glimpse</span>(ar_stl_wards)</span></code></pre></div>
<pre><code>## Rows: 28
## Columns: 4
## $ OBJECTID &lt;dbl&gt; 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 1…
## $ WARD     &lt;int&gt; 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 1…
## $ AREA     &lt;dbl&gt; 46138761, 267817711, 66291644, 53210707, 60462396, 64337271,…
## $ geometry &lt;POLYGON [m]&gt; POLYGON ((740184.2 4286431,..., POLYGON ((742392.1 4…</code></pre>
<p>The simple feature data frame <code>ar_stl_race</code> contains a vector of unique idenfiers (<code>GEOID</code>), a vector of total population <code>TOTAL_E</code>, and a list of unique <code>POLYGON</code> geometry features.</p>
<div class="sourceCode" id="cb558"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb558-1"><a href="spatial-data.html#cb558-1"></a><span class="kw">glimpse</span>(ar_stl_race)</span></code></pre></div>
<pre><code>## Rows: 106
## Columns: 24
## $ GEOID     &lt;chr&gt; &quot;29510112100&quot;, &quot;29510116500&quot;, &quot;29510110300&quot;, &quot;29510103700&quot;,…
## $ STATEFP   &lt;chr&gt; &quot;29&quot;, &quot;29&quot;, &quot;29&quot;, &quot;29&quot;, &quot;29&quot;, &quot;29&quot;, &quot;29&quot;, &quot;29&quot;, &quot;29&quot;, &quot;29&quot;,…
## $ COUNTYFP  &lt;chr&gt; &quot;510&quot;, &quot;510&quot;, &quot;510&quot;, &quot;510&quot;, &quot;510&quot;, &quot;510&quot;, &quot;510&quot;, &quot;510&quot;, &quot;51…
## $ TRACTCE   &lt;chr&gt; &quot;112100&quot;, &quot;116500&quot;, &quot;110300&quot;, &quot;103700&quot;, &quot;103800&quot;, &quot;104500&quot;,…
## $ NAMELSAD  &lt;chr&gt; &quot;Census Tract 1121&quot;, &quot;Census Tract 1165&quot;, &quot;Census Tract 110…
## $ ALAND     &lt;dbl&gt; 6936664, 904024, 938287, 910953, 1640334, 1939712, 962321, …
## $ AWATER    &lt;dbl&gt; 0, 0, 0, 0, 35369, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
## $ TOTAL_E   &lt;dbl&gt; 4253, 4590, 1936, 2406, 3856, 1990, 1826, 2819, 2981, 2796,…
## $ TOTAL_M   &lt;dbl&gt; 468, 525, 360, 215, 242, 225, 285, 488, 308, 408, 279, 227,…
## $ WHITE_E   &lt;dbl&gt; 2827, 2194, 47, 2184, 3383, 1487, 32, 67, 1098, 289, 471, 2…
## $ WHITE_M   &lt;dbl&gt; 378, 411, 40, 255, 269, 195, 25, 56, 215, 198, 233, 229, 14…
## $ BLACK_E   &lt;dbl&gt; 1147, 1885, 1889, 122, 300, 162, 1787, 2713, 1528, 2401, 17…
## $ BLACK_M   &lt;dbl&gt; 393, 414, 361, 117, 208, 125, 281, 493, 221, 388, 251, 86, …
## $ AIAN_E    &lt;dbl&gt; 0, 0, 0, 0, 0, 1, 0, 0, 39, 0, 0, 9, 0, 13, 0, 6, 6, 0, 0, …
## $ AIAN_M    &lt;dbl&gt; 11, 11, 11, 11, 11, 3, 11, 11, 60, 11, 11, 14, 11, 19, 11, …
## $ ASIAN_E   &lt;dbl&gt; 179, 279, 0, 48, 62, 280, 0, 24, 196, 40, 0, 217, 12, 305, …
## $ ASIAN_M   &lt;dbl&gt; 86, 172, 11, 55, 60, 132, 11, 28, 98, 36, 11, 105, 13, 95, …
## $ NHPI_E    &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 7, 0, 0, 0, 5, 16, 0, 0, 0, 0, 0, 0, 0, 0…
## $ NHPI_M    &lt;dbl&gt; 11, 11, 11, 11, 11, 11, 13, 11, 11, 11, 7, 23, 11, 11, 11, …
## $ OTHER_E   &lt;dbl&gt; 15, 59, 0, 0, 77, 0, 0, 0, 0, 0, 90, 31, 11, 13, 0, 0, 3, 0…
## $ OTHER_M   &lt;dbl&gt; 23, 67, 11, 11, 120, 11, 11, 11, 11, 11, 72, 36, 12, 21, 11…
## $ TWOPLUS_E &lt;dbl&gt; 85, 173, 0, 52, 34, 60, 0, 15, 120, 66, 122, 55, 49, 36, 59…
## $ TWOPLUS_M &lt;dbl&gt; 68, 126, 11, 49, 38, 39, 11, 33, 97, 96, 86, 50, 68, 42, 71…
## $ geometry  &lt;POLYGON [m]&gt; POLYGON ((734633.3 4279479,..., POLYGON ((740098.5 …</code></pre>
<p>Analogy: The cookie cutters are the simple feature polygons defining the boundaries we want values interpolated to. This is defined as the target object which is the first argument in the <code>aw_interpolate()</code> function. We need to identify each cookie cutter with a unique target id (<code>tid</code>).</p>
<p>The dough is the underlying simple feature variable that we want interpolated. It is defined in a source simple feature data frame (<code>source =</code>). Each feature must have a unique id (<code>sid</code>). The variable to be interpolated is specified in the <code>extensive =</code> argument.</p>
<p>Here the cookie cutters are the ward <code>POLYGON</code>s and the tract-level population (<code>TOTAL_E</code>) is the dough.</p>
<p>Finally, to ensure that all individuals within each tract are allocated out to wards we use <code>weight = "sum"</code>.</p>
<div class="sourceCode" id="cb560"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb560-1"><a href="spatial-data.html#cb560-1"></a><span class="kw">aw_interpolate</span>(ar_stl_wards, </span>
<span id="cb560-2"><a href="spatial-data.html#cb560-2"></a>               <span class="dt">tid =</span> WARD, </span>
<span id="cb560-3"><a href="spatial-data.html#cb560-3"></a>               <span class="dt">source =</span> ar_stl_race, </span>
<span id="cb560-4"><a href="spatial-data.html#cb560-4"></a>               <span class="dt">sid =</span> <span class="st">&quot;GEOID&quot;</span>,</span>
<span id="cb560-5"><a href="spatial-data.html#cb560-5"></a>               <span class="dt">extensive =</span> <span class="st">&quot;TOTAL_E&quot;</span>,</span>
<span id="cb560-6"><a href="spatial-data.html#cb560-6"></a>               <span class="dt">weight =</span> <span class="st">&quot;sum&quot;</span>,</span>
<span id="cb560-7"><a href="spatial-data.html#cb560-7"></a>               <span class="dt">output =</span> <span class="st">&quot;sf&quot;</span>)</span></code></pre></div>
<pre><code>## Simple feature collection with 28 features and 4 fields
## geometry type:  POLYGON
## dimension:      XY
## bbox:           xmin: 733361.8 ymin: 4268336 xmax: 746157.7 ymax: 4295504
## CRS:            EPSG:26915
## First 10 features:
##    OBJECTID WARD      AREA   TOTAL_E                       geometry
## 1         1    1  46138761  7991.565 POLYGON ((740184.2 4286431,...
## 2         2    2 267817711 12145.021 POLYGON ((742392.1 4289178,...
## 3         3    3  66291644  7344.287 POLYGON ((742956.1 4284113,...
## 4         4    4  53210707  8457.672 POLYGON ((739557.6 4284080,...
## 5         5    5  60462396  8783.377 POLYGON ((744883.8 4281632,...
## 6         6    6  64337271 14050.399 POLYGON ((742501.6 4279976,...
## 7         7    7 101268146 15840.086 POLYGON ((745618.6 4279867,...
## 8         8    8  45966410 12188.131 POLYGON ((739842.8 4277724,...
## 9         9    9  73993891 14217.149 POLYGON ((742619.4 4276734,...
## 10       10   10  62915358 11239.213 POLYGON ((737257.7 4277050,...</code></pre>
<p>The function is capable of interpolating extensive and intensive variables.</p>
<p>Intensive variable: Variable that is independent of the spatial units (e.g., population density, percentages); variable that has been normalized in some fashion.</p>
<p>Extensive variable: Data dependent on the spatial units (e.g., population totals).</p>
<p>If the variable is intensive then use <code>intensive =</code> instead of <code>extensive =</code> to specify the variable to be interpolated.</p>
<p>Options are documented in both the function documentation (use <code>?aw_interpolate</code>) as well as in a dedicated vignette.</p>
</div>
<div id="estimate-total-residential-population-under-each-tornado-path-during-2014" class="section level4" number="3.3.2.2">
<h4><span class="header-section-number">3.3.2.2</span> Estimate total residential population under each tornado path during 2014</h4>
<p>Here we are interested in the total (residential) population under each tornado occurring in Florida during 2014. We begin by creating a polygon geometry for each tornado record.</p>
<p>Import the data. There are two files each with the exact set of tornadoes but with different geometries. The <code>..-aspath.zip</code> has <code>LINE</code> geometry indicating the straight line track.</p>
<div class="sourceCode" id="cb562"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb562-1"><a href="spatial-data.html#cb562-1"></a>sfdfL &lt;-<span class="st"> </span><span class="kw">st_read</span>(<span class="dt">dsn =</span> <span class="st">&quot;1950-2018-torn-aspath&quot;</span>) <span class="op">%&gt;%</span></span>
<span id="cb562-2"><a href="spatial-data.html#cb562-2"></a><span class="st">  </span><span class="kw">filter</span>(yr <span class="op">==</span><span class="st"> </span><span class="dv">2014</span>, st <span class="op">==</span><span class="st"> &quot;FL&quot;</span>)</span></code></pre></div>
<pre><code>## Reading layer `1950-2018-torn-aspath&#39; from data source `/Users/jelsner/Desktop/Projects/ASSFG-Book/1950-2018-torn-aspath&#39; using driver `ESRI Shapefile&#39;
## Simple feature collection with 63645 features and 22 fields
## geometry type:  LINESTRING
## dimension:      XY
## bbox:           xmin: -163.53 ymin: 18.13 xmax: -64.9 ymax: 61.02
## CRS:            4326</code></pre>
<p>Next we project the geographic coordinate reference system to a specific Lambert conic conformal projection. The spatial units are set to meters.</p>
<div class="sourceCode" id="cb564"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb564-1"><a href="spatial-data.html#cb564-1"></a>sfdfL &lt;-<span class="st"> </span><span class="kw">st_transform</span>(sfdfL, </span>
<span id="cb564-2"><a href="spatial-data.html#cb564-2"></a>                      <span class="dt">crs =</span> <span class="st">&quot;+proj=lcc +lat_1=60 +lat_2=30 +lon_0=-90 +units=m&quot;</span>)</span></code></pre></div>
<p>Next we add a buffer to the geometries to represent the tornado path (‘footprint’). The width of the buffer is 1/2 the width given in the attribute table in the column <code>wid</code>. First we create new variables giving the width (and length) in units of meters.</p>
<div class="sourceCode" id="cb565"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb565-1"><a href="spatial-data.html#cb565-1"></a>sfdfL &lt;-<span class="st"> </span>sfdfL <span class="op">%&gt;%</span></span>
<span id="cb565-2"><a href="spatial-data.html#cb565-2"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">Width =</span> wid <span class="op">*</span><span class="st"> </span><span class="fl">.9144</span>,</span>
<span id="cb565-3"><a href="spatial-data.html#cb565-3"></a>         <span class="dt">Length =</span> len <span class="op">*</span><span class="st"> </span><span class="fl">1609.34</span>)</span>
<span id="cb565-4"><a href="spatial-data.html#cb565-4"></a>sfdfB &lt;-<span class="st"> </span><span class="kw">st_buffer</span>(sfdfL, </span>
<span id="cb565-5"><a href="spatial-data.html#cb565-5"></a>                   <span class="dt">dist =</span> sfdfL<span class="op">$</span>Width<span class="op">/</span><span class="dv">2</span>,</span>
<span id="cb565-6"><a href="spatial-data.html#cb565-6"></a>                   <span class="dt">endCapStyle =</span> <span class="st">&#39;ROUND&#39;</span>)</span></code></pre></div>
<p>Next, get the population data from the U.S. Census Bureau. First get an API key from <a href="http://api.census.gov/data/key_signup.html" class="uri">http://api.census.gov/data/key_signup.html</a></p>
<p>Here I’ve already done this and put the relevant data on my website. The functions are from Kyle Walker’s <strong>tidycensus</strong> package. Here is how I did it. You will need to request and get a U.S. Census API. <a href="https://www.census.gov/developers/" class="uri">https://www.census.gov/developers/</a></p>
<div class="sourceCode" id="cb566"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb566-1"><a href="spatial-data.html#cb566-1"></a><span class="kw">library</span>(tidycensus)</span>
<span id="cb566-2"><a href="spatial-data.html#cb566-2"></a><span class="kw">census_api_key</span>(<span class="st">&quot;YOUR API KEY GOES HERE&quot;</span>, </span>
<span id="cb566-3"><a href="spatial-data.html#cb566-3"></a>               <span class="dt">install =</span> <span class="ot">TRUE</span>)</span></code></pre></div>
<p>The 2014 population data are avaible using the <code>get_acs()</code> function from the <strong>tidycensus</strong> package. Here tract-level total population for the country (<code>B01003_001</code>). If we want tracts or smaller then we need to specify by state with <code>state =</code>.</p>
<div class="sourceCode" id="cb567"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb567-1"><a href="spatial-data.html#cb567-1"></a>tractPop &lt;-<span class="st"> </span><span class="kw">get_acs</span>(<span class="dt">geography =</span> <span class="st">&quot;tract&quot;</span>,</span>
<span id="cb567-2"><a href="spatial-data.html#cb567-2"></a>                    <span class="dt">year =</span> <span class="dv">2014</span>,</span>
<span id="cb567-3"><a href="spatial-data.html#cb567-3"></a>                    <span class="dt">variables =</span> <span class="st">&quot;B01003_001&quot;</span>,</span>
<span id="cb567-4"><a href="spatial-data.html#cb567-4"></a>                    <span class="dt">state =</span> <span class="st">&quot;FL&quot;</span>,</span>
<span id="cb567-5"><a href="spatial-data.html#cb567-5"></a>                    <span class="dt">geometry =</span> <span class="ot">TRUE</span>)</span>
<span id="cb567-6"><a href="spatial-data.html#cb567-6"></a>tractPop &lt;-<span class="st"> </span><span class="kw">st_transform</span>(tractPop, </span>
<span id="cb567-7"><a href="spatial-data.html#cb567-7"></a>                         <span class="dt">crs =</span> <span class="kw">st_crs</span>(sfdfB))</span>
<span id="cb567-8"><a href="spatial-data.html#cb567-8"></a><span class="kw">st_write</span>(tractPop, </span>
<span id="cb567-9"><a href="spatial-data.html#cb567-9"></a>         <span class="dt">dsn =</span> <span class="st">&quot;tractPop.shp&quot;</span>)</span></code></pre></div>
<p>Here we start with the Census data that was written out using the code above and placed on my website as a shapefile (<code>tractPop</code>).</p>
<div class="sourceCode" id="cb568"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb568-1"><a href="spatial-data.html#cb568-1"></a><span class="kw">download.file</span>(<span class="dt">url =</span> <span class="st">&quot;http://myweb.fsu.edu/jelsner/temp/data/tractPop.zip&quot;</span>,</span>
<span id="cb568-2"><a href="spatial-data.html#cb568-2"></a>              <span class="dt">destfile =</span> <span class="st">&quot;temporary.zip&quot;</span>)</span>
<span id="cb568-3"><a href="spatial-data.html#cb568-3"></a><span class="kw">unzip</span>(<span class="st">&quot;temporary.zip&quot;</span>)</span>
<span id="cb568-4"><a href="spatial-data.html#cb568-4"></a></span>
<span id="cb568-5"><a href="spatial-data.html#cb568-5"></a>tractPop &lt;-<span class="st"> </span><span class="kw">st_read</span>(<span class="dt">dsn =</span> <span class="st">&quot;tractPop&quot;</span>) </span></code></pre></div>
<pre><code>## Reading layer `tractPop&#39; from data source `/Users/jelsner/Desktop/Projects/ASSFG-Book/tractPop&#39; using driver `ESRI Shapefile&#39;
## replacing null geometries with empty geometries
## Simple feature collection with 4245 features and 5 fields (with 30 geometries empty)
## geometry type:  GEOMETRY
## dimension:      XY
## bbox:           xmin: 225332.7 ymin: 3119658 xmax: 1008441 ymax: 3823619
## proj4string:    +proj=lcc +lat_1=60 +lat_2=30 +lat_0=0 +lon_0=-90 +x_0=0 +y_0=0 +ellps=WGS84 +units=m +no_defs</code></pre>
<div class="sourceCode" id="cb570"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb570-1"><a href="spatial-data.html#cb570-1"></a><span class="kw">head</span>(tractPop)</span></code></pre></div>
<pre><code>## Simple feature collection with 6 features and 5 fields
## geometry type:  POLYGON
## dimension:      XY
## bbox:           xmin: 991564.1 ymin: 3406415 xmax: 997780 ymax: 3416481
## proj4string:    +proj=lcc +lat_1=60 +lat_2=30 +lat_0=0 +lon_0=-90 +x_0=0 +y_0=0 +ellps=WGS84 +units=m +no_defs 
##         GEOID                                          NAME   variable estimate
## 1 12099000101 Census Tract 1.01, Palm Beach County, Florida B01003_001     7410
## 2 12099000102 Census Tract 1.02, Palm Beach County, Florida B01003_001     2686
## 3 12099000202 Census Tract 2.02, Palm Beach County, Florida B01003_001     6826
## 4 12099000204 Census Tract 2.04, Palm Beach County, Florida B01003_001     4272
## 5 12099000205 Census Tract 2.05, Palm Beach County, Florida B01003_001     5280
## 6 12099000206 Census Tract 2.06, Palm Beach County, Florida B01003_001     7022
##   moe                       geometry
## 1 643 POLYGON ((991911.3 3415960,...
## 2 291 POLYGON ((995097.7 3416315,...
## 3 787 POLYGON ((992333.6 3411963,...
## 4 434 POLYGON ((991630.8 3410936,...
## 5 572 POLYGON ((995190.4 3408040,...
## 6 567 POLYGON ((991652.6 3410707,...</code></pre>
<p>Here the cookie cutters are the damage path POLYGONS and the tract-level population estimate is the dough.</p>
<p>Here we want <code>weight = "total"</code> so that the proportion of the tract area that is covered by the tornado path is used to weight the population of the tract. To simply preview the weights we use the <code>aw_preview_weights()</code> function as follows. The first argument is the cookie cutter simple feature data frame name, the second argument (<code>tid</code>) is the unique row identifier in the cookie cutter data frame. The <code>source =</code> argument names the simple feature data frame from which the cuts are made (here <code>tractPop</code>). The <code>sid =</code> argument is the unique row identifier in the source data frame. The final argument is the type of interpolation (either <code>intensive</code> or <code>extensive</code> in quotes).</p>
<div class="sourceCode" id="cb572"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb572-1"><a href="spatial-data.html#cb572-1"></a><span class="kw">aw_preview_weights</span>(sfdfB, </span>
<span id="cb572-2"><a href="spatial-data.html#cb572-2"></a>                   <span class="dt">tid =</span> om, </span>
<span id="cb572-3"><a href="spatial-data.html#cb572-3"></a>                   <span class="dt">source =</span> tractPop, </span>
<span id="cb572-4"><a href="spatial-data.html#cb572-4"></a>                   <span class="dt">sid =</span> GEOID, </span>
<span id="cb572-5"><a href="spatial-data.html#cb572-5"></a>                   <span class="dt">type =</span> <span class="st">&quot;extensive&quot;</span>)</span></code></pre></div>
<pre><code>## # A tibble: 34 x 3
##    GEOID       extensiveSum extensiveTotal
##    &lt;chr&gt;              &lt;dbl&gt;          &lt;dbl&gt;
##  1 12003040102            1   0.000354    
##  2 12005000202            1   0.00000523  
##  3 12009060300            1   0.000404    
##  4 12013010200            1   0.000131    
##  5 12013010300            1   0.00859     
##  6 12023110601            1   0.000312    
##  7 12037970200            1   0.000000651 
##  8 12039020400            1   0.00535     
##  9 12039020800            1   0.00970     
## 10 12051000300            1   0.0000000495
## # … with 24 more rows</code></pre>
<p>The first tornado in <code>sfdfB</code> simple features data frame covers .035% (<code>extensiveTotal</code> column) of the tract with GEOID 12003040102.</p>
<p>To perform the interpolation we remove the <code>type =</code> argument and replace it with the <code>extensive =</code> argument and where the value of the argument is the name of the variable we want to interpolated. Here that variable is the population estimate at the tract level with name <code>estimate</code>. We put the column name in quotes. We specify <code>weight = "total"</code> since we want the interpolation to have the same units as the extensive variable (here population) and we specify the <code>output =</code> to be a simple feature.</p>
<div class="sourceCode" id="cb574"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb574-1"><a href="spatial-data.html#cb574-1"></a>out.sf &lt;-<span class="st"> </span><span class="kw">aw_interpolate</span>(sfdfB, </span>
<span id="cb574-2"><a href="spatial-data.html#cb574-2"></a>                         <span class="dt">tid =</span> om, </span>
<span id="cb574-3"><a href="spatial-data.html#cb574-3"></a>                         <span class="dt">source =</span> tractPop, </span>
<span id="cb574-4"><a href="spatial-data.html#cb574-4"></a>                         <span class="dt">sid =</span> GEOID, </span>
<span id="cb574-5"><a href="spatial-data.html#cb574-5"></a>                         <span class="dt">extensive =</span> <span class="st">&quot;estimate&quot;</span>,</span>
<span id="cb574-6"><a href="spatial-data.html#cb574-6"></a>                         <span class="dt">weight =</span> <span class="st">&quot;total&quot;</span>, </span>
<span id="cb574-7"><a href="spatial-data.html#cb574-7"></a>                         <span class="dt">output =</span> <span class="st">&quot;sf&quot;</span>)</span></code></pre></div>
<p>The simple feature data frame (<code>out.sf</code>) contains all the same variables as <code>sfdfB</code> with a new column <code>estimate</code> giving the estimated population under the path of each tornado in Florida during 2014.</p>
<div class="sourceCode" id="cb575"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb575-1"><a href="spatial-data.html#cb575-1"></a><span class="kw">head</span>(out.sf)</span></code></pre></div>
<pre><code>## Simple feature collection with 6 features and 25 fields
## geometry type:  POLYGON
## dimension:      XY
## bbox:           xmin: 425770.4 ymin: 3365110 xmax: 938635.3 ymax: 3803557
## CRS:            +proj=lcc +lat_1=60 +lat_2=30 +lon_0=-90 +units=m
##       om   yr mo dy       date     time tz st stf stn mag inj fat loss closs
## 1 493361 2014  3  6 2014-03-06 11:00:00  3 FL  12   0   0   0   0  0.0     0
## 2 493362 2014  3  6 2014-03-06 11:38:00  3 FL  12   0   0   0   0  0.0     0
## 3 495142 2014  3  6 2014-03-06 13:30:00  3 FL  12   0   0   0   0  0.0     0
## 4 498063 2014  3 29 2014-03-29 12:20:00  3 FL  12   0   0   0   0  0.0     0
## 5 515057 2014  4  7 2014-04-07 15:23:00  3 FL  12   0   0   0   0  0.0     0
## 6 515067 2014  4 30 2014-04-30 00:44:00  3 FL  12   0   1   0   0  0.2     0
##      slat     slon    elat     elon  len wid fc  Width    Length    estimate
## 1 27.8650 -82.8500 27.8654 -82.8494 0.05  10  0  9.144   80.4670  0.20478275
## 2 27.9820 -82.6040 27.9940 -82.5860 1.38  15  0 13.716 2220.8892 20.20596432
## 3 26.5793 -80.7130 26.5797 -80.7097 0.25  50  0 45.720  402.3350  0.06467751
## 4 28.3892 -81.1332 28.3753 -81.1700 2.43 100  0 91.440 3910.6962 15.00500120
## 5 30.3879 -84.1433 30.3894 -84.1349 0.51  50  0 45.720  820.7634  3.27529237
## 6 30.8785 -85.5282 30.8924 -85.5063 1.62 100  0 91.440 2607.1308  7.80661375
##                         geometry
## 1 POLYGON ((710219.8 3486770,...
## 2 POLYGON ((734976.1 3503477,...
## 3 POLYGON ((938606.8 3365238,...
## 4 POLYGON ((870163.6 3560017,...
## 5 POLYGON ((562232.4 3756515,...
## 6 POLYGON ((427784 3803547, 4...</code></pre>
</div>
</div>
</div>
<div id="spatial-aggregation" class="section level2" number="3.4">
<h2><span class="header-section-number">3.4</span> Spatial aggregation</h2>
<p><a href="https://www.jla-data.net/eng/spatial-aggregation/" class="uri">https://www.jla-data.net/eng/spatial-aggregation/</a></p>
<p><strong>“If you’re stuck on a coding issue, sleep on it. That way when you wake up and try to fix it and it’s still broken, at least you got some sleep.”</strong> — Kelly Vaughn</p>
</div>
<div id="expectations-for-your-final-project." class="section level2" number="3.5">
<h2><span class="header-section-number">3.5</span> Expectations for your final project.</h2>
<p>The project is worth 50% of your grade. Requirements: (1) Ten minute presentation from an Rmd file on RStudio Cloud in Your Workspace. (2) The Rmd must knit to produce a HTML file.</p>
<p>Two options:</p>
<ol style="list-style-type: decimal">
<li>Demonstrate working knowledge of a method (e.g., kriging) that was presented in class but apply it to your own dataset.</li>
<li>Demonstrate working knowledge of a method (e.g., animal tracking) that was not presented in class. Make sure that the method has a spatial component.</li>
</ol>
<p>What to include in your Rmd file to demonstrate working knowledge:</p>
<ol style="list-style-type: decimal">
<li>Choose one (or more) spatial data sets. Explain why you are interested in these data (two or three sentences).</li>
<li>Import the data to R and make a map. Explain what the map shows (two or three sentences).</li>
<li>Compute a spatial summary statistic on one (or more) variables in the data (e.g., spatial intensity, Moran’s I, variogram). Describe it’s statistical and physical meaning.</li>
<li>Compare the summary statistic computed on your data to the same statistic estimated from a null model (e.g., no clustering). Include an estimate of uncertainty.</li>
<li>Fit a spatial statistical model to the data and interpret the results.</li>
</ol>
<p>Examples and guidelines:</p>
<p>1 (Option 1). A spatial regression model for the distribution of some species. Map the locations of the species (e.g., as points or as a count in cells across a grid). Quantify the spatial clustering by computing the spatial autocorrelation of counts or by showing a nearest-neighbor statistic. Map the explanatory variables (e.g., distance to roads, landcover type, etc). Fit a non-spatial regression model and examine the residuals for spatial autocorrelation. Fit a spatial regression model (spatial lag or spatial error) to predict the counts and give an interpretation of the results.</p>
<p>2 (Option 1). Spatially interpolate pollution levels from soil samples. Show a map of the soil sample values. Estimate the variogram. Test for anisotropy. Fit a variogram model. Interpolate using universal or ordinary kriging. Map the surface and include the original sample values. Map the predicted variance. Interpret the results. If there are covariates try a co-kriging model.</p>
<p>3 (Option 1). Point pattern model for the distribution ant hills in a prairie. Map the hill locations perhaps including marks indicating size. Quantify the clustering by computing nearest-neighbor statistics. Make inferences regarding the clustering. Fit a point pattern model perhaps with a trend and explanatory variables (e.g., soil type, proximity to vegetation, etc). Use the model for simulation. Compare simulated point patterns with the actual point pattern.</p>
<p>4 (Option 2). Demonstrate the key spatial functions from a package not covered in class. The functions must be related to spatial analysis. Some examples of packages that will not be presented in this class.</p>
<ul>
<li>Animal tracking <a href="https://cran.r-project.org/web/packages/adehabitatLT/vignettes/adehabitatLT.pdf" class="uri">https://cran.r-project.org/web/packages/adehabitatLT/vignettes/adehabitatLT.pdf</a></li>
<li>Tracking in general <a href="https://cran.r-project.org/web/views/Tracking.html" class="uri">https://cran.r-project.org/web/views/Tracking.html</a></li>
<li>Running/cycling/swimming data from GPS-enabled tracking <a href="https://cran.r-project.org/web/packages/trackeR/vignettes/trackeR.pdf" class="uri">https://cran.r-project.org/web/packages/trackeR/vignettes/trackeR.pdf</a></li>
<li>Sustainable transport planning <a href="https://cran.r-project.org/web/packages/stplanr/vignettes/stplanr-paper.html" class="uri">https://cran.r-project.org/web/packages/stplanr/vignettes/stplanr-paper.html</a></li>
<li>At a minimum choose a package from those listed in the CRAN Spatial View <a href="https://cran.r-project.org/web/views/Spatial.html" class="uri">https://cran.r-project.org/web/views/Spatial.html</a></li>
</ul>
<div id="review-state-u.s.-boundaries-as-simple-feature-data-frames" class="section level3" number="3.5.1">
<h3><span class="header-section-number">3.5.1</span> Review: State (U.S.) boundaries as simple feature data frames</h3>
<p>Consider the U.S. state of Kansas. A boundary file containing the borders as a polygon is available in the <strong>USAboundaries</strong> package. The package contains historical and contemporary boundaries with the data provided by the U.S. Census Bureau.</p>
<p>Individual states are extracted using the <code>us_states()</code> function.</p>
<div class="sourceCode" id="cb577"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb577-1"><a href="spatial-data.html#cb577-1"></a><span class="kw">library</span>(USAboundaries)</span>
<span id="cb577-2"><a href="spatial-data.html#cb577-2"></a><span class="kw">library</span>(sf)</span>
<span id="cb577-3"><a href="spatial-data.html#cb577-3"></a></span>
<span id="cb577-4"><a href="spatial-data.html#cb577-4"></a>KS &lt;-<span class="st"> </span><span class="kw">us_states</span>(<span class="dt">states =</span> <span class="st">&quot;Kansas&quot;</span>)</span>
<span id="cb577-5"><a href="spatial-data.html#cb577-5"></a><span class="kw">class</span>(KS)</span></code></pre></div>
<pre><code>## [1] &quot;sf&quot;         &quot;data.frame&quot;</code></pre>
<div class="sourceCode" id="cb579"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb579-1"><a href="spatial-data.html#cb579-1"></a><span class="kw">plot</span>(KS<span class="op">$</span>geometry)</span></code></pre></div>
<p><img src="assfg-book_files/figure-html/unnamed-chunk-250-1.png" width="672" /></p>
<p>We transform the CRS to a Web Mercator using the EPSG 3857 code.</p>
<div class="sourceCode" id="cb580"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb580-1"><a href="spatial-data.html#cb580-1"></a>KS &lt;-<span class="st"> </span><span class="kw">st_transform</span>(KS, <span class="dt">crs =</span> <span class="dv">3857</span>)</span></code></pre></div>
<p>Suppose we want to subset geographically rather than based on some value in a column of the data frame. For example here we subset the tornado initial locations by the boundaries defined by Kansas. We first import the initial genesis locations and transform the native CRS to EPSG 3857.</p>
<div class="sourceCode" id="cb581"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb581-1"><a href="spatial-data.html#cb581-1"></a>Alltors &lt;-<span class="st"> </span><span class="kw">st_read</span>(<span class="dt">dsn =</span> <span class="st">&quot;1950-2018-torn-initpoint&quot;</span>, </span>
<span id="cb581-2"><a href="spatial-data.html#cb581-2"></a>                   <span class="dt">layer =</span> <span class="st">&quot;1950-2018-torn-initpoint&quot;</span>) <span class="op">%&gt;%</span></span>
<span id="cb581-3"><a href="spatial-data.html#cb581-3"></a><span class="st">  </span><span class="kw">st_transform</span>(<span class="dt">crs =</span> <span class="dv">3857</span>)</span></code></pre></div>
<pre><code>## Reading layer `1950-2018-torn-initpoint&#39; from data source `/Users/jelsner/Desktop/Projects/ASSFG-Book/1950-2018-torn-initpoint&#39; using driver `ESRI Shapefile&#39;
## Simple feature collection with 63645 features and 22 fields
## geometry type:  POINT
## dimension:      XY
## bbox:           xmin: -163.53 ymin: 18.13 xmax: -64.9 ymax: 61.02
## CRS:            4326</code></pre>
<p>We then use the <code>st_intersection()</code> function to determine the subset of all tornadoes that intersect the Kansas polygon. The first argument is the simple feature data frame that we want subsetted and the second defines the geometry over which the subsetting occurs.</p>
<div class="sourceCode" id="cb583"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb583-1"><a href="spatial-data.html#cb583-1"></a>KStors &lt;-<span class="st"> </span><span class="kw">st_intersection</span>(Alltors, </span>
<span id="cb583-2"><a href="spatial-data.html#cb583-2"></a>                          KS<span class="op">$</span>geometry)</span></code></pre></div>
<pre><code>## Warning: attribute variables are assumed to be spatially constant throughout all
## geometries</code></pre>
<div class="sourceCode" id="cb585"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb585-1"><a href="spatial-data.html#cb585-1"></a><span class="kw">plot</span>(KS<span class="op">$</span>geometry)</span>
<span id="cb585-2"><a href="spatial-data.html#cb585-2"></a><span class="kw">plot</span>(KStors<span class="op">$</span>geometry, <span class="dt">add =</span> <span class="ot">TRUE</span>)</span></code></pre></div>
<p><img src="assfg-book_files/figure-html/unnamed-chunk-253-1.png" width="672" /></p>
<p>Suppose we want to determine the distance between the geographic center of the state and the centroid of all the tornadoes?</p>
<p>We start by computing the centroids for the state polygon and for the combined set of all Kansas tornadoes.</p>
<div class="sourceCode" id="cb586"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb586-1"><a href="spatial-data.html#cb586-1"></a>KSgeocenter &lt;-<span class="st"> </span><span class="kw">st_centroid</span>(KS)</span></code></pre></div>
<pre><code>## Warning in st_centroid.sf(KS): st_centroid assumes attributes are constant over
## geometries of x</code></pre>
<div class="sourceCode" id="cb588"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb588-1"><a href="spatial-data.html#cb588-1"></a>KStorcenter &lt;-<span class="st"> </span><span class="kw">st_centroid</span>(<span class="kw">st_combine</span>(KStors))</span></code></pre></div>
<p>Finally we make a map and then compute the distance in meters using the <code>st_distance()</code> function.</p>
<div class="sourceCode" id="cb589"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb589-1"><a href="spatial-data.html#cb589-1"></a><span class="kw">plot</span>(KS<span class="op">$</span>geometry)</span>
<span id="cb589-2"><a href="spatial-data.html#cb589-2"></a><span class="kw">plot</span>(KSgeocenter<span class="op">$</span>geometry, <span class="dt">add =</span> <span class="ot">TRUE</span>, <span class="dt">col =</span> <span class="st">&quot;blue&quot;</span>)</span>
<span id="cb589-3"><a href="spatial-data.html#cb589-3"></a><span class="kw">plot</span>(KStorcenter, <span class="dt">add =</span> <span class="ot">TRUE</span>, <span class="dt">col =</span> <span class="st">&quot;red&quot;</span>)</span></code></pre></div>
<p><img src="assfg-book_files/figure-html/unnamed-chunk-255-1.png" width="672" /></p>
<div class="sourceCode" id="cb590"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb590-1"><a href="spatial-data.html#cb590-1"></a><span class="kw">st_distance</span>(KSgeocenter, KStorcenter)</span></code></pre></div>
<pre><code>## Units: [m]
##          [,1]
## [1,] 7062.554</code></pre>
</div>
</div>
<div id="working-with-rasters" class="section level2" number="3.6">
<h2><span class="header-section-number">3.6</span> Working with Rasters</h2>
<p>Recall that the <em>vector data model</em> represents the world using points, lines and polygons and we use classes from the <strong>sp</strong> and <strong>sf</strong> packages to work with vector data. The <em>raster data model</em> divides geographic space into a grid of cells of constant size (resolution) and we use classes from the <strong>raster</strong> package to work with raster data.</p>
<p>A raster in R is a data structure that divides space into rectangles called ‘cells’ (or ‘pixels’). Each cell has an attribute value.</p>
<p>The <strong>raster</strong> package has functions for creating, reading, manipulating, and writing raster data as S4 objects and functions for raster manipulation common in GIS.</p>
<div class="sourceCode" id="cb592"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb592-1"><a href="spatial-data.html#cb592-1"></a><span class="kw">library</span>(raster)</span></code></pre></div>
<pre><code>## 
## Attaching package: &#39;raster&#39;</code></pre>
<pre><code>## The following object is masked from &#39;package:dplyr&#39;:
## 
##     select</code></pre>
<pre><code>## The following object is masked from &#39;package:tidyr&#39;:
## 
##     extract</code></pre>
<p>An S4 <code>RasterLayer</code> object (raster) is one variable (called a ‘layer’ or a ‘band’). The object includes the number of columns and rows, the coordinates of its spatial extent (bounding box), and the coordinate reference system (CRS).</p>
<p>A raster can also store information about the external file from where it came.</p>
<p>The package has two classes for data with more than one variable associated with each cell (multi-layer data) the <code>RasterStack</code> and the <code>RasterBrick</code>. A <code>RasterBrick</code> can only be linked to a single (multi-layer) file. A <code>RasterStack</code> can be formed from separate files. Otherwise they are the same.</p>
<div id="creating-raster-objects" class="section level3" number="3.6.1">
<h3><span class="header-section-number">3.6.1</span> Creating raster objects</h3>
<p>The <code>raster()</code> function creates a raster with a geographic (longitude/latitude) CRS and a 1 by 1 degree grid of cells across the globe.</p>
<div class="sourceCode" id="cb596"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb596-1"><a href="spatial-data.html#cb596-1"></a>r &lt;-<span class="st"> </span><span class="kw">raster</span>()</span>
<span id="cb596-2"><a href="spatial-data.html#cb596-2"></a>r</span></code></pre></div>
<pre><code>## class      : RasterLayer 
## dimensions : 180, 360, 64800  (nrow, ncol, ncell)
## resolution : 1, 1  (x, y)
## extent     : -180, 180, -90, 90  (xmin, xmax, ymin, ymax)
## crs        : +proj=longlat +datum=WGS84 +ellps=WGS84 +towgs84=0,0,0</code></pre>
<p>Arguments including <code>xmin</code>, <code>nrow</code>, <code>ncol</code>, and <code>crs</code> are used to change these default settings. The CRS is written as a proj4string.</p>
<p>The default raster layer is in geographic coordinates spanning the globe at one-degree resolution in the north-south and the east-west directions.</p>
<p>We know the raster object is an S4 class because it has slots (e.g., <code>@data</code>).</p>
<div class="sourceCode" id="cb598"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb598-1"><a href="spatial-data.html#cb598-1"></a><span class="kw">str</span>(r)</span></code></pre></div>
<pre><code>## Formal class &#39;RasterLayer&#39; [package &quot;raster&quot;] with 12 slots
##   ..@ file    :Formal class &#39;.RasterFile&#39; [package &quot;raster&quot;] with 13 slots
##   .. .. ..@ name        : chr &quot;&quot;
##   .. .. ..@ datanotation: chr &quot;FLT4S&quot;
##   .. .. ..@ byteorder   : chr &quot;little&quot;
##   .. .. ..@ nodatavalue : num -Inf
##   .. .. ..@ NAchanged   : logi FALSE
##   .. .. ..@ nbands      : int 1
##   .. .. ..@ bandorder   : chr &quot;BIL&quot;
##   .. .. ..@ offset      : int 0
##   .. .. ..@ toptobottom : logi TRUE
##   .. .. ..@ blockrows   : int 0
##   .. .. ..@ blockcols   : int 0
##   .. .. ..@ driver      : chr &quot;&quot;
##   .. .. ..@ open        : logi FALSE
##   ..@ data    :Formal class &#39;.SingleLayerData&#39; [package &quot;raster&quot;] with 13 slots
##   .. .. ..@ values    : logi(0) 
##   .. .. ..@ offset    : num 0
##   .. .. ..@ gain      : num 1
##   .. .. ..@ inmemory  : logi FALSE
##   .. .. ..@ fromdisk  : logi FALSE
##   .. .. ..@ isfactor  : logi FALSE
##   .. .. ..@ attributes: list()
##   .. .. ..@ haveminmax: logi FALSE
##   .. .. ..@ min       : num Inf
##   .. .. ..@ max       : num -Inf
##   .. .. ..@ band      : int 1
##   .. .. ..@ unit      : chr &quot;&quot;
##   .. .. ..@ names     : chr &quot;&quot;
##   ..@ legend  :Formal class &#39;.RasterLegend&#39; [package &quot;raster&quot;] with 5 slots
##   .. .. ..@ type      : chr(0) 
##   .. .. ..@ values    : logi(0) 
##   .. .. ..@ color     : logi(0) 
##   .. .. ..@ names     : logi(0) 
##   .. .. ..@ colortable: logi(0) 
##   ..@ title   : chr(0) 
##   ..@ extent  :Formal class &#39;Extent&#39; [package &quot;raster&quot;] with 4 slots
##   .. .. ..@ xmin: num -180
##   .. .. ..@ xmax: num 180
##   .. .. ..@ ymin: num -90
##   .. .. ..@ ymax: num 90
##   ..@ rotated : logi FALSE
##   ..@ rotation:Formal class &#39;.Rotation&#39; [package &quot;raster&quot;] with 2 slots
##   .. .. ..@ geotrans: num(0) 
##   .. .. ..@ transfun:function ()  
##   ..@ ncols   : int 360
##   ..@ nrows   : int 180
##   ..@ crs     :Formal class &#39;CRS&#39; [package &quot;sp&quot;] with 1 slot
##   .. .. ..@ projargs: chr &quot;+proj=longlat +datum=WGS84 +ellps=WGS84 +towgs84=0,0,0&quot;
##   ..@ history : list()
##   ..@ z       : list()</code></pre>
<p>The slot names are retrieved with</p>
<div class="sourceCode" id="cb600"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb600-1"><a href="spatial-data.html#cb600-1"></a><span class="kw">slotNames</span>(r)</span></code></pre></div>
<pre><code>##  [1] &quot;file&quot;     &quot;data&quot;     &quot;legend&quot;   &quot;title&quot;    &quot;extent&quot;   &quot;rotated&quot; 
##  [7] &quot;rotation&quot; &quot;ncols&quot;    &quot;nrows&quot;    &quot;crs&quot;      &quot;history&quot;  &quot;z&quot;</code></pre>
<p>To create an alternative raster with 36 longitudes -100 and 0 degrees East longitude and 18 latitudes between the equator and 50 degrees N latitude we specify the number of columns, the number of rows and the extent as follows.</p>
<div class="sourceCode" id="cb602"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb602-1"><a href="spatial-data.html#cb602-1"></a>r &lt;-<span class="st"> </span><span class="kw">raster</span>(<span class="dt">ncol =</span> <span class="dv">36</span>, <span class="dt">nrow =</span> <span class="dv">18</span>, </span>
<span id="cb602-2"><a href="spatial-data.html#cb602-2"></a>            <span class="dt">xmn =</span> <span class="dv">-100</span>, <span class="dt">xmx =</span> <span class="dv">0</span>, </span>
<span id="cb602-3"><a href="spatial-data.html#cb602-3"></a>            <span class="dt">ymn =</span> <span class="dv">0</span>, <span class="dt">ymx =</span> <span class="dv">50</span>)</span>
<span id="cb602-4"><a href="spatial-data.html#cb602-4"></a>r</span></code></pre></div>
<pre><code>## class      : RasterLayer 
## dimensions : 18, 36, 648  (nrow, ncol, ncell)
## resolution : 2.777778, 2.777778  (x, y)
## extent     : -100, 0, 0, 50  (xmin, xmax, ymin, ymax)
## crs        : +proj=longlat +datum=WGS84 +ellps=WGS84 +towgs84=0,0,0</code></pre>
<div class="sourceCode" id="cb604"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb604-1"><a href="spatial-data.html#cb604-1"></a><span class="kw">res</span>(r)</span></code></pre></div>
<pre><code>## [1] 2.777778 2.777778</code></pre>
<p>This results in raster with cell resolution of 2.7 degrees of longitude and 2.7 degrees of latitude.</p>
<p>The parameters can be changed after the raster is created. Here we change the resolution to exactly 3 degrees. This changes the number of rows and columns.</p>
<div class="sourceCode" id="cb606"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb606-1"><a href="spatial-data.html#cb606-1"></a><span class="kw">res</span>(r) &lt;-<span class="st"> </span><span class="dv">3</span></span>
<span id="cb606-2"><a href="spatial-data.html#cb606-2"></a><span class="kw">ncol</span>(r)</span></code></pre></div>
<pre><code>## [1] 33</code></pre>
<div class="sourceCode" id="cb608"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb608-1"><a href="spatial-data.html#cb608-1"></a><span class="kw">nrow</span>(r)</span></code></pre></div>
<pre><code>## [1] 17</code></pre>
<p>Here we change the number of columns to 18. This changes the resolution to 5.5 degrees in the east-west direction but keeps the resolution at 3 degrees in the north-south direction.</p>
<div class="sourceCode" id="cb610"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb610-1"><a href="spatial-data.html#cb610-1"></a><span class="kw">ncol</span>(r) &lt;-<span class="st"> </span><span class="dv">18</span></span>
<span id="cb610-2"><a href="spatial-data.html#cb610-2"></a><span class="kw">res</span>(r)</span></code></pre></div>
<pre><code>## [1] 5.5 3.0</code></pre>
<p>The raster object <code>r</code> is a template with no values in the cells. By default it will have an extent that spans the globe.</p>
<div class="sourceCode" id="cb612"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb612-1"><a href="spatial-data.html#cb612-1"></a>r &lt;-<span class="st"> </span><span class="kw">raster</span>(<span class="dt">ncol =</span> <span class="dv">10</span>, <span class="dt">nrow =</span> <span class="dv">10</span>)</span>
<span id="cb612-2"><a href="spatial-data.html#cb612-2"></a></span>
<span id="cb612-3"><a href="spatial-data.html#cb612-3"></a><span class="kw">ncell</span>(r)</span></code></pre></div>
<pre><code>## [1] 100</code></pre>
<div class="sourceCode" id="cb614"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb614-1"><a href="spatial-data.html#cb614-1"></a><span class="kw">hasValues</span>(r)</span></code></pre></div>
<pre><code>## [1] FALSE</code></pre>
<p>Here there are 100 cells in a 10 by 10 empty raster. We use the <code>values()</code> function to place values in the cells. The function is specified on the left-hand side of the assignment operator. First we assign to a vector of length <code>ncell(r)</code> random numbers from a uniform distribution with the <code>runif()</code> function. The default is that the random numbers are between 0 and 1.</p>
<div class="sourceCode" id="cb616"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb616-1"><a href="spatial-data.html#cb616-1"></a>v &lt;-<span class="st"> </span><span class="kw">runif</span>(<span class="kw">ncell</span>(r))</span>
<span id="cb616-2"><a href="spatial-data.html#cb616-2"></a><span class="kw">head</span>(v)</span></code></pre></div>
<pre><code>## [1] 0.6760344 0.8791907 0.7589404 0.1710177 0.5184367 0.6011584</code></pre>
<div class="sourceCode" id="cb618"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb618-1"><a href="spatial-data.html#cb618-1"></a><span class="kw">values</span>(r) &lt;-<span class="st"> </span>v</span>
<span id="cb618-2"><a href="spatial-data.html#cb618-2"></a><span class="kw">head</span>(r)</span></code></pre></div>
<pre><code>##             1         2         3           4          5         6          7
## 1  0.67603436 0.8791907 0.7589404 0.171017728 0.51843670 0.6011584 0.95576311
## 2  0.12131282 0.3757451 0.1725738 0.833633343 0.23788773 0.5174037 0.88990611
## 3  0.14461217 0.9017774 0.8285979 0.321408121 0.74631613 0.3123553 0.25809347
## 4  0.62179442 0.1239171 0.3411119 0.004537917 0.50143227 0.8185247 0.01779656
## 5  0.85678235 0.6455332 0.4658732 0.916013978 0.87751075 0.8675222 0.37854454
## 6  0.71153439 0.6430360 0.3154673 0.102036400 0.20458383 0.8954627 0.85357905
## 7  0.09077537 0.1062902 0.4694711 0.927161670 0.95896371 0.2755370 0.23134015
## 8  0.46228577 0.6092207 0.2025476 0.975101148 0.04961742 0.4866812 0.03747906
## 9  0.54903333 0.4507182 0.4398499 0.296908885 0.77547379 0.8566912 0.24276549
## 10 0.77201013 0.7660281 0.3746228 0.580862483 0.45489682 0.1813805 0.94200763
##             8         9        10
## 1  0.61387469 0.3873558 0.7363020
## 2  0.08805707 0.2255451 0.3623937
## 3  0.91263102 0.8016960 0.2788676
## 4  0.90515451 0.4313071 0.1561031
## 5  0.25013341 0.3402057 0.7030463
## 6  0.41475308 0.6409912 0.2888666
## 7  0.19825852 0.8407078 0.1246083
## 8  0.08147994 0.8127691 0.5877135
## 9  0.50356013 0.4108382 0.5585083
## 10 0.98499242 0.1196839 0.4624998</code></pre>
<p>The cells are arranged in lexicographical order (upper left to lower right) and the cells are populated with the values in the vector in this order.</p>
<p>The <code>plot()</code> method creates a choropleth map of the values in cells.</p>
<div class="sourceCode" id="cb620"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb620-1"><a href="spatial-data.html#cb620-1"></a><span class="kw">plot</span>(r)</span></code></pre></div>
<p><img src="assfg-book_files/figure-html/unnamed-chunk-265-1.png" width="672" /></p>
<p>The default CRS is geographic.</p>
<div class="sourceCode" id="cb621"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb621-1"><a href="spatial-data.html#cb621-1"></a><span class="kw">projection</span>(r)</span></code></pre></div>
<pre><code>## [1] &quot;+proj=longlat +datum=WGS84 +ellps=WGS84 +towgs84=0,0,0&quot;</code></pre>
<p>To project the raster use the function <code>projectRaster()</code>. Projections are performed using the <code>PROJ4</code> protocol accessed through the <strong>rgdal</strong> package (same as with <strong>sf</strong> and <strong>sp</strong> objects).</p>
<p>We can also use the <code>setValues()</code> function to place values in the cells. Here we create a new raster layer with cell numbers as values using the <code>setValues()</code> function to place the numbers in the cells.</p>
<div class="sourceCode" id="cb623"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb623-1"><a href="spatial-data.html#cb623-1"></a>r &lt;-<span class="st"> </span><span class="kw">raster</span>(<span class="dt">xmn =</span> <span class="dv">-110</span>, <span class="dt">xmx =</span> <span class="dv">-90</span>, </span>
<span id="cb623-2"><a href="spatial-data.html#cb623-2"></a>            <span class="dt">ymn =</span> <span class="dv">40</span>, <span class="dt">ymx =</span> <span class="dv">60</span>, </span>
<span id="cb623-3"><a href="spatial-data.html#cb623-3"></a>            <span class="dt">ncols =</span> <span class="dv">10</span>, <span class="dt">nrows =</span> <span class="dv">10</span>)</span>
<span id="cb623-4"><a href="spatial-data.html#cb623-4"></a>r &lt;-<span class="st"> </span><span class="kw">setValues</span>(r, <span class="dv">1</span><span class="op">:</span><span class="kw">ncell</span>(r))</span>
<span id="cb623-5"><a href="spatial-data.html#cb623-5"></a><span class="kw">projection</span>(r)</span></code></pre></div>
<pre><code>## [1] &quot;+proj=longlat +datum=WGS84 +ellps=WGS84 +towgs84=0,0,0&quot;</code></pre>
<div class="sourceCode" id="cb625"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb625-1"><a href="spatial-data.html#cb625-1"></a><span class="kw">plot</span>(r)</span></code></pre></div>
<p><img src="assfg-book_files/figure-html/unnamed-chunk-267-1.png" width="672" /></p>
<p>The numbers increase from top right to bottom left.</p>
<p>Next we create a projected raster.</p>
<div class="sourceCode" id="cb626"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb626-1"><a href="spatial-data.html#cb626-1"></a>rp &lt;-<span class="st"> </span><span class="kw">projectRaster</span>(r, </span>
<span id="cb626-2"><a href="spatial-data.html#cb626-2"></a>                    <span class="dt">crs =</span> <span class="st">&quot;+proj=merc +a=6378137 +b=6378137 +lat_ts=0.0 +lon_0=0.0 +x_0=0.0 +y_0=0 +k=1.0 +units=m&quot;</span>)</span>
<span id="cb626-3"><a href="spatial-data.html#cb626-3"></a><span class="kw">plot</span>(rp)</span></code></pre></div>
<p><img src="assfg-book_files/figure-html/unnamed-chunk-268-1.png" width="672" /></p>
<p>The projection is performed using bi-linear interpolation (default). In the case where the values are categorical we use <code>method = "ngb"</code> for nearest neighbor.</p>
</div>
<div id="from-a-data-frame" class="section level3" number="3.6.2">
<h3><span class="header-section-number">3.6.2</span> From a data frame</h3>
<p>The function <code>rasterFromXYZ()</code> is used to create a raster from a data frame where two of the columns are spatial coordinates listed in an array format.</p>
<p>For example, first create a data frame.</p>
<div class="sourceCode" id="cb627"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb627-1"><a href="spatial-data.html#cb627-1"></a>x &lt;-<span class="st"> </span><span class="kw">seq</span>(<span class="dv">0</span>, <span class="dv">10</span>, <span class="dt">length.out =</span> <span class="dv">11</span>)</span>
<span id="cb627-2"><a href="spatial-data.html#cb627-2"></a>y &lt;-<span class="st"> </span><span class="kw">seq</span>(<span class="op">-</span><span class="dv">1</span>, <span class="dv">1</span>, <span class="dt">length.out =</span> <span class="dv">11</span>)</span>
<span id="cb627-3"><a href="spatial-data.html#cb627-3"></a>df &lt;-<span class="st"> </span><span class="kw">expand.grid</span>(<span class="dt">x =</span> x, <span class="dt">y =</span> y)</span>
<span id="cb627-4"><a href="spatial-data.html#cb627-4"></a><span class="kw">head</span>(df)</span></code></pre></div>
<pre><code>##   x  y
## 1 0 -1
## 2 1 -1
## 3 2 -1
## 4 3 -1
## 5 4 -1
## 6 5 -1</code></pre>
<div class="sourceCode" id="cb629"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb629-1"><a href="spatial-data.html#cb629-1"></a>df<span class="op">$</span>v &lt;-<span class="st"> </span><span class="kw">rnorm</span>(<span class="kw">nrow</span>(df))</span>
<span id="cb629-2"><a href="spatial-data.html#cb629-2"></a>df</span></code></pre></div>
<pre><code>##      x    y            v
## 1    0 -1.0 -2.020443923
## 2    1 -1.0 -0.240107081
## 3    2 -1.0  0.630381697
## 4    3 -1.0  0.388818268
## 5    4 -1.0 -0.435826423
## 6    5 -1.0  0.191041464
## 7    6 -1.0 -1.726788359
## 8    7 -1.0  0.192297647
## 9    8 -1.0  0.268970859
## 10   9 -1.0  0.312580794
## 11  10 -1.0 -0.318134613
## 12   0 -0.8 -0.141479565
## 13   1 -0.8 -0.936900930
## 14   2 -0.8 -0.474752894
## 15   3 -0.8 -1.077963035
## 16   4 -0.8  0.729076322
## 17   5 -0.8  0.887202988
## 18   6 -0.8 -0.380542538
## 19   7 -0.8  0.749130510
## 20   8 -0.8 -0.910529522
## 21   9 -0.8  0.583325596
## 22  10 -0.8 -2.370042552
## 23   0 -0.6 -0.874813635
## 24   1 -0.6  1.586765602
## 25   2 -0.6  0.205340264
## 26   3 -0.6  1.095638025
## 27   4 -0.6 -0.224363370
## 28   5 -0.6 -1.654547625
## 29   6 -0.6 -2.337070815
## 30   7 -0.6 -1.150525265
## 31   8 -0.6 -0.180303198
## 32   9 -0.6  0.748713620
## 33  10 -0.6  0.268571310
## 34   0 -0.4  0.162866827
## 35   1 -0.4 -1.418798642
## 36   2 -0.4  0.338457233
## 37   3 -0.4 -2.531301296
## 38   4 -0.4  1.017015225
## 39   5 -0.4  0.565070074
## 40   6 -0.4 -0.879231859
## 41   7 -0.4  1.352296484
## 42   8 -0.4 -0.402204153
## 43   9 -0.4 -2.140879105
## 44  10 -0.4 -0.829172466
## 45   0 -0.2 -0.214103991
## 46   1 -0.2 -1.008166755
## 47   2 -0.2  0.508366433
## 48   3 -0.2  1.163898253
## 49   4 -0.2 -0.865827021
## 50   5 -0.2 -0.685936161
## 51   6 -0.2 -0.539849992
## 52   7 -0.2 -0.869607614
## 53   8 -0.2  0.750786729
## 54   9 -0.2  1.096868105
## 55  10 -0.2  0.191561048
## 56   0  0.0 -2.704210122
## 57   1  0.0 -2.388130209
## 58   2  0.0 -0.250701658
## 59   3  0.0 -0.217145886
## 60   4  0.0 -0.807962904
## 61   5  0.0  0.763485901
## 62   6  0.0 -0.673262978
## 63   7  0.0 -0.172932445
## 64   8  0.0  1.603635935
## 65   9  0.0  0.708057749
## 66  10  0.0 -0.654053917
## 67   0  0.2  1.843071603
## 68   1  0.2 -0.142885563
## 69   2  0.2 -1.400759393
## 70   3  0.2 -0.540905296
## 71   4  0.2  1.945266476
## 72   5  0.2 -0.547176621
## 73   6  0.2 -1.669195607
## 74   7  0.2 -0.378417207
## 75   8  0.2 -0.484484636
## 76   9  0.2 -0.233188415
## 77  10  0.2 -1.167494466
## 78   0  0.4 -0.161733333
## 79   1  0.4  1.425145082
## 80   2  0.4  1.050766111
## 81   3  0.4  0.118813284
## 82   4  0.4 -0.166991197
## 83   5  0.4  0.264124882
## 84   6  0.4 -2.021553204
## 85   7  0.4 -0.702531647
## 86   8  0.4  0.176102897
## 87   9  0.4  1.296107158
## 88  10  0.4  0.422997702
## 89   0  0.6  0.748590097
## 90   1  0.6 -0.271042960
## 91   2  0.6 -1.704742394
## 92   3  0.6  0.157574397
## 93   4  0.6  0.157581135
## 94   5  0.6  0.009004968
## 95   6  0.6 -0.662073808
## 96   7  0.6 -0.423322333
## 97   8  0.6  0.261075358
## 98   9  0.6 -0.077465231
## 99  10  0.6  0.555293040
## 100  0  0.8  1.357007382
## 101  1  0.8  0.734738321
## 102  2  0.8 -1.452148778
## 103  3  0.8  1.667435318
## 104  4  0.8 -1.667268616
## 105  5  0.8  0.045841522
## 106  6  0.8 -0.690853412
## 107  7  0.8  0.546603971
## 108  8  0.8 -0.505630390
## 109  9  0.8 -0.766432497
## 110 10  0.8  0.772357518
## 111  0  1.0  0.240098478
## 112  1  1.0 -0.183275147
## 113  2  1.0  0.070042550
## 114  3  1.0 -0.892264907
## 115  4  1.0 -0.813011324
## 116  5  1.0  0.702632728
## 117  6  1.0  1.687883533
## 118  7  1.0 -0.068019841
## 119  8  1.0 -0.044428048
## 120  9  1.0  1.011590427
## 121 10  1.0  1.638051769</code></pre>
<p>The first two columns are the spatial locations in an array format and the third is an attribute.</p>
<p>Use the <code>rasterFromXYZ()</code> function to convert the data frame to a raster.</p>
<div class="sourceCode" id="cb631"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb631-1"><a href="spatial-data.html#cb631-1"></a>dfr &lt;-<span class="st"> </span><span class="kw">rasterFromXYZ</span>(df)        </span>
<span id="cb631-2"><a href="spatial-data.html#cb631-2"></a><span class="kw">plot</span>(dfr)</span></code></pre></div>
<p><img src="assfg-book_files/figure-html/unnamed-chunk-270-1.png" width="672" /></p>
<p>Note: this only works if the spatial coordinates are arranged in the format of an array.</p>
</div>
<div id="raster-manipulations" class="section level3" number="3.6.3">
<h3><span class="header-section-number">3.6.3</span> Raster manipulations</h3>
<p>The <code>raster()</code> function imports data with functions from the <strong>rgdal</strong> package. Supported formats include <code>GeoTIFF</code>, <code>ESRI</code>, <code>ENVI</code>, and <code>ERDAS</code>. Most formats that can import rasters can also be used to exporting rasters.</p>
<p>Consider the <code>Meuse</code> dataset (taken from the <strong>sp</strong> package), using a file in the native ‘raster- file’ format:</p>
<div class="sourceCode" id="cb632"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb632-1"><a href="spatial-data.html#cb632-1"></a>f &lt;-<span class="st"> </span><span class="kw">system.file</span>(<span class="st">&quot;external/test.grd&quot;</span>, </span>
<span id="cb632-2"><a href="spatial-data.html#cb632-2"></a>                 <span class="dt">package =</span> <span class="st">&quot;raster&quot;</span>)</span>
<span id="cb632-3"><a href="spatial-data.html#cb632-3"></a>r &lt;-<span class="st"> </span><span class="kw">raster</span>(f)</span>
<span id="cb632-4"><a href="spatial-data.html#cb632-4"></a><span class="kw">filename</span>(r)</span></code></pre></div>
<pre><code>## [1] &quot;/Library/Frameworks/R.framework/Versions/4.0/Resources/library/raster/external/test.grd&quot;</code></pre>
<p>Do the cells contain values? Is the raster stored in memory? Create a plot.</p>
<div class="sourceCode" id="cb634"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb634-1"><a href="spatial-data.html#cb634-1"></a><span class="kw">hasValues</span>(r)</span></code></pre></div>
<pre><code>## [1] TRUE</code></pre>
<div class="sourceCode" id="cb636"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb636-1"><a href="spatial-data.html#cb636-1"></a><span class="kw">inMemory</span>(r)</span></code></pre></div>
<pre><code>## [1] FALSE</code></pre>
<div class="sourceCode" id="cb638"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb638-1"><a href="spatial-data.html#cb638-1"></a><span class="kw">plot</span>(r, <span class="dt">main =</span> <span class="st">&quot;Raster layer from file&quot;</span>)</span></code></pre></div>
<p><img src="assfg-book_files/figure-html/unnamed-chunk-272-1.png" width="672" /></p>
<p>Note the raster layer is a rectangle of cells with values. Values that are coded as <code>NA</code> are not plotted.</p>
<div class="sourceCode" id="cb639"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb639-1"><a href="spatial-data.html#cb639-1"></a><span class="kw">head</span>(r)</span></code></pre></div>
<pre><code>##     1  2  3  4  5  6  7  8  9 10 11 12 13 14 15 16 17 18 19 20
## 1  NA NA NA NA NA NA NA NA NA NA NA NA NA NA NA NA NA NA NA NA
## 2  NA NA NA NA NA NA NA NA NA NA NA NA NA NA NA NA NA NA NA NA
## 3  NA NA NA NA NA NA NA NA NA NA NA NA NA NA NA NA NA NA NA NA
## 4  NA NA NA NA NA NA NA NA NA NA NA NA NA NA NA NA NA NA NA NA
## 5  NA NA NA NA NA NA NA NA NA NA NA NA NA NA NA NA NA NA NA NA
## 6  NA NA NA NA NA NA NA NA NA NA NA NA NA NA NA NA NA NA NA NA
## 7  NA NA NA NA NA NA NA NA NA NA NA NA NA NA NA NA NA NA NA NA
## 8  NA NA NA NA NA NA NA NA NA NA NA NA NA NA NA NA NA NA NA NA
## 9  NA NA NA NA NA NA NA NA NA NA NA NA NA NA NA NA NA NA NA NA
## 10 NA NA NA NA NA NA NA NA NA NA NA NA NA NA NA NA NA NA NA NA</code></pre>
<p>We can combine raster layers into stacks and bricks. A stack (and a brick) is a collection of raster layers having the same spatial extent and resolution.</p>
<p>A brick is typically imported from a multi-layer (band) external file. They can also exist entirely in memory. A raster brick can only point to a single external file.</p>
<p>For example, create three rasters and assign random values to the cells.</p>
<div class="sourceCode" id="cb641"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb641-1"><a href="spatial-data.html#cb641-1"></a>r1 &lt;-<span class="st"> </span>r2 &lt;-<span class="st"> </span>r3 &lt;-<span class="st"> </span><span class="kw">raster</span>(<span class="dt">nrow =</span> <span class="dv">10</span>, <span class="dt">ncol =</span> <span class="dv">10</span>)</span>
<span id="cb641-2"><a href="spatial-data.html#cb641-2"></a></span>
<span id="cb641-3"><a href="spatial-data.html#cb641-3"></a><span class="kw">values</span>(r1) &lt;-<span class="st"> </span><span class="kw">runif</span>(<span class="kw">ncell</span>(r1))</span>
<span id="cb641-4"><a href="spatial-data.html#cb641-4"></a><span class="kw">values</span>(r2) &lt;-<span class="st"> </span><span class="kw">runif</span>(<span class="kw">ncell</span>(r2))</span>
<span id="cb641-5"><a href="spatial-data.html#cb641-5"></a><span class="kw">values</span>(r3) &lt;-<span class="st"> </span><span class="kw">runif</span>(<span class="kw">ncell</span>(r3))</span></code></pre></div>
<p>Then combine the rasters into a stack with <code>stack()</code> (or into a brick with <code>brick()</code>).</p>
<div class="sourceCode" id="cb642"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb642-1"><a href="spatial-data.html#cb642-1"></a>s &lt;-<span class="st"> </span><span class="kw">stack</span>(r1, r2, r3)</span>
<span id="cb642-2"><a href="spatial-data.html#cb642-2"></a>s</span></code></pre></div>
<pre><code>## class      : RasterStack 
## dimensions : 10, 10, 100, 3  (nrow, ncol, ncell, nlayers)
## resolution : 36, 18  (x, y)
## extent     : -180, 180, -90, 90  (xmin, xmax, ymin, ymax)
## crs        : +proj=longlat +datum=WGS84 +ellps=WGS84 +towgs84=0,0,0 
## names      :     layer.1,     layer.2,     layer.3 
## min values : 0.007065830, 0.000681580, 0.005370395 
## max values :   0.9983388,   0.9991697,   0.9926319</code></pre>
<div class="sourceCode" id="cb644"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb644-1"><a href="spatial-data.html#cb644-1"></a><span class="kw">nlayers</span>(s)</span></code></pre></div>
<pre><code>## [1] 3</code></pre>
<div class="sourceCode" id="cb646"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb646-1"><a href="spatial-data.html#cb646-1"></a><span class="kw">plot</span>(s)</span></code></pre></div>
<p><img src="assfg-book_files/figure-html/unnamed-chunk-275-1.png" width="672" /></p>
<p>So each attribute in a raster stack (or brick) is a layer.</p>
<p>Here we import a raster brick from a file.</p>
<div class="sourceCode" id="cb647"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb647-1"><a href="spatial-data.html#cb647-1"></a>f &lt;-<span class="st"> </span><span class="kw">system.file</span>(<span class="st">&quot;external/rlogo.grd&quot;</span>, </span>
<span id="cb647-2"><a href="spatial-data.html#cb647-2"></a>                 <span class="dt">package =</span> <span class="st">&quot;raster&quot;</span>)</span>
<span id="cb647-3"><a href="spatial-data.html#cb647-3"></a>b &lt;-<span class="st"> </span><span class="kw">brick</span>(f)</span>
<span id="cb647-4"><a href="spatial-data.html#cb647-4"></a>b</span></code></pre></div>
<pre><code>## class      : RasterBrick 
## dimensions : 77, 101, 7777, 3  (nrow, ncol, ncell, nlayers)
## resolution : 1, 1  (x, y)
## extent     : 0, 101, 0, 77  (xmin, xmax, ymin, ymax)
## crs        : +proj=merc +datum=WGS84 +ellps=WGS84 +towgs84=0,0,0 
## source     : /Library/Frameworks/R.framework/Versions/4.0/Resources/library/raster/external/rlogo.grd 
## names      : red, green, blue 
## min values :   0,     0,    0 
## max values : 255,   255,  255</code></pre>
<div class="sourceCode" id="cb649"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb649-1"><a href="spatial-data.html#cb649-1"></a><span class="kw">plot</span>(b)</span></code></pre></div>
<p><img src="assfg-book_files/figure-html/unnamed-chunk-276-1.png" width="672" /></p>
<p>Suppose we only want a single layer (e.g., one attribute). We extract a raster layer from a brick or stack with the <code>layer =</code> or <code>band =</code> arguments.</p>
<div class="sourceCode" id="cb650"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb650-1"><a href="spatial-data.html#cb650-1"></a>r &lt;-<span class="st"> </span><span class="kw">raster</span>(b, <span class="dt">layer =</span> <span class="dv">2</span>)</span>
<span id="cb650-2"><a href="spatial-data.html#cb650-2"></a><span class="kw">plot</span>(r)</span></code></pre></div>
<p><img src="assfg-book_files/figure-html/unnamed-chunk-277-1.png" width="672" /></p>
</div>
<div id="raster-algebra" class="section level3" number="3.6.4">
<h3><span class="header-section-number">3.6.4</span> Raster algebra</h3>
<p>Most base R functions (<code>+</code>, <code>*</code>, <code>round()</code>, <code>ceiling()</code>, <code>log()</code>, etc) work on raster objects. Operations are done on all cells at once.</p>
<p>Here we place the numbers from 1 to 100 sequentially in the cells, then add 100 to these values and take the square root.</p>
<div class="sourceCode" id="cb651"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb651-1"><a href="spatial-data.html#cb651-1"></a>r &lt;-<span class="st"> </span><span class="kw">raster</span>(<span class="dt">ncol =</span> <span class="dv">10</span>, <span class="dt">nrow =</span> <span class="dv">10</span>)</span>
<span id="cb651-2"><a href="spatial-data.html#cb651-2"></a><span class="kw">values</span>(r) &lt;-<span class="st"> </span><span class="dv">1</span><span class="op">:</span><span class="kw">ncell</span>(r)</span>
<span id="cb651-3"><a href="spatial-data.html#cb651-3"></a></span>
<span id="cb651-4"><a href="spatial-data.html#cb651-4"></a>s &lt;-<span class="st"> </span>r <span class="op">+</span><span class="st"> </span><span class="dv">100</span></span>
<span id="cb651-5"><a href="spatial-data.html#cb651-5"></a>s &lt;-<span class="st"> </span><span class="kw">sqrt</span>(s)</span>
<span id="cb651-6"><a href="spatial-data.html#cb651-6"></a><span class="kw">plot</span>(s)</span></code></pre></div>
<p><img src="assfg-book_files/figure-html/unnamed-chunk-278-1.png" width="672" /></p>
<p>Here we replace the cell values with random uniform numbers between 0 and 1. Then round to the nearest integer and add one.</p>
<div class="sourceCode" id="cb652"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb652-1"><a href="spatial-data.html#cb652-1"></a>r &lt;-<span class="st"> </span><span class="kw">setValues</span>(r, <span class="kw">runif</span>(<span class="kw">ncell</span>(r)))</span>
<span id="cb652-2"><a href="spatial-data.html#cb652-2"></a>r &lt;-<span class="st"> </span><span class="kw">round</span>(r)</span>
<span id="cb652-3"><a href="spatial-data.html#cb652-3"></a>r &lt;-<span class="st"> </span>r <span class="op">+</span><span class="st"> </span><span class="dv">1</span></span>
<span id="cb652-4"><a href="spatial-data.html#cb652-4"></a><span class="kw">plot</span>(r)</span></code></pre></div>
<p><img src="assfg-book_files/figure-html/unnamed-chunk-279-1.png" width="672" /></p>
<p>Replace only certain values with the subset function <code>[]</code>.</p>
<div class="sourceCode" id="cb653"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb653-1"><a href="spatial-data.html#cb653-1"></a>r &lt;-<span class="st"> </span><span class="kw">raster</span>(<span class="dt">xmn =</span> <span class="dv">-90</span>, <span class="dt">xmx =</span> <span class="dv">90</span>, <span class="dt">ymn =</span> <span class="dv">-30</span>, <span class="dt">ymx =</span> <span class="dv">30</span>)</span>
<span id="cb653-2"><a href="spatial-data.html#cb653-2"></a><span class="kw">values</span>(r) &lt;-<span class="st"> </span><span class="kw">rnorm</span>(<span class="kw">ncell</span>(r))</span>
<span id="cb653-3"><a href="spatial-data.html#cb653-3"></a><span class="kw">plot</span>(r)</span></code></pre></div>
<p><img src="assfg-book_files/figure-html/unnamed-chunk-280-1.png" width="672" /></p>
<div class="sourceCode" id="cb654"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb654-1"><a href="spatial-data.html#cb654-1"></a>s &lt;-<span class="st"> </span><span class="kw">raster</span>(<span class="dt">xmn =</span> <span class="dv">-60</span>, <span class="dt">xmx =</span> <span class="dv">60</span>, <span class="dt">ymn =</span> <span class="dv">-10</span>, <span class="dt">ymx =</span> <span class="dv">10</span>)</span>
<span id="cb654-2"><a href="spatial-data.html#cb654-2"></a>r[s] &lt;-<span class="st"> </span><span class="dv">0</span></span>
<span id="cb654-3"><a href="spatial-data.html#cb654-3"></a><span class="kw">plot</span>(r)</span></code></pre></div>
<p><img src="assfg-book_files/figure-html/unnamed-chunk-280-2.png" width="672" /></p>
<div class="sourceCode" id="cb655"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb655-1"><a href="spatial-data.html#cb655-1"></a>r[r <span class="op">&gt;</span><span class="st"> </span><span class="dv">2</span>] &lt;-<span class="st"> </span><span class="dv">0</span></span>
<span id="cb655-2"><a href="spatial-data.html#cb655-2"></a><span class="kw">plot</span>(r)</span></code></pre></div>
<p><img src="assfg-book_files/figure-html/unnamed-chunk-280-3.png" width="672" /></p>
<p>Raster objects with the same resolution and origin can be combined.</p>
<p>Summary functions (<code>min</code>, <code>max</code>, <code>mean</code>, etc) return a raster object. They are useful when we have more than one raster.</p>
<p>Here we create four rasters each with a different set of values from a random normal distribution. We then create a raster containing the average value by cell in rasters one through four. We also create a raster containing the sum of the values by cell in rasters one and two.</p>
<div class="sourceCode" id="cb656"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb656-1"><a href="spatial-data.html#cb656-1"></a>r &lt;-<span class="st"> </span><span class="kw">raster</span>(<span class="dt">ncol =</span> <span class="dv">5</span>, <span class="dt">nrow =</span> <span class="dv">5</span>)</span>
<span id="cb656-2"><a href="spatial-data.html#cb656-2"></a></span>
<span id="cb656-3"><a href="spatial-data.html#cb656-3"></a>r1 &lt;-<span class="st"> </span><span class="kw">setValues</span>(r, <span class="kw">rnorm</span>(<span class="kw">ncell</span>(r)))</span>
<span id="cb656-4"><a href="spatial-data.html#cb656-4"></a>r2 &lt;-<span class="st"> </span><span class="kw">setValues</span>(r, <span class="kw">rnorm</span>(<span class="kw">ncell</span>(r)))</span>
<span id="cb656-5"><a href="spatial-data.html#cb656-5"></a>r3 &lt;-<span class="st"> </span><span class="kw">setValues</span>(r, <span class="kw">rnorm</span>(<span class="kw">ncell</span>(r)))</span>
<span id="cb656-6"><a href="spatial-data.html#cb656-6"></a>r4 &lt;-<span class="st"> </span><span class="kw">setValues</span>(r, <span class="kw">rnorm</span>(<span class="kw">ncell</span>(r)))</span>
<span id="cb656-7"><a href="spatial-data.html#cb656-7"></a></span>
<span id="cb656-8"><a href="spatial-data.html#cb656-8"></a>a &lt;-<span class="st"> </span><span class="kw">mean</span>(r1, r2, r3, r4)</span>
<span id="cb656-9"><a href="spatial-data.html#cb656-9"></a><span class="kw">plot</span>(a)</span></code></pre></div>
<p><img src="assfg-book_files/figure-html/unnamed-chunk-281-1.png" width="672" /></p>
<div class="sourceCode" id="cb657"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb657-1"><a href="spatial-data.html#cb657-1"></a>b &lt;-<span class="st"> </span><span class="kw">sum</span>(r1, r2)</span>
<span id="cb657-2"><a href="spatial-data.html#cb657-2"></a><span class="kw">plot</span>(b)</span></code></pre></div>
<p><img src="assfg-book_files/figure-html/unnamed-chunk-281-2.png" width="672" /></p>
<p>To get summary statistics across all values <em>within</em> a particular raster we use the <code>cellStats()</code> function.</p>
<div class="sourceCode" id="cb658"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb658-1"><a href="spatial-data.html#cb658-1"></a><span class="kw">cellStats</span>(r1, <span class="dt">stat =</span> <span class="st">&#39;mean&#39;</span>)</span></code></pre></div>
<pre><code>## [1] 0.3493077</code></pre>
<div class="sourceCode" id="cb660"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb660-1"><a href="spatial-data.html#cb660-1"></a><span class="kw">cellStats</span>(b, <span class="dt">stat =</span> <span class="st">&#39;sum&#39;</span>)</span></code></pre></div>
<pre><code>## [1] 10.86465</code></pre>
</div>
<div id="example-aggregate-tornado-genesis-locations-to-a-raster-layer-and-then-compute-local-clustering" class="section level3" number="3.6.5">
<h3><span class="header-section-number">3.6.5</span> Example: Aggregate tornado genesis locations to a raster layer and then compute local clustering</h3>
<p>(Re)import the tornado data shapefile as a simple feature data frame with the genesis location as a point geometry. Filter to remove tornadoes occurring in Hawaii, Alaska, and Puerto Rico.</p>
<div class="sourceCode" id="cb662"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb662-1"><a href="spatial-data.html#cb662-1"></a>Alltors &lt;-<span class="st"> </span><span class="kw">st_read</span>(<span class="dt">dsn =</span> <span class="st">&quot;1950-2018-torn-initpoint&quot;</span>) <span class="op">%&gt;%</span></span>
<span id="cb662-2"><a href="spatial-data.html#cb662-2"></a><span class="st">  </span>dplyr<span class="op">::</span><span class="kw">filter</span>(<span class="op">!</span>st <span class="op">%in%</span><span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;HI&quot;</span>, <span class="st">&quot;AK&quot;</span>, <span class="st">&quot;PR&quot;</span>))</span></code></pre></div>
<pre><code>## Reading layer `1950-2018-torn-initpoint&#39; from data source `/Users/jelsner/Desktop/Projects/ASSFG-Book/1950-2018-torn-initpoint&#39; using driver `ESRI Shapefile&#39;
## Simple feature collection with 63645 features and 22 fields
## geometry type:  POINT
## dimension:      XY
## bbox:           xmin: -163.53 ymin: 18.13 xmax: -64.9 ymax: 61.02
## CRS:            4326</code></pre>
<p>Note: here I use the syntax <code>dplyr::filter()</code> since the <strong>dplyr</strong> <code>filter()</code> function is masked by the same named function in the <strong>raster</strong> package.</p>
<p>Create a raster of grid cells across the bounding box. First determining the spatial domain of the set of all tornadoes.</p>
<div class="sourceCode" id="cb664"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb664-1"><a href="spatial-data.html#cb664-1"></a><span class="kw">st_bbox</span>(Alltors)</span></code></pre></div>
<pre><code>##     xmin     ymin     xmax     ymax 
## -124.468   24.550  -67.200   49.330</code></pre>
<p>Next set the raster domain slightly larger than the bounding box and assign a resolution of one degree in longitude and one degree in latitude. Check the extent of the raster with the <code>extent()</code> function.</p>
<div class="sourceCode" id="cb666"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb666-1"><a href="spatial-data.html#cb666-1"></a>r &lt;-<span class="st"> </span><span class="kw">raster</span>(<span class="dt">xmn =</span> <span class="dv">-125</span>, <span class="dt">xmx =</span> <span class="dv">-67</span>, <span class="dt">ymn =</span> <span class="dv">24</span>, <span class="dt">ymx =</span> <span class="dv">50</span>)</span>
<span id="cb666-2"><a href="spatial-data.html#cb666-2"></a><span class="kw">res</span>(r) &lt;-<span class="st"> </span><span class="dv">1</span></span>
<span id="cb666-3"><a href="spatial-data.html#cb666-3"></a></span>
<span id="cb666-4"><a href="spatial-data.html#cb666-4"></a><span class="kw">extent</span>(r)</span></code></pre></div>
<pre><code>## class      : Extent 
## xmin       : -125 
## xmax       : -67 
## ymin       : 24 
## ymax       : 50</code></pre>
<p>Use the <code>rasterize()</code> function to count the number of times each raster cell contains a tornado genesis location. The first argument is the spatial data frame (dough; here a simple feature data frame) and the second is the raster without values (cooking cutter). The argument <code>field =</code> specifies a column name in the spatial data frame (here just an identifier) and the argument <code>fun =</code> specifies what to do (here simply count the unique instances of the field in each cell).</p>
<div class="sourceCode" id="cb668"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb668-1"><a href="spatial-data.html#cb668-1"></a>Tor_r &lt;-<span class="st"> </span><span class="kw">rasterize</span>(Alltors, r, </span>
<span id="cb668-2"><a href="spatial-data.html#cb668-2"></a>                   <span class="dt">field =</span> <span class="st">&quot;om&quot;</span>, </span>
<span id="cb668-3"><a href="spatial-data.html#cb668-3"></a>                   <span class="dt">fun =</span> <span class="st">&quot;count&quot;</span>)</span>
<span id="cb668-4"><a href="spatial-data.html#cb668-4"></a></span>
<span id="cb668-5"><a href="spatial-data.html#cb668-5"></a><span class="kw">class</span>(Tor_r)</span></code></pre></div>
<pre><code>## [1] &quot;RasterLayer&quot;
## attr(,&quot;package&quot;)
## [1] &quot;raster&quot;</code></pre>
<div class="sourceCode" id="cb670"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb670-1"><a href="spatial-data.html#cb670-1"></a><span class="kw">dim</span>(Tor_r)</span></code></pre></div>
<pre><code>## [1] 26 58  1</code></pre>
<p>The result is a raster layer. The number of tornadoes occurring in each cell are the values.</p>
<div class="sourceCode" id="cb672"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb672-1"><a href="spatial-data.html#cb672-1"></a><span class="kw">values</span>(Tor_r)[<span class="dv">1</span><span class="op">:</span><span class="dv">200</span>]</span></code></pre></div>
<pre><code>##   [1]  NA  NA  NA  NA  NA  NA  NA  NA  NA  NA  NA  NA  NA  NA  NA  NA  NA  NA
##  [19]  NA  NA  NA  NA   2   1  NA  NA  NA  NA  NA   1   1  NA  NA  NA  NA  NA
##  [37]  NA  NA  NA  NA  NA  NA  NA  NA  NA  NA  NA  NA  NA  NA  NA  NA  NA  NA
##  [55]  NA  NA  NA  NA  NA  NA   5  NA  NA   3   6   3   4  NA   2  NA   4   8
##  [73]   8   7   4   9  25  23  17  30  55  76  37  80  83 120  66  29  14   7
##  [91]   3   2  NA  NA  NA  NA  NA  NA  NA  NA  NA  NA  NA  NA  NA  NA  NA  NA
## [109]  NA  NA  NA  NA  NA  NA  NA  NA  NA  NA  16   2   2   5  11  16   2   1
## [127]   5   1   2  17  18  22   7  10  11  11  22  20  43  59  66  64  99 146
## [145] 105  71  39  14  16  10   2  NA   2  NA  NA  NA  NA  NA  NA  NA  NA  NA
## [163]  NA  NA  NA  NA  NA  NA  NA  NA  NA  NA   8  NA   1   6  12  NA   8   6
## [181]   6   3   9   1   4   1   7   4  10  12  10   5  11   7  25  33  46  67
## [199]  76  52</code></pre>
<p>Raster cells without tornadoes are given a value of <code>NA</code> the integers are the number of times the cell contained a tornado.</p>
<p>We make a quick map with the <code>plot()</code> method.</p>
<div class="sourceCode" id="cb674"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb674-1"><a href="spatial-data.html#cb674-1"></a><span class="kw">plot</span>(Tor_r)</span></code></pre></div>
<p><img src="assfg-book_files/figure-html/unnamed-chunk-288-1.png" width="672" /></p>
<p>It looks right. Some cells across the Plains and the South have quite a few tornadoes others not as many.</p>
<p>A spatial statistic indicating how similar values in neighboring cells tend to be is Moran’s I. It is implemented on rasters with the <code>Moran()</code> function.</p>
<p>First we convert the <code>NA</code> values to zero since they do not really represent missing information but rather no tornadoes. We do this by including a <code>background =</code> argument specifying a value of 0.</p>
<div class="sourceCode" id="cb675"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb675-1"><a href="spatial-data.html#cb675-1"></a>Tor_r &lt;-<span class="st"> </span><span class="kw">rasterize</span>(Alltors, r, </span>
<span id="cb675-2"><a href="spatial-data.html#cb675-2"></a>                   <span class="dt">field =</span> <span class="st">&quot;om&quot;</span>, </span>
<span id="cb675-3"><a href="spatial-data.html#cb675-3"></a>                   <span class="dt">fun =</span> <span class="st">&quot;count&quot;</span>,</span>
<span id="cb675-4"><a href="spatial-data.html#cb675-4"></a>                   <span class="dt">background =</span> <span class="dv">0</span>)</span></code></pre></div>
<div class="sourceCode" id="cb676"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb676-1"><a href="spatial-data.html#cb676-1"></a><span class="kw">Moran</span>(Tor_r)</span></code></pre></div>
<pre><code>## [1] 0.8241374</code></pre>
<p>Moran’s I is a global measure of clustering (high values near high values and low values near low values). Values range from -1 to +1 where positive values indicate clustering and negative values indicate regularity (e.g., chessboard).</p>
<p>The estimate of .82 indicates a high level of tornado clustering at this scale. Under the null hypothesis of no spatial autocorrelation the expected value for Moran’s I is close to zero [-1/(n-1), where n is the number of cells].</p>
<p>With raster data the neighborhood definition is constant across the study region.</p>
<p>Clusters at a local level can be found using a local indicator of spatial autocorrelation. One such indicator is local Moran’s I, which is computed at each cell (using the <code>MoranLocal()</code> function) so the result is a raster.</p>
<div class="sourceCode" id="cb678"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb678-1"><a href="spatial-data.html#cb678-1"></a>Tor_r.lmi &lt;-<span class="st"> </span><span class="kw">MoranLocal</span>(Tor_r)</span>
<span id="cb678-2"><a href="spatial-data.html#cb678-2"></a></span>
<span id="cb678-3"><a href="spatial-data.html#cb678-3"></a><span class="kw">plot</span>(Tor_r.lmi)</span></code></pre></div>
<p><img src="assfg-book_files/figure-html/unnamed-chunk-291-1.png" width="672" /></p>
<p>Here we can more clearly delineate the hot spots of tornadoes over the south-central Plains.</p>
</div>
<div id="problem-set-2" class="section level3" number="3.6.6">
<h3><span class="header-section-number">3.6.6</span> Problem Set #2</h3>
<ol style="list-style-type: decimal">
<li><p>What tornado (by date and EF rating [<code>mag</code>]) in the historical record has a genesis location closest to the geographic center of Wisconsin? Hint: Use the <code>which.min()</code> function on the vector of distances to identify the row number in the tornado data frame (50).</p></li>
<li><p>Determine Moran’s I and plot local Moran’s I for the occurrence of tornadoes across Kansas aggregated to a .2 degree latitude/longitude raster bounded by -102.1 and -94.5 degrees east longitude and 36.9 to 40.1 degrees north latitude (50).</p></li>
</ol>
</div>
<div id="geocomputation-functions-on-rasters" class="section level3" number="3.6.7">
<h3><span class="header-section-number">3.6.7</span> Geocomputation functions on rasters</h3>
<p>The <code>crop()</code> function takes a geographic subset of a larger raster object. A raster is cropped by providing an extent object or other spatial object from which an extent can be extracted (objects from classes deriving from raster and from spatial in the <strong>sp</strong> package).</p>
<p>The function <code>drawExtent()</code> is used to visually see the new extent (bounding box) that is given to the <code>crop()</code> function.</p>
<p>The <code>trim()</code> function crops a raster layer by removing the outer rows and columns that only contain <code>NA</code> values. The <code>extend()</code> function adds new rows and/or columns with <code>NA</code> values.</p>
<p>The <code>extract()</code> function retrieves values from a raster object at the locations of other spatial data.</p>
<p>The <code>merge()</code> function combines two or more objects into a single object. The input objects must have the same resolution and origin (such that their cells fit into a single larger raster). If this is not the case, first adjust one of the objects with the functions <code>aggregate()</code> or <code>resample()</code>.</p>
<p>The <code>aggregate()</code> and <code>disaggregate()</code> functions change the resolution (cell size) of a raster object.</p>
<div class="sourceCode" id="cb679"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb679-1"><a href="spatial-data.html#cb679-1"></a>r &lt;-<span class="st"> </span><span class="kw">raster</span>()</span>
<span id="cb679-2"><a href="spatial-data.html#cb679-2"></a>r[] &lt;-<span class="st"> </span><span class="dv">1</span><span class="op">:</span><span class="kw">ncell</span>(r)</span>
<span id="cb679-3"><a href="spatial-data.html#cb679-3"></a>ra &lt;-<span class="st"> </span><span class="kw">aggregate</span>(r, <span class="dv">10</span>)</span></code></pre></div>
<p>Here we crop the raster into two pieces and then merge them into one with the <code>merge()</code> function. The function has an argument that allows us to export to <code>test.grd</code>.</p>
<div class="sourceCode" id="cb680"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb680-1"><a href="spatial-data.html#cb680-1"></a>r1 &lt;-<span class="st"> </span><span class="kw">crop</span>(r, <span class="kw">extent</span>(<span class="op">-</span><span class="dv">180</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">30</span>)) </span>
<span id="cb680-2"><a href="spatial-data.html#cb680-2"></a>r2 &lt;-<span class="st"> </span><span class="kw">crop</span>(r, <span class="kw">extent</span>(<span class="op">-</span><span class="dv">10</span>, <span class="dv">180</span>, <span class="dv">-20</span>, <span class="dv">10</span>))</span>
<span id="cb680-3"><a href="spatial-data.html#cb680-3"></a>m &lt;-<span class="st"> </span><span class="kw">merge</span>(r1, r2, </span>
<span id="cb680-4"><a href="spatial-data.html#cb680-4"></a>           <span class="dt">filename =</span> <span class="st">&#39;test.grd&#39;</span>, </span>
<span id="cb680-5"><a href="spatial-data.html#cb680-5"></a>           <span class="dt">overwrite =</span> <span class="ot">TRUE</span>)</span>
<span id="cb680-6"><a href="spatial-data.html#cb680-6"></a><span class="kw">plot</span>(m)</span></code></pre></div>
<p><img src="assfg-book_files/figure-html/unnamed-chunk-293-1.png" width="672" /></p>
<p>Other formats for saving the raster (e.g., <code>geoTIFF</code>) are available (see <code>writeRaster()</code> for more options).</p>
<p>The <code>flip()</code> function flips the data (reverse order) in the horizontal or vertical direction—typically to correct for a ‘communication problem’ between different R packages or a misinterpreted file. The <code>rotate()</code> function rotates longitude/latitude rasters that have longitudes from 0 to 360 degrees (often used by climatologists) to the standard -180 to 180 degrees system. With the <code>t()</code> function you can rotate a raster object 90 degrees.</p>
</div>
<div id="vector-to-raster-conversion" class="section level3" number="3.6.8">
<h3><span class="header-section-number">3.6.8</span> Vector to raster conversion</h3>
<p>Point-to-raster conversion is often done to analyze point-pattern data. For example to count the number of distinct species (represented by point observations) that occur in each raster cell. The <code>rasterize()</code> function takes a raster object to set the spatial extent and resolution, and a function to determine how to summarize the points (or an attribute of each point) by cell.</p>
<p>Polygon to raster conversion is typically done to create a <code>RasterLayer</code> that can act as a mask, i.e. to set to <code>NA</code> a set of cells of a raster object, or to summarize values on a raster by zone. For example a country polygon is transferred to a raster that is then used to set all the cells outside that country to <code>NA</code>; whereas polygons representing administrative regions such as states can be transferred to a raster to summarize raster values by region.</p>
<p>It is also possible to convert the values of a raster layer to points or polygons, using <code>rasterToPoints()</code> and <code>rasterToPolygons()</code>. These functions return values only for cells that are not missing (<code>NA</code>).</p>
</div>
<div id="focal-neighborhood-functions" class="section level3" number="3.6.9">
<h3><span class="header-section-number">3.6.9</span> Focal (neighborhood) functions</h3>
<p>The functions: <code>focal()</code>, <code>focalFilter()</code>, <code>focalNA()</code> compute statistics in a neighborhood of cells around a focal cell, putting the result in the focal cell of an output raster.</p>
<p>With <code>focal()</code>, the neighborhood can only be a rectangle. With <code>focalFilter()</code>, the neighborhood is a user-defined a matrix of weights and could approximate any shape by giving some cells zero weight. The <code>focalNA()</code> function only computes new values for cells that are <code>NA</code> in the input raster.</p>
<p>The <code>distance()</code> function computes the shortest distance to cells that are not NA. The <code>pointDistance()</code> function computes the shortest distance to any point in a set of points.</p>
<p>The <code>gridDistance()</code> function computes the distance when following grid cells that can be traversed (e.g. excluding water bodies). The <code>direction()</code> function computes the direction towards (or from) the nearest cell that is not <code>NA</code>. The <code>adjacency()</code> function determines which cells are adjacent to other cells, and the <code>pointDistance()</code> function computes distance between points.</p>
</div>
<div id="summary-functions" class="section level3" number="3.6.10">
<h3><span class="header-section-number">3.6.10</span> Summary functions</h3>
<p>The function <code>cellStats()</code> computes summary statistics on a raster. For example:</p>
<div class="sourceCode" id="cb681"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb681-1"><a href="spatial-data.html#cb681-1"></a><span class="kw">cellStats</span>(Tor_r, mean)</span></code></pre></div>
<pre><code>## [1] 42.15782</code></pre>
<div class="sourceCode" id="cb683"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb683-1"><a href="spatial-data.html#cb683-1"></a><span class="kw">cellStats</span>(Tor_r, max)</span></code></pre></div>
<pre><code>## [1] 439</code></pre>
<div class="sourceCode" id="cb685"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb685-1"><a href="spatial-data.html#cb685-1"></a><span class="kw">freq</span>(Tor_r)</span></code></pre></div>
<pre><code>##        value count
##   [1,]     0   642
##   [2,]     1    48
##   [3,]     2    41
##   [4,]     3    30
##   [5,]     4    28
##   [6,]     5    25
##   [7,]     6    19
##   [8,]     7    20
##   [9,]     8    15
##  [10,]     9    14
##  [11,]    10    17
##  [12,]    11    12
##  [13,]    12     9
##  [14,]    13     8
##  [15,]    14     8
##  [16,]    15     8
##  [17,]    16     9
##  [18,]    17     8
##  [19,]    18     8
##  [20,]    19     5
##  [21,]    20     6
##  [22,]    21     6
##  [23,]    22     5
##  [24,]    23     7
##  [25,]    24     1
##  [26,]    25     3
##  [27,]    26     1
##  [28,]    27     4
##  [29,]    28     3
##  [30,]    29     7
##  [31,]    30     8
##  [32,]    31     5
##  [33,]    32     6
##  [34,]    33     5
##  [35,]    34     5
##  [36,]    35     5
##  [37,]    36     4
##  [38,]    37     2
##  [39,]    38     3
##  [40,]    39     7
##  [41,]    40     5
##  [42,]    41     4
##  [43,]    42     2
##  [44,]    43     5
##  [45,]    44     3
##  [46,]    45     2
##  [47,]    46     3
##  [48,]    47     1
##  [49,]    48     3
##  [50,]    49     1
##  [51,]    50     2
##  [52,]    51     2
##  [53,]    52     3
##  [54,]    53     1
##  [55,]    54     2
##  [56,]    55     3
##  [57,]    56     2
##  [58,]    57     3
##  [59,]    59     4
##  [60,]    60     2
##  [61,]    61     3
##  [62,]    62     4
##  [63,]    64     1
##  [64,]    65     1
##  [65,]    66     3
##  [66,]    67     3
##  [67,]    68     1
##  [68,]    69     1
##  [69,]    70     1
##  [70,]    71     7
##  [71,]    72     5
##  [72,]    73     2
##  [73,]    74     2
##  [74,]    75     1
##  [75,]    76     7
##  [76,]    77     2
##  [77,]    78     1
##  [78,]    79     1
##  [79,]    80     8
##  [80,]    82     2
##  [81,]    83     1
##  [82,]    84     2
##  [83,]    85     3
##  [84,]    86     4
##  [85,]    87     4
##  [86,]    88     3
##  [87,]    89     2
##  [88,]    90     2
##  [89,]    91     1
##  [90,]    92     2
##  [91,]    93     1
##  [92,]    95     2
##  [93,]    96     1
##  [94,]    97     5
##  [95,]    98     2
##  [96,]    99     3
##  [97,]   100     1
##  [98,]   102     6
##  [99,]   103     4
## [100,]   104     4
## [101,]   105     6
## [102,]   106     4
## [103,]   107     1
## [104,]   108     3
## [105,]   109     1
## [106,]   110     2
## [107,]   111     2
## [108,]   112     2
## [109,]   113     3
## [110,]   114     3
## [111,]   115     4
## [112,]   116     2
## [113,]   117     2
## [114,]   118     3
## [115,]   119     3
## [116,]   120     8
## [117,]   121     1
## [118,]   122     3
## [119,]   123     1
## [120,]   124     2
## [121,]   125     3
## [122,]   126     4
## [123,]   127     1
## [124,]   128     1
## [125,]   129     3
## [126,]   130     2
## [127,]   131     1
## [128,]   133     2
## [129,]   134     6
## [130,]   135     2
## [131,]   136     1
## [132,]   137     4
## [133,]   138     1
## [134,]   139     2
## [135,]   140     7
## [136,]   141     4
## [137,]   142     4
## [138,]   143     7
## [139,]   144     3
## [140,]   145     2
## [141,]   146     1
## [142,]   148     3
## [143,]   149     1
## [144,]   150     4
## [145,]   151     2
## [146,]   152     3
## [147,]   153     3
## [148,]   154     4
## [149,]   155     2
## [150,]   156     1
## [151,]   157     3
## [152,]   160     4
## [153,]   161     3
## [154,]   162     5
## [155,]   163     2
## [156,]   165     4
## [157,]   167     4
## [158,]   168     1
## [159,]   169     4
## [160,]   170     3
## [161,]   171     5
## [162,]   172     3
## [163,]   174     3
## [164,]   175     1
## [165,]   176     1
## [166,]   177     3
## [167,]   178     5
## [168,]   179     4
## [169,]   183     1
## [170,]   186     2
## [171,]   187     1
## [172,]   188     5
## [173,]   189     3
## [174,]   190     1
## [175,]   193     2
## [176,]   195     1
## [177,]   196     1
## [178,]   200     2
## [179,]   201     4
## [180,]   204     1
## [181,]   205     1
## [182,]   208     2
## [183,]   210     2
## [184,]   211     1
## [185,]   212     5
## [186,]   215     1
## [187,]   216     2
## [188,]   217     1
## [189,]   218     1
## [190,]   220     1
## [191,]   221     1
## [192,]   223     1
## [193,]   224     2
## [194,]   225     1
## [195,]   231     1
## [196,]   232     2
## [197,]   236     1
## [198,]   237     1
## [199,]   239     2
## [200,]   240     2
## [201,]   241     1
## [202,]   243     1
## [203,]   246     1
## [204,]   250     1
## [205,]   251     1
## [206,]   252     1
## [207,]   255     1
## [208,]   257     1
## [209,]   261     1
## [210,]   264     1
## [211,]   265     2
## [212,]   270     1
## [213,]   271     1
## [214,]   277     1
## [215,]   278     2
## [216,]   282     1
## [217,]   288     1
## [218,]   293     1
## [219,]   300     1
## [220,]   324     1
## [221,]   381     1
## [222,]   384     1
## [223,]   386     1
## [224,]   439     1</code></pre>
<p>Use <code>zonal()</code> to summarize a raster object using zones (areas with the same integer number) defined in a <code>RasterLayer</code> and <code>crosstab()</code> to cross-tabulate two <code>RasterLayer</code> objects.</p>
</div>
<div id="convert-a-raster-to-a-spatial-vector-object" class="section level3" number="3.6.11">
<h3><span class="header-section-number">3.6.11</span> Convert a raster to a spatial vector object</h3>
<p>Convert <code>raster</code> to polygons.</p>
<div class="sourceCode" id="cb687"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb687-1"><a href="spatial-data.html#cb687-1"></a>spdf &lt;-<span class="st"> </span><span class="kw">rasterToPolygons</span>(Tor_r)</span></code></pre></div>
<p>Convert the <code>SpatialPolygonsDataFrame</code> to a simple features data frame.</p>
<div class="sourceCode" id="cb688"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb688-1"><a href="spatial-data.html#cb688-1"></a>sfdf &lt;-<span class="st"> </span><span class="kw">st_as_sf</span>(spdf)</span></code></pre></div>
</div>
<div id="example-environmental-data-related-to-tornadoes" class="section level3" number="3.6.12">
<h3><span class="header-section-number">3.6.12</span> Example: Environmental data related to tornadoes</h3>
<p>An example of a raster containing environmental data relative to our work on understanding tornadoes is available in the file <code>test1.grb</code>. The data are variables describing the 3-D atmosphere at a given time across North America. Download the data.</p>
<p>Each variable is a raster layer. Load the file as a raster brick.</p>
<div class="sourceCode" id="cb689"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb689-1"><a href="spatial-data.html#cb689-1"></a><span class="kw">library</span>(raster)</span>
<span id="cb689-2"><a href="spatial-data.html#cb689-2"></a>rb &lt;-<span class="st"> </span><span class="kw">brick</span>(<span class="st">&#39;test1.grb&#39;</span>)</span>
<span id="cb689-3"><a href="spatial-data.html#cb689-3"></a>rb</span></code></pre></div>
<pre><code>## class      : RasterBrick 
## dimensions : 277, 349, 96673, 423  (nrow, ncol, ncell, nlayers)
## resolution : 32463, 32463  (x, y)
## extent     : -5648874, 5680713, -4628777, 4363474  (xmin, xmax, ymin, ymax)
## crs        : +proj=lcc +lat_1=50 +lat_2=50 +lat_0=50 +lon_0=-107 +x_0=0 +y_0=0 +a=6371200 +b=6371200 +units=m +no_defs 
## source     : /Users/jelsner/Desktop/Projects/ASSFG-Book/test1.grb 
## names      : test1.1, test1.2, test1.3, test1.4, test1.5, test1.6, test1.7, test1.8, test1.9, test1.10, test1.11, test1.12, test1.13, test1.14, test1.15, ...</code></pre>
<p>There are 423 variables ranging from sea-level pressure to storm relative helicity. The names of the variables are given as <code>test1.</code> followed by an integer from 1 to 423 indicating the raster layers. The CRS is Lambert conic conformal.</p>
<p>Each cell has a dimension of 32.463 km north to south and 32.463 km east to west.</p>
<p>Extract only the layer corresponding to available energy (layer 315). Determine the spatial extent.</p>
<div class="sourceCode" id="cb691"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb691-1"><a href="spatial-data.html#cb691-1"></a>cape &lt;-<span class="st"> </span><span class="kw">raster</span>(rb, <span class="dt">layer =</span> <span class="dv">315</span>)</span>
<span id="cb691-2"><a href="spatial-data.html#cb691-2"></a><span class="kw">extent</span>(cape)</span></code></pre></div>
<pre><code>## class      : Extent 
## xmin       : -5648874 
## xmax       : 5680713 
## ymin       : -4628777 
## ymax       : 4363474</code></pre>
<p>Determine the highest amount of energy.</p>
<div class="sourceCode" id="cb693"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb693-1"><a href="spatial-data.html#cb693-1"></a><span class="kw">cellStats</span>(cape, <span class="st">&quot;max&quot;</span>)</span></code></pre></div>
<pre><code>## [1] 4780</code></pre>
<div class="sourceCode" id="cb695"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb695-1"><a href="spatial-data.html#cb695-1"></a><span class="kw">cellStats</span>(cape, <span class="st">&quot;mean&quot;</span>)</span></code></pre></div>
<pre><code>## [1] 372.0034</code></pre>
<p>The most energetic (in terms of convective available potential) grid cell has 4,780 Joules/kg of energy (mass specific). Physically, CAPE is how much energy a parcel of air would have if lifted above the ground. Effectively it is the positive buoyancy of an air parcel and indicates how unstable the atmosphere is, making it valuable in forecasting severe weather and tornadoes.</p>
<p>Most cells have much lower energy. This is seen by computing the skewness of the values.</p>
<div class="sourceCode" id="cb697"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb697-1"><a href="spatial-data.html#cb697-1"></a><span class="kw">cellStats</span>(cape, <span class="st">&quot;skew&quot;</span>)</span></code></pre></div>
<pre><code>## [1] 2.212272</code></pre>
<p>A value of zero skewness indicates a normal distribution. The skewness is visualized by plotting a histogram of the values.</p>
<div class="sourceCode" id="cb699"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb699-1"><a href="spatial-data.html#cb699-1"></a><span class="kw">hist</span>(cape)</span></code></pre></div>
<p><img src="assfg-book_files/figure-html/unnamed-chunk-301-1.png" width="672" /></p>
<div class="sourceCode" id="cb700"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb700-1"><a href="spatial-data.html#cb700-1"></a><span class="kw">quantile</span>(cape)</span></code></pre></div>
<pre><code>##   0%  25%  50%  75% 100% 
##    0    0   30  230 4780</code></pre>
<p>Only 25% of the cells have cape exceeding 230 J/kg.</p>
<p>Convert the raster to a data frame</p>
<div class="sourceCode" id="cb702"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb702-1"><a href="spatial-data.html#cb702-1"></a>df &lt;-<span class="st"> </span><span class="kw">as.data.frame</span>(cape)</span>
<span id="cb702-2"><a href="spatial-data.html#cb702-2"></a><span class="kw">head</span>(df)</span></code></pre></div>
<pre><code>##   test1.315
## 1        NA
## 2        NA
## 3        NA
## 4        NA
## 5        NA
## 6        NA</code></pre>
<p>Extract raster values over Florida</p>
<div class="sourceCode" id="cb704"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb704-1"><a href="spatial-data.html#cb704-1"></a>FL &lt;-<span class="st"> </span><span class="kw">us_states</span>(<span class="dt">states =</span> <span class="st">&quot;Florida&quot;</span>)</span>
<span id="cb704-2"><a href="spatial-data.html#cb704-2"></a><span class="kw">plot</span>(FL<span class="op">$</span>geometry)</span></code></pre></div>
<p><img src="assfg-book_files/figure-html/unnamed-chunk-303-1.png" width="672" /></p>
<p>Transform the CRS to that of the raster. Then use the <code>extract()</code> function to obtain the cell values within the Florida polygon. The function retrieves values from a raster object at the locations of other spatial data.</p>
<div class="sourceCode" id="cb705"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb705-1"><a href="spatial-data.html#cb705-1"></a>FL &lt;-<span class="st"> </span><span class="kw">st_transform</span>(FL, <span class="dt">crs =</span> <span class="kw">proj4string</span>(cape))</span>
<span id="cb705-2"><a href="spatial-data.html#cb705-2"></a>capeFL &lt;-<span class="st"> </span><span class="kw">unlist</span>(<span class="kw">extract</span>(cape, FL))</span>
<span id="cb705-3"><a href="spatial-data.html#cb705-3"></a><span class="kw">mean</span>(capeFL)</span></code></pre></div>
<pre><code>## [1] 2454.211</code></pre>
<div class="sourceCode" id="cb707"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb707-1"><a href="spatial-data.html#cb707-1"></a><span class="kw">hist</span>(capeFL)</span></code></pre></div>
<p><img src="assfg-book_files/figure-html/unnamed-chunk-304-1.png" width="672" /></p>
<p>Create a new raster <code>hicape</code> with cells equal to <code>TRUE</code> for those exceeding the mean FL value. How many cells is that?</p>
<div class="sourceCode" id="cb708"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb708-1"><a href="spatial-data.html#cb708-1"></a>hicape &lt;-<span class="st"> </span>cape <span class="op">&gt;</span><span class="st"> </span><span class="kw">mean</span>(capeFL)</span>
<span id="cb708-2"><a href="spatial-data.html#cb708-2"></a><span class="kw">length</span>(cape[cape <span class="op">&gt;</span><span class="st"> </span><span class="kw">mean</span>(capeFL)])</span></code></pre></div>
<pre><code>## [1] 3412</code></pre>

</div>
</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="grammars-for-data-and-graphs.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="making-maps.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": null,
"text": null
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": ["assfg-book.pdf", "assfg-book.epub"],
"toc": {
"collapse": "subsection"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
